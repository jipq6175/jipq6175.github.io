<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Inference-Time Scaling for Diffusion/Flow Models | Yen-Lin Chen</title> <meta name="author" content="Yen-Lin Chen"> <meta name="description" content="Inference time scaling for diffusion models, from search to steering"> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://jipq6175.github.io/blog/2025/inference_time_scaling/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js"></script> <script src="/assets/js/dark_mode.js"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Yen-Lin </span>Chen</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">About</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">Blogs<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">Publications</a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">CV</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">Inference-Time Scaling for Diffusion/Flow Models</h1> <p class="post-meta">June 14, 2025</p> <p class="post-tags"> <a href="/blog/2025"> <i class="fas fa-calendar fa-sm"></i> 2025 </a>   ·   <a href="/blog/tag/reading"> <i class="fas fa-hashtag fa-sm"></i> reading</a>   <a href="/blog/tag/generating"> <i class="fas fa-hashtag fa-sm"></i> generating</a>   <a href="/blog/tag/coding"> <i class="fas fa-hashtag fa-sm"></i> coding</a>     ·   <a href="/blog/category/models"> <i class="fas fa-tag fa-sm"></i> models</a>   </p> </header> <article class="post-content"> <h1 id="inference-time-scaling-for-diffusion-models-from-simple-search-to-feynman-kac-steering">Inference-Time Scaling for Diffusion Models: From Simple Search to Feynman-Kac Steering</h1> <h2 id="introduction">Introduction</h2> <p>Diffusion models have revolutionized generative AI, producing impressive results across various domains. However, generating samples with specific desired properties remains challenging. While training-based approaches exist, they require expensive fine-tuning and tie models to specific reward functions. This blog post explores <strong>inference-time scaling</strong> techniques that can steer diffusion models toward desired outputs without any additional training.</p> <p>We’ll walk through three increasingly sophisticated approaches:</p> <ol> <li> <strong>Zeroth-order search</strong> - searching in the noise space</li> <li> <strong>Search over paths</strong> - searching during the denoising process</li> <li> <strong>Feynman-Kac steering</strong> - a particle-based approach using stochastic dynamics</li> </ol> <p>This implementation demonstrates these concepts on a 2D toy problem, but the same principles apply to the large-scale experiments in “A General Framework for Inference-time Scaling and Steering of Diffusion Models” by Singhal et al., where they show that these methods enable smaller models to outperform larger ones on real tasks like text-to-image generation.</p> <h2 id="setup-imports-and-utility-functions">Setup: Imports and Utility Functions</h2> <p>Let’s start by importing necessary libraries and defining utility functions:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># imports and util functions
</span><span class="kn">import</span> <span class="n">torch</span> 
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="n">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="n">torch</span> <span class="kn">import</span> <span class="n">nn</span><span class="p">,</span> <span class="n">Tensor</span>
<span class="kn">from</span> <span class="n">sklearn.datasets</span> <span class="kn">import</span> <span class="n">make_moons</span>

<span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">device</span><span class="p">(</span><span class="sh">'</span><span class="s">cuda</span><span class="sh">'</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">generate_checkerboard_2d</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">square_size</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">high_prob</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">low_prob</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> 
                            <span class="n">x_range</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">y_range</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">max_attempts</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Generate 2D data points from a checkerboard distribution.
    </span><span class="sh">"""</span>
    <span class="k">if</span> <span class="n">max_attempts</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="n">max_attempts</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">n_samples</span>
    
    <span class="c1"># Normalize probabilities
</span>    <span class="n">max_prob</span> <span class="o">=</span> <span class="nf">max</span><span class="p">(</span><span class="n">high_prob</span><span class="p">,</span> <span class="n">low_prob</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">checkerboard_density</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">Calculate the probability density at point (x, y)</span><span class="sh">"""</span>
        <span class="c1"># Determine which square we're in
</span>        <span class="n">square_x</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">floor</span><span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="n">square_size</span><span class="p">).</span><span class="nf">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">square_y</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">floor</span><span class="p">(</span><span class="n">y</span> <span class="o">/</span> <span class="n">square_size</span><span class="p">).</span><span class="nf">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        
        <span class="c1"># Checkerboard pattern: alternating high/low probability
</span>        <span class="n">is_white_square</span> <span class="o">=</span> <span class="p">(</span><span class="n">square_x</span> <span class="o">+</span> <span class="n">square_y</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span>
        
        <span class="k">return</span> <span class="n">np</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="n">is_white_square</span><span class="p">,</span> <span class="n">high_prob</span><span class="p">,</span> <span class="n">low_prob</span><span class="p">)</span>
    
    <span class="n">points</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">attempts</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">while</span> <span class="nf">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">n_samples</span> <span class="ow">and</span> <span class="n">attempts</span> <span class="o">&lt;</span> <span class="n">max_attempts</span><span class="p">:</span>
        <span class="c1"># Generate random candidate points
</span>        <span class="n">batch_size</span> <span class="o">=</span> <span class="nf">min</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="n">max_attempts</span> <span class="o">-</span> <span class="n">attempts</span><span class="p">)</span>
        <span class="n">x_candidates</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">uniform</span><span class="p">(</span><span class="n">x_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">batch_size</span><span class="p">)</span>
        <span class="n">y_candidates</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">uniform</span><span class="p">(</span><span class="n">y_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">batch_size</span><span class="p">)</span>
        
        <span class="c1"># Calculate densities
</span>        <span class="n">densities</span> <span class="o">=</span> <span class="nf">checkerboard_density</span><span class="p">(</span><span class="n">x_candidates</span><span class="p">,</span> <span class="n">y_candidates</span><span class="p">)</span>
        
        <span class="c1"># Rejection sampling
</span>        <span class="n">accept_probs</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_prob</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">)</span>
        <span class="n">accepted</span> <span class="o">=</span> <span class="n">accept_probs</span> <span class="o">&lt;</span> <span class="n">densities</span>
        
        <span class="c1"># Add accepted points
</span>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="p">.</span><span class="nf">where</span><span class="p">(</span><span class="n">accepted</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">n_samples</span><span class="p">:</span>
                <span class="n">points</span><span class="p">.</span><span class="nf">append</span><span class="p">([</span><span class="n">x_candidates</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">y_candidates</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
        
        <span class="n">attempts</span> <span class="o">+=</span> <span class="n">batch_size</span>
    
    <span class="k">return</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>
</code></pre></div></div> <h2 id="flow-model-architecture">Flow Model Architecture</h2> <p>We’ll use a simple MLP-based flow model:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Flow</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="sh">'''</span><span class="s">Simple MLP flow model</span><span class="sh">'''</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">dim</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="n">h</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">64</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">net</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="p">.</span><span class="nc">Linear</span><span class="p">(</span><span class="n">dim</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">h</span><span class="p">),</span> <span class="n">nn</span><span class="p">.</span><span class="nc">ELU</span><span class="p">(),</span>
            <span class="n">nn</span><span class="p">.</span><span class="nc">Linear</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">h</span><span class="p">),</span> <span class="n">nn</span><span class="p">.</span><span class="nc">ELU</span><span class="p">(),</span>
            <span class="n">nn</span><span class="p">.</span><span class="nc">Linear</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">h</span><span class="p">),</span> <span class="n">nn</span><span class="p">.</span><span class="nc">ELU</span><span class="p">(),</span>
            <span class="n">nn</span><span class="p">.</span><span class="nc">Linear</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">dim</span><span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">x_t</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">net</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="nf">cat</span><span class="p">((</span><span class="n">t</span><span class="p">,</span> <span class="n">x_t</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">step</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">x_t</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">t_start</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">,</span> <span class="n">t_end</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
        <span class="sh">'''</span><span class="s">Using midpoint Euler method</span><span class="sh">'''</span>
        <span class="n">t_start</span> <span class="o">=</span> <span class="n">t_start</span><span class="p">.</span><span class="nf">view</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span><span class="nf">expand</span><span class="p">(</span><span class="n">x_t</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x_t</span> <span class="o">+</span> <span class="p">(</span><span class="n">t_end</span> <span class="o">-</span> <span class="n">t_start</span><span class="p">)</span> <span class="o">*</span> <span class="nf">self</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="n">t_start</span> <span class="o">+</span> <span class="p">(</span><span class="n">t_end</span> <span class="o">-</span> <span class="n">t_start</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> 
                                             <span class="n">x_t</span><span class="o">=</span><span class="n">x_t</span> <span class="o">+</span> <span class="nf">self</span><span class="p">(</span><span class="n">x_t</span><span class="o">=</span><span class="n">x_t</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">t_start</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">t_end</span> <span class="o">-</span> <span class="n">t_start</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
</code></pre></div></div> <h2 id="1-training-the-flow-model">1. Training the Flow Model</h2> <p>We use \(x_0\) as noise, \(x_1\) as data and \(x_t \sim \mathcal{N}(x\mid\alpha_t x_1, \sigma_t^2 I)\).</p> <p>\(\alpha_t\) and \(\sigma_t\) need to satisfy:</p> <ul> <li> \[\alpha_1 = \sigma_0 = 1\] </li> <li> \[\alpha_0 = \sigma_1 = 0\] </li> </ul> <p>An optimal transport path will be used here, where:</p> <ul> <li> \[\alpha_t = t\] </li> <li> \[\sigma_t = 1-t\] </li> </ul> <p>The flow vector field is then: \(u_t = x_1 - x_0 = \frac{x_1 - x_t}{1 - t}\)</p> <p>The flow model takes in time \(t\) and noised sample \(x_t\) and predicts the flow vector field \(u_t\)</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">flow</span> <span class="o">=</span> <span class="nc">Flow</span><span class="p">().</span><span class="nf">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

<span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">optim</span><span class="p">.</span><span class="nc">Adam</span><span class="p">(</span><span class="n">flow</span><span class="p">.</span><span class="nf">parameters</span><span class="p">(),</span> <span class="mf">1e-2</span><span class="p">)</span>
<span class="n">loss_fn</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="nc">MSELoss</span><span class="p">()</span>

<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">tqdm</span><span class="p">(</span><span class="nf">range</span><span class="p">(</span><span class="mi">10000</span><span class="p">)):</span>
    <span class="c1"># Generate data from checkerboard distribution
</span>    <span class="n">x_1</span> <span class="o">=</span> <span class="nc">Tensor</span><span class="p">(</span><span class="nf">generate_checkerboard_2d</span><span class="p">(</span><span class="mi">1024</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span> 
                                          <span class="n">square_size</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span>
                                          <span class="n">high_prob</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                                          <span class="n">low_prob</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                                          <span class="n">x_range</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                                          <span class="n">y_range</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))).</span><span class="nf">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">x_0</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">randn_like</span><span class="p">(</span><span class="n">x_1</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">rand</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">x_1</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    
    <span class="c1"># Create interpolated samples
</span>    <span class="n">x_t</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">x_0</span> <span class="o">+</span> <span class="n">t</span> <span class="o">*</span> <span class="n">x_1</span>
    <span class="n">dx_t</span> <span class="o">=</span> <span class="n">x_1</span> <span class="o">-</span> <span class="n">x_0</span>
    
    <span class="c1"># Train to predict the flow vector field
</span>    <span class="n">optimizer</span><span class="p">.</span><span class="nf">zero_grad</span><span class="p">()</span>
    <span class="nf">loss_fn</span><span class="p">(</span><span class="nf">flow</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">x_t</span><span class="o">=</span><span class="n">x_t</span><span class="p">),</span> <span class="n">dx_t</span><span class="p">).</span><span class="nf">backward</span><span class="p">()</span>
    <span class="n">optimizer</span><span class="p">.</span><span class="nf">step</span><span class="p">()</span>
</code></pre></div></div> <h2 id="2-basic-sampling">2. Basic Sampling</h2> <p>Once the model approximates the flow vector field \(\frac{dx_t}{dt} = u_t \approx u_t^{\theta}(x_t, t)\), we can start from random noise \(x_0\) and use Euler method to find \(x_1\) iteratively.</p> \[x_{t+h} = x_{t} + h u_t \approx x_{t} + h u_t^{\theta}(x_t, t)\] <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">randn</span><span class="p">(</span><span class="mi">2048</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">n_steps</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_steps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">time_steps</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">n_steps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="nf">cpu</span><span class="p">()[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">.</span><span class="nf">cpu</span><span class="p">()[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">t = </span><span class="si">{</span><span class="n">time_steps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="sh">'</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">n_steps</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">torch</span><span class="p">.</span><span class="nf">no_grad</span><span class="p">():</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">flow</span><span class="p">.</span><span class="nf">step</span><span class="p">(</span><span class="n">x_t</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">t_start</span><span class="o">=</span><span class="n">time_steps</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">t_end</span><span class="o">=</span><span class="n">time_steps</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">].</span><span class="nf">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="nf">cpu</span><span class="p">()[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">.</span><span class="nf">cpu</span><span class="p">()[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">t = </span><span class="si">{</span><span class="n">time_steps</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span><span class="si">}</span><span class="sh">'</span><span class="p">)</span>

<span class="n">plt</span><span class="p">.</span><span class="nf">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</code></pre></div></div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/posts/scaling/fig1-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/posts/scaling/fig1-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/posts/scaling/fig1-1400.webp"></source> <img src="/assets/img/posts/scaling/fig1.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <p><strong>[Figure1: Evolution of samples from noise to data distribution over 8 steps]</strong></p> <h2 id="3-inference-time-scaling">3. Inference-Time Scaling</h2> <p>Note that here the model is unconditional and we cannot control the sampling using Euler’s method. However, there are scenarios where one wants to generate certain kind of data, achieving higher scores on some scoring functions. We will explore inference-time scaling with ODE sampler first and then explore inference-time steering toward some scoring functions.</p> <p>One simple way to do this is to generate a bunch of samples, and select best \(K\) out of those. This is trivially done but can be computationally expensive.</p> <h3 id="why-inference-time-scaling-works">Why Inference-Time Scaling Works</h3> <p>The key insight is that diffusion models define a mapping from noise to data, and by being strategic about:</p> <ol> <li> <strong>Which noise we start from</strong> (zeroth-order search)</li> <li> <strong>How we navigate the denoising path</strong> (search over paths)</li> <li> <strong>When to commit computational resources</strong> (FK steering)</li> </ol> <p>We can significantly improve sample quality without any model changes. Think of it as finding better paths through the model’s learned landscape rather than changing the landscape itself.</p> <h3 id="31-zeroth-order-search">3.1 Zeroth Order Search</h3> <p>Another way is of similar concept by sampling the neighborhood of noises that generate good samples. Since the model and ODE is deterministic, the sample quality (or scores) is determined by the initial noise. The steps are as follows:</p> <ol> <li>Given a starting point <code class="language-plaintext highlighter-rouge">pivot</code> \(n\)</li> <li>Find \(N\) candidates in the pivot’s neighborhood: \(S_n^{\lambda} = \{y: d(y, n) &lt; \lambda\}\) where d is some distance metric</li> <li>Run these candidates through ODE and use a verifier/score function to compute the scores</li> <li>Find the best candidate, update pivot to be its starting point, and repeat 1-3 for \(n\) cycles.</li> </ol> <p>The scaling complexity is \(N\times n\times steps\).</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">functools</span>

<span class="k">def</span> <span class="nf">flow_sample</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">x_start</span><span class="p">,</span> <span class="n">n_steps</span><span class="o">=</span><span class="mi">150</span><span class="p">):</span> 
    <span class="n">time_steps</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">n_steps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">flow</span><span class="p">.</span><span class="nf">eval</span><span class="p">()</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x_start</span><span class="p">.</span><span class="nf">clone</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">torch</span><span class="p">.</span><span class="nf">no_grad</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">n_steps</span><span class="p">):</span> 
            <span class="n">x</span> <span class="o">=</span> <span class="n">flow</span><span class="p">.</span><span class="nf">step</span><span class="p">(</span><span class="n">x_t</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">t_start</span><span class="o">=</span><span class="n">time_steps</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">t_end</span><span class="o">=</span><span class="n">time_steps</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="k">def</span> <span class="nf">verifier</span><span class="p">(</span><span class="n">x_1</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">):</span> 
    <span class="sh">'''</span><span class="s">
    High score for samples close to target point
    </span><span class="sh">'''</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">x_1</span> <span class="o">-</span> <span class="n">target</span>
    <span class="k">return</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="nf">sum</span><span class="p">(</span><span class="n">diff</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-3</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">line_verifier</span><span class="p">(</span><span class="n">x_1</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">tp</span><span class="o">=</span><span class="sh">'</span><span class="s">horizontal</span><span class="sh">'</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">):</span> 
    <span class="sh">'''</span><span class="s">
    High score for samples close to the line
    </span><span class="sh">'''</span>
    <span class="k">assert</span> <span class="n">tp</span> <span class="ow">in</span> <span class="p">[</span><span class="sh">'</span><span class="s">horizontal</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">vertical</span><span class="sh">'</span><span class="p">]</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x_1</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">tp</span> <span class="o">==</span> <span class="sh">'</span><span class="s">horizontal</span><span class="sh">'</span> <span class="k">else</span> <span class="n">x_1</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">line</span>
    <span class="k">return</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">diff</span><span class="p">.</span><span class="nf">abs</span><span class="p">()</span> <span class="o">+</span> <span class="mf">1e-3</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">sample_around_point</span><span class="p">(</span><span class="n">center_x</span><span class="p">,</span> <span class="n">center_y</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">,</span> <span class="n">max_distance</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="sh">'</span><span class="s">cpu</span><span class="sh">'</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="p">.</span><span class="n">float32</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Generate n samples uniformly distributed within a circle of radius max_distance
    centered at point A(center_x, center_y).
    </span><span class="sh">"""</span>
    <span class="c1"># Generate random radii and angles
</span>    <span class="c1"># For uniform distribution on disk: r = sqrt(U) * max_radius
</span>    <span class="n">u</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">rand</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">radii</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">sqrt</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">*</span> <span class="n">max_distance</span>
    
    <span class="c1"># Generate random angles [0, 2π)
</span>    <span class="n">angles</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">rand</span><span class="p">(</span><span class="n">n_samples</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">torch</span><span class="p">.</span><span class="n">pi</span>
    
    <span class="c1"># Convert to Cartesian coordinates
</span>    <span class="n">x_offset</span> <span class="o">=</span> <span class="n">radii</span> <span class="o">*</span> <span class="n">torch</span><span class="p">.</span><span class="nf">cos</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span>
    <span class="n">y_offset</span> <span class="o">=</span> <span class="n">radii</span> <span class="o">*</span> <span class="n">torch</span><span class="p">.</span><span class="nf">sin</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span>
    
    <span class="c1"># Add to center point
</span>    <span class="n">samples</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">stack</span><span class="p">([</span>
        <span class="n">center_x</span> <span class="o">+</span> <span class="n">x_offset</span><span class="p">,</span>
        <span class="n">center_y</span> <span class="o">+</span> <span class="n">y_offset</span>
    <span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">samples</span>

<span class="k">def</span> <span class="nf">sample_around_point_tensor</span><span class="p">(</span><span class="n">center_point</span><span class="p">,</span> <span class="n">n_samples</span><span class="p">,</span> <span class="n">max_distance</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s">
    Alternative interface that takes center point as a tensor.
    </span><span class="sh">"""</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">center_point</span><span class="p">.</span><span class="n">device</span>
    <span class="n">dtype</span> <span class="o">=</span> <span class="n">center_point</span><span class="p">.</span><span class="n">dtype</span>
    
    <span class="k">return</span> <span class="nf">sample_around_point</span><span class="p">(</span>
        <span class="n">center_point</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">item</span><span class="p">(),</span> 
        <span class="n">center_point</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">item</span><span class="p">(),</span> 
        <span class="n">n_samples</span><span class="p">,</span> 
        <span class="n">max_distance</span><span class="p">,</span> 
        <span class="n">device</span><span class="p">,</span> 
        <span class="n">dtype</span>
    <span class="p">)</span>

<span class="k">def</span> <span class="nf">inference_time_scaling_zeroth_search</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">verify_fn</span><span class="p">,</span> <span class="n">sampling_fn</span><span class="p">,</span> <span class="n">pivot</span><span class="p">,</span> <span class="n">cycle</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">n_samples</span><span class="o">=</span><span class="mi">2048</span><span class="p">):</span> 
    <span class="n">samples</span><span class="p">,</span> <span class="n">noises</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">pvt</span> <span class="o">=</span> <span class="n">pivot</span><span class="p">.</span><span class="nf">clone</span><span class="p">()</span>
    
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">cycle</span><span class="p">):</span> 
        <span class="n">x_start</span> <span class="o">=</span> <span class="nf">sampling_fn</span><span class="p">(</span><span class="n">pvt</span><span class="p">,</span> <span class="n">n_samples</span><span class="o">=</span><span class="n">n_samples</span><span class="p">)</span>
        <span class="n">x_final</span> <span class="o">=</span> <span class="nf">flow_sample</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">x_start</span><span class="p">)</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="nf">verify_fn</span><span class="p">(</span><span class="n">x_final</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">scores</span><span class="p">.</span><span class="nf">argmax</span><span class="p">()</span>
        <span class="n">pvt</span> <span class="o">=</span> <span class="n">x_start</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">samples</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">x_final</span><span class="p">.</span><span class="nf">cpu</span><span class="p">())</span>
        <span class="n">noises</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">x_start</span><span class="p">.</span><span class="nf">cpu</span><span class="p">())</span>
    
    <span class="k">return</span> <span class="n">samples</span><span class="p">,</span> <span class="n">noises</span>

<span class="k">def</span> <span class="nf">plot_samples</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">pivot</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">tp</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span> 
    <span class="n">n</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">n</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sample</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">samples</span><span class="p">):</span> 
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nf">scatter</span><span class="p">(</span><span class="n">sample</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">sample</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nf">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nf">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nf">scatter</span><span class="p">([</span><span class="n">pivot</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">item</span><span class="p">()],</span> <span class="p">[</span><span class="n">pivot</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">item</span><span class="p">()],</span> <span class="n">c</span><span class="o">=</span><span class="sh">'</span><span class="s">black</span><span class="sh">'</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nf">scatter</span><span class="p">([</span><span class="n">target</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">item</span><span class="p">()],</span> <span class="p">[</span><span class="n">target</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">item</span><span class="p">()],</span> <span class="n">c</span><span class="o">=</span><span class="sh">'</span><span class="s">red</span><span class="sh">'</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="sh">'</span><span class="s">*</span><span class="sh">'</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">line</span> <span class="ow">and</span> <span class="n">tp</span><span class="p">:</span> 
            <span class="k">if</span> <span class="n">tp</span> <span class="o">==</span> <span class="sh">'</span><span class="s">horizontal</span><span class="sh">'</span><span class="p">:</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nf">hlines</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">red</span><span class="sh">'</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nf">vlines</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">red</span><span class="sh">'</span><span class="p">)</span>
        
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nf">set_xticks</span><span class="p">([])</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nf">set_yticks</span><span class="p">([])</span>
    <span class="k">return</span> <span class="n">fig</span>
</code></pre></div></div> <p>Now let’s run experiments with different targets:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">torch</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">manual_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">pivot</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">randn</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">sampling_fn</span> <span class="o">=</span> <span class="n">functools</span><span class="p">.</span><span class="nf">partial</span><span class="p">(</span><span class="n">sample_around_point_tensor</span><span class="p">,</span> <span class="n">max_distance</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

<span class="c1">## Target at (-2, -2)
</span><span class="n">target</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">tensor</span><span class="p">([</span><span class="o">-</span><span class="mf">2.</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">verify_fn</span> <span class="o">=</span> <span class="n">functools</span><span class="p">.</span><span class="nf">partial</span><span class="p">(</span><span class="n">verifier</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">)</span>
<span class="n">samples</span><span class="p">,</span> <span class="n">noises</span> <span class="o">=</span> <span class="nf">inference_time_scaling_zeroth_search</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">verify_fn</span><span class="p">,</span> <span class="n">sampling_fn</span><span class="p">,</span> <span class="n">pivot</span><span class="p">,</span> <span class="n">cycle</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="nf">plot_samples</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">pivot</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

<span class="c1">## Target at (0, 0)
</span><span class="n">target</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">tensor</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">verify_fn</span> <span class="o">=</span> <span class="n">functools</span><span class="p">.</span><span class="nf">partial</span><span class="p">(</span><span class="n">verifier</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">)</span>
<span class="n">samples</span><span class="p">,</span> <span class="n">noises</span> <span class="o">=</span> <span class="nf">inference_time_scaling_zeroth_search</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">verify_fn</span><span class="p">,</span> <span class="n">sampling_fn</span><span class="p">,</span> <span class="n">pivot</span><span class="p">,</span> <span class="n">cycle</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="nf">plot_samples</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">pivot</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
</code></pre></div></div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/posts/scaling/fig2-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/posts/scaling/fig2-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/posts/scaling/fig2-1400.webp"></source> <img src="/assets/img/posts/scaling/fig2.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/posts/scaling/fig3-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/posts/scaling/fig3-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/posts/scaling/fig3-1400.webp"></source> <img src="/assets/img/posts/scaling/fig3.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <p><strong>[Figure2-3: Zeroth-order search results for different target points]</strong></p> <p>Now let’s try steering towards lines:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">torch</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">manual_seed</span><span class="p">(</span><span class="mi">77</span><span class="p">)</span>
<span class="n">line1</span><span class="p">,</span> <span class="n">line2</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">randn</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
<span class="n">line1</span><span class="p">,</span> <span class="n">line2</span> <span class="o">=</span> <span class="n">line1</span><span class="p">.</span><span class="nf">item</span><span class="p">(),</span> <span class="n">line2</span><span class="p">.</span><span class="nf">item</span><span class="p">()</span>
<span class="nf">print</span><span class="p">(</span><span class="n">line1</span><span class="p">,</span> <span class="n">line2</span><span class="p">)</span>
<span class="n">sampling_fn</span> <span class="o">=</span> <span class="n">functools</span><span class="p">.</span><span class="nf">partial</span><span class="p">(</span><span class="n">sample_around_point_tensor</span><span class="p">,</span> <span class="n">max_distance</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

<span class="n">pivot</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">tensor</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

<span class="c1">## Horizontal line
</span><span class="n">verify_fn</span> <span class="o">=</span> <span class="n">functools</span><span class="p">.</span><span class="nf">partial</span><span class="p">(</span><span class="n">line_verifier</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="n">line1</span><span class="p">,</span> <span class="n">tp</span><span class="o">=</span><span class="sh">'</span><span class="s">horizontal</span><span class="sh">'</span><span class="p">)</span>
<span class="n">samples</span><span class="p">,</span> <span class="n">noises</span> <span class="o">=</span> <span class="nf">inference_time_scaling_zeroth_search</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">verify_fn</span><span class="p">,</span> <span class="n">sampling_fn</span><span class="p">,</span> <span class="n">pivot</span><span class="p">,</span> <span class="n">cycle</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="nf">plot_samples</span><span class="p">(</span><span class="n">samples</span><span class="p">[::</span><span class="mi">4</span><span class="p">],</span> <span class="n">pivot</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="n">line1</span><span class="p">,</span> <span class="n">tp</span><span class="o">=</span><span class="sh">'</span><span class="s">horizontal</span><span class="sh">'</span><span class="p">)</span>

<span class="c1">## Vertical line
</span><span class="n">verify_fn</span> <span class="o">=</span> <span class="n">functools</span><span class="p">.</span><span class="nf">partial</span><span class="p">(</span><span class="n">line_verifier</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="n">line2</span><span class="p">,</span> <span class="n">tp</span><span class="o">=</span><span class="sh">'</span><span class="s">vertical</span><span class="sh">'</span><span class="p">)</span>
<span class="n">samples</span><span class="p">,</span> <span class="n">noises</span> <span class="o">=</span> <span class="nf">inference_time_scaling_zeroth_search</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">verify_fn</span><span class="p">,</span> <span class="n">sampling_fn</span><span class="p">,</span> <span class="n">pivot</span><span class="p">,</span> <span class="n">cycle</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="nf">plot_samples</span><span class="p">(</span><span class="n">samples</span><span class="p">[::</span><span class="mi">4</span><span class="p">],</span> <span class="n">pivot</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="n">line2</span><span class="p">,</span> <span class="n">tp</span><span class="o">=</span><span class="sh">'</span><span class="s">vertical</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/posts/scaling/fig4-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/posts/scaling/fig4-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/posts/scaling/fig4-1400.webp"></source> <img src="/assets/img/posts/scaling/fig4.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/posts/scaling/fig5-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/posts/scaling/fig5-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/posts/scaling/fig5-1400.webp"></source> <img src="/assets/img/posts/scaling/fig5.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <p><strong>[Figure4-5: Zeroth-order search results for line targets]</strong></p> <h3 id="32-search-over-paths">3.2 Search over Paths</h3> <p>Previously, we search over initial noise. We can further do the search during the inference steps \(x_t\) by forward noising \(\Delta f\) for the good samples and then reverse \(\Delta b\). The process is the following:</p> <ol> <li>Sample \(N\) initial iid noises and run the ODE solver until some time \(t\). The noisy samples \(x_t\) serve as the search starting point.</li> <li>Sample \(M\) iid noises for each noisy samples \(x_t\), and simulate the forward noising process from \(t\) to \(t-\Delta f\) to produce \(x_{t-\Delta f}\) with size \(M\).</li> <li>Run ODE solver on each \(x_{t-\Delta f}\) to time \(t-\Delta f + \Delta b\), and obtain \(x_{t-\Delta f + \Delta b}\). Run verifiers on these samples and keep the top \(N\) candidates. Repeat steps 2-3 until \(t=1\)</li> <li>Run the remaining N samples through random search and keep the best one.</li> </ol> <p>The inference is reversing the noise, and here, we are doing <code class="language-plaintext highlighter-rouge">expand</code> -&gt; <code class="language-plaintext highlighter-rouge">forward</code> -&gt; <code class="language-plaintext highlighter-rouge">reverse</code> -&gt; <code class="language-plaintext highlighter-rouge">score</code> -&gt; <code class="language-plaintext highlighter-rouge">select</code></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">flow_simulate</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">x_t</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span> <span class="n">step_size</span><span class="p">):</span> 
    <span class="k">assert</span> <span class="n">t_end</span> <span class="o">&gt;</span> <span class="n">t</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">x_t</span><span class="p">.</span><span class="n">device</span>
    
    <span class="n">n_steps</span> <span class="o">=</span> <span class="nf">int</span><span class="p">((</span><span class="n">t_end</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">/</span> <span class="n">step_size</span><span class="p">)</span>
    <span class="n">time_steps</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">linspace</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span> <span class="n">n_steps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">flow</span><span class="p">.</span><span class="nf">eval</span><span class="p">()</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x_t</span><span class="p">.</span><span class="nf">clone</span><span class="p">()</span>
    <span class="k">with</span> <span class="n">torch</span><span class="p">.</span><span class="nf">no_grad</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">n_steps</span><span class="p">):</span> 
            <span class="n">x</span> <span class="o">=</span> <span class="n">flow</span><span class="p">.</span><span class="nf">step</span><span class="p">(</span><span class="n">x_t</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">t_start</span><span class="o">=</span><span class="n">time_steps</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">t_end</span><span class="o">=</span><span class="n">time_steps</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="k">def</span> <span class="nf">search_over_paths</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">t_start</span><span class="p">,</span> <span class="n">delta_f</span><span class="p">,</span> <span class="n">delta_b</span><span class="p">,</span> <span class="n">verify_fn</span><span class="p">,</span> <span class="n">step_size</span><span class="p">):</span> 
    <span class="c1"># delta_f and delta_b are on the time axis 
</span>    <span class="k">assert</span> <span class="n">delta_b</span> <span class="o">&gt;</span> <span class="n">delta_f</span> <span class="o">&gt;</span> <span class="n">step_size</span>
    <span class="k">assert</span> <span class="n">N</span> <span class="o">*</span> <span class="n">M</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="k">assert</span> <span class="n">t_start</span> <span class="o">&gt;</span> <span class="mi">0</span>
    
    <span class="n">flow</span><span class="p">.</span><span class="nf">eval</span><span class="p">()</span>
    <span class="n">device</span> <span class="o">=</span> <span class="nf">next</span><span class="p">(</span><span class="n">flow</span><span class="p">.</span><span class="nf">parameters</span><span class="p">()).</span><span class="n">device</span>
    
    <span class="n">x_hist</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1"># step 1: Sample N, simulate from 0 to t_start
</span>    <span class="n">x_0</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">randn</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">x_t</span> <span class="o">=</span> <span class="nf">flow_simulate</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">x_0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">t_start</span><span class="p">,</span> <span class="n">step_size</span><span class="p">)</span> <span class="c1"># (N, 2)
</span>    
    <span class="n">x_hist</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">x_0</span><span class="p">.</span><span class="nf">cpu</span><span class="p">()))</span>
    <span class="n">x_hist</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="n">t_start</span><span class="p">,</span> <span class="n">x_t</span><span class="p">.</span><span class="nf">cpu</span><span class="p">()))</span>
    
    <span class="c1"># Step 2-3: Sample M from each x_t, forward to t-df, reverse to t-df+db
</span>    <span class="n">t</span> <span class="o">=</span> <span class="n">t_start</span>
    <span class="k">while</span> <span class="n">t</span> <span class="o">-</span> <span class="n">delta_f</span> <span class="o">+</span> <span class="n">delta_b</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span> 
        <span class="c1"># expand x_t and forward noise
</span>        <span class="n">x_t_df</span> <span class="o">=</span> <span class="n">x_t</span><span class="p">.</span><span class="nf">repeat</span><span class="p">((</span><span class="n">M</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">delta_f</span> <span class="o">*</span> <span class="n">torch</span><span class="p">.</span><span class="nf">randn</span><span class="p">((</span><span class="n">M</span> <span class="o">*</span> <span class="n">N</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
        
        <span class="c1"># reverse to t-df+db
</span>        <span class="n">x_t_df_db</span> <span class="o">=</span> <span class="nf">flow_simulate</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">x_t_df</span><span class="p">,</span> <span class="n">t</span> <span class="o">-</span> <span class="n">delta_f</span><span class="p">,</span> <span class="n">t</span> <span class="o">-</span> <span class="n">delta_f</span> <span class="o">+</span> <span class="n">delta_b</span><span class="p">,</span> <span class="n">step_size</span><span class="p">)</span>
        
        <span class="c1"># run verifier on noisy samples
</span>        <span class="n">scores</span> <span class="o">=</span> <span class="nf">verify_fn</span><span class="p">(</span><span class="n">x_t_df_db</span><span class="p">)</span>
        
        <span class="c1"># pick top N and update x_t and t
</span>        <span class="n">top_idx</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">argsort</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">descending</span><span class="o">=</span><span class="bp">True</span><span class="p">)[:</span><span class="n">N</span><span class="p">]</span>
        <span class="n">x_t</span> <span class="o">=</span> <span class="n">x_t_df_db</span><span class="p">[</span><span class="n">top_idx</span><span class="p">]</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">-</span> <span class="n">delta_f</span> <span class="o">+</span> <span class="n">delta_b</span>
        
        <span class="n">x_hist</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="n">t</span><span class="p">,</span> <span class="n">x_t</span><span class="p">.</span><span class="nf">cpu</span><span class="p">()))</span>
    
    <span class="c1"># push these N x_t to 1.0
</span>    <span class="n">x_final</span> <span class="o">=</span> <span class="nf">flow_simulate</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">x_t</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">step_size</span><span class="p">)</span>
    <span class="n">x_hist</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">x_final</span><span class="p">.</span><span class="nf">cpu</span><span class="p">()))</span>
    <span class="k">return</span> <span class="n">x_hist</span>

<span class="k">def</span> <span class="nf">plot_samples_with_time</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">tp</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span> 
    <span class="n">n</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="n">n</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">sample</span><span class="p">)</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">samples</span><span class="p">):</span> 
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nf">scatter</span><span class="p">(</span><span class="n">sample</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">sample</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nf">set_xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nf">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nf">scatter</span><span class="p">([</span><span class="n">target</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">item</span><span class="p">()],</span> <span class="p">[</span><span class="n">target</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">item</span><span class="p">()],</span> <span class="n">c</span><span class="o">=</span><span class="sh">'</span><span class="s">red</span><span class="sh">'</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="sh">'</span><span class="s">*</span><span class="sh">'</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">line</span> <span class="ow">and</span> <span class="n">tp</span><span class="p">:</span> 
            <span class="k">if</span> <span class="n">tp</span> <span class="o">==</span> <span class="sh">'</span><span class="s">horizontal</span><span class="sh">'</span><span class="p">:</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nf">hlines</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">red</span><span class="sh">'</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nf">vlines</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">red</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nf">set_xticks</span><span class="p">([])</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nf">set_yticks</span><span class="p">([])</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">t = </span><span class="si">{</span><span class="n">t</span><span class="si">:</span><span class="p">.</span><span class="mi">3</span><span class="n">f</span><span class="si">}</span><span class="sh">'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fig</span>
</code></pre></div></div> <p>Let’s run experiments with different targets:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Target at (0, 0)
</span><span class="n">target</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">verify_fn</span> <span class="o">=</span> <span class="n">functools</span><span class="p">.</span><span class="nf">partial</span><span class="p">(</span><span class="n">verifier</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">)</span>
<span class="n">samples</span> <span class="o">=</span> <span class="nf">search_over_paths</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.14</span><span class="p">,</span> <span class="n">verify_fn</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="nf">plot_samples_with_time</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

<span class="c1"># Target at (2.0, 0.5)
</span><span class="n">target</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">tensor</span><span class="p">([</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">verify_fn</span> <span class="o">=</span> <span class="n">functools</span><span class="p">.</span><span class="nf">partial</span><span class="p">(</span><span class="n">verifier</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">)</span>
<span class="n">samples</span> <span class="o">=</span> <span class="nf">search_over_paths</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.14</span><span class="p">,</span> <span class="n">verify_fn</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="nf">plot_samples_with_time</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

<span class="c1"># Target at (-0.5, -0.5)
</span><span class="n">target</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">tensor</span><span class="p">([</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">verify_fn</span> <span class="o">=</span> <span class="n">functools</span><span class="p">.</span><span class="nf">partial</span><span class="p">(</span><span class="n">verifier</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">)</span>
<span class="n">samples</span> <span class="o">=</span> <span class="nf">search_over_paths</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.14</span><span class="p">,</span> <span class="n">verify_fn</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="nf">plot_samples_with_time</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
</code></pre></div></div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/posts/scaling/fig6-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/posts/scaling/fig6-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/posts/scaling/fig6-1400.webp"></source> <img src="/assets/img/posts/scaling/fig6.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <p><strong>[Figure6: Search over paths results for different target points]</strong></p> <p>Line targets:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">torch</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">manual_seed</span><span class="p">(</span><span class="mi">77</span><span class="p">)</span>
<span class="n">line1</span><span class="p">,</span> <span class="n">line2</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">randn</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
<span class="n">line1</span><span class="p">,</span> <span class="n">line2</span> <span class="o">=</span> <span class="n">line1</span><span class="p">.</span><span class="nf">item</span><span class="p">(),</span> <span class="n">line2</span><span class="p">.</span><span class="nf">item</span><span class="p">()</span>
<span class="nf">print</span><span class="p">(</span><span class="n">line1</span><span class="p">,</span> <span class="n">line2</span><span class="p">)</span>

<span class="n">verify_fn</span> <span class="o">=</span> <span class="n">functools</span><span class="p">.</span><span class="nf">partial</span><span class="p">(</span><span class="n">line_verifier</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="n">line1</span><span class="p">,</span> <span class="n">tp</span><span class="o">=</span><span class="sh">'</span><span class="s">horizontal</span><span class="sh">'</span><span class="p">)</span>
<span class="n">samples</span> <span class="o">=</span> <span class="nf">search_over_paths</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.14</span><span class="p">,</span> <span class="n">verify_fn</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="nf">plot_samples_with_time</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="n">line1</span><span class="p">,</span> <span class="n">tp</span><span class="o">=</span><span class="sh">'</span><span class="s">horizontal</span><span class="sh">'</span><span class="p">)</span>

<span class="n">verify_fn</span> <span class="o">=</span> <span class="n">functools</span><span class="p">.</span><span class="nf">partial</span><span class="p">(</span><span class="n">line_verifier</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="n">line2</span><span class="p">,</span> <span class="n">tp</span><span class="o">=</span><span class="sh">'</span><span class="s">vertical</span><span class="sh">'</span><span class="p">)</span>
<span class="n">samples</span> <span class="o">=</span> <span class="nf">search_over_paths</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.14</span><span class="p">,</span> <span class="n">verify_fn</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="nf">plot_samples_with_time</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="n">line2</span><span class="p">,</span> <span class="n">tp</span><span class="o">=</span><span class="sh">'</span><span class="s">vertical</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/posts/scaling/fig7-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/posts/scaling/fig7-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/posts/scaling/fig7-1400.webp"></source> <img src="/assets/img/posts/scaling/fig7.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <p><strong>[Figure7: Search over paths results for line targets]</strong></p> <h3 id="33-feynman-kac-steering">3.3 Feynman-Kac Steering</h3> <p>Previously, we looked at ODE sampling. Here, we’ll look into the SDE sampling with Feynman-Kac steering, the most sophisticated approach based on rare-event simulation theory.</p> <h4 id="theoretical-foundation">Theoretical Foundation</h4> <p>Feynman-Kac (FK) steering is based on Feynman-Kac interacting particle systems (FK-IPS), a rare-event simulation method. The goal is to sample from a tilted distribution:</p> \[p_{\text{target}}(x_0|c) = \frac{1}{Z} p_\theta(x_0|c) \exp(\lambda r(x_0, c))\] <p>where \(r(x_0, c)\) is a reward function encoding desired properties. FK steering works by:</p> <ol> <li>Sampling multiple interacting diffusion processes (particles)</li> <li>Scoring particles using functions called potentials</li> <li>Resampling particles based on their potentials at intermediate steps</li> </ol> <p>The method defines a sequence of distributions \(p_{FK,t}(x_T, x_{T-1}, ..., x_t)\) by tilting the base distribution with potentials \(G_t\):</p> \[p_{FK,t}(x_T, ..., x_t|c) = \frac{1}{Z_t} p_\theta(x_T, ..., x_t|c) \prod_{s=T}^{t} G_s(x_T, ..., x_s, c)\] <p>The potentials must satisfy: \(\prod_{t=T}^{0} G_t(x_T, ..., x_t, c) = \exp(\lambda r(x_0, c))\)</p> <p>This ensures that sampling from \(p_{FK,0}\) produces samples from the target tilted distribution.</p> <h4 id="intuition-why-particle-based-methods-excel">Intuition: Why Particle-Based Methods Excel</h4> <p>FK steering leverages the power of particle-based methods for rare-event simulation. The key insight is that high-reward samples might be rare under the base model \(p_\theta(x_0)\), but by:</p> <ol> <li> <strong>Running multiple particles in parallel</strong>: We explore different regions of the space</li> <li> <strong>Resampling based on potentials</strong>: We focus compute on promising trajectories</li> <li> <strong>Using intermediate rewards</strong>: We can identify good paths early and abandon poor ones</li> </ol> <p>This is fundamentally different from:</p> <ul> <li> <strong>Best-of-N</strong>: Which wastes compute on full generation of poor samples</li> <li> <strong>Gradient guidance</strong>: Which is limited to differentiable rewards and can get stuck in local optima</li> <li> <strong>Fine-tuning</strong>: Which permanently changes the model for a single reward</li> </ul> <p>The particle-based approach adaptively allocates computational resources, similar to how evolution explores multiple mutations but only propagates successful ones.</p> <h4 id="sde-formulation">SDE Formulation</h4> <p>The SDE reverse sampling takes the form:</p> \[dx_t = v(x_t, t)dt - \frac{1}{2}\omega_ts(x_t, t) + \sqrt{\omega_t}dW_t\] <p>where \(v(x_t, t)\) is the flow vector field and \(s(x_t, t) = \nabla\log p_t(x)\) is the score. \(\omega_t\) is some time-dependent diffusion coefficient with \(\omega_1 = 0\). \(dW_t\) is a reverse-time Weiner process.</p> <p>If \(x_t \sim \mathcal{N}(x\mid\alpha_t x_1, \sigma_t^2 I)\), we have the relationship between flow \(v(x_t, t)\) and score \(s(x_t, t)\):</p> \[s(x_t, t) = \sigma_t^{-1}\frac{\alpha_tv(x_t, t) - \dot{\alpha_t}x}{\dot{\alpha_t}\sigma_t - \alpha_t\dot{\sigma_t}}\] <p>In the OT case where \(\alpha_t = t\) and \(\sigma_t = 1 - t\):</p> \[s(x_t, t) = \frac{tv(x_t, t) - x_t}{1-t}\] <p>We can pick \(\omega_t = k\sigma_t = k(1-t)\), which avoids numerical instability when \(t \rightarrow 1\) with \(0&lt;k&lt;1\) controls the stochasticity.</p> \[dx_t = \left[v(x_t, t) - \frac{k}{2}tv(x_t, t) + \frac{k}{2}x_t \right]dt + \sqrt{k(1-t)}dW_t\] <p>Notice that when \(k=0\), the SDE becomes ODE.</p> <p>First, let’s implement basic SDE sampling:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">flow_simple_stochastic</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">x_t</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span> <span class="n">step_size</span><span class="p">):</span> 
    <span class="k">assert</span> <span class="n">t_end</span> <span class="o">&gt;</span> <span class="n">t</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">x_t</span><span class="p">.</span><span class="n">device</span>
    
    <span class="n">n_steps</span> <span class="o">=</span> <span class="nf">int</span><span class="p">((</span><span class="n">t_end</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">/</span> <span class="n">step_size</span><span class="p">)</span>
    <span class="n">time_steps</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">linspace</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span> <span class="n">n_steps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">flow</span><span class="p">.</span><span class="nf">eval</span><span class="p">()</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x_t</span><span class="p">.</span><span class="nf">clone</span><span class="p">()</span>
    <span class="n">x_hist</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">.</span><span class="nf">cpu</span><span class="p">()]</span>
    <span class="k">with</span> <span class="n">torch</span><span class="p">.</span><span class="nf">no_grad</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">n_steps</span><span class="p">):</span> 
            <span class="n">x</span> <span class="o">=</span> <span class="n">flow</span><span class="p">.</span><span class="nf">step</span><span class="p">(</span><span class="n">x_t</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">t_start</span><span class="o">=</span><span class="n">time_steps</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">t_end</span><span class="o">=</span><span class="n">time_steps</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">x</span> <span class="o">+=</span> <span class="p">(</span><span class="n">time_steps</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">time_steps</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="n">torch</span><span class="p">.</span><span class="nf">randn_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">time_steps</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">**</span> <span class="mf">0.5</span>
            <span class="n">x_hist</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="nf">cpu</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">x_hist</span>

<span class="k">def</span> <span class="nf">flow_sde_reverse</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">x_t</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span> <span class="n">step_size</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span> 
    <span class="k">assert</span> <span class="n">t_end</span> <span class="o">&gt;</span> <span class="n">t</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">x_t</span><span class="p">.</span><span class="n">device</span>
    
    <span class="n">n_steps</span> <span class="o">=</span> <span class="nf">int</span><span class="p">((</span><span class="n">t_end</span> <span class="o">-</span> <span class="n">t</span><span class="p">)</span> <span class="o">/</span> <span class="n">step_size</span><span class="p">)</span>
    <span class="n">time_steps</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">linspace</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">t_end</span><span class="p">,</span> <span class="n">n_steps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">flow</span><span class="p">.</span><span class="nf">eval</span><span class="p">()</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x_t</span><span class="p">.</span><span class="nf">clone</span><span class="p">()</span>
    <span class="n">x_hist</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">.</span><span class="nf">cpu</span><span class="p">()]</span>
    <span class="k">with</span> <span class="n">torch</span><span class="p">.</span><span class="nf">no_grad</span><span class="p">():</span> 
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">n_steps</span><span class="p">):</span> 
            <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span> <span class="o">=</span> <span class="n">time_steps</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">time_steps</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">t1</span> <span class="o">=</span> <span class="n">t1</span><span class="p">.</span><span class="nf">view</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span><span class="nf">expand</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">v</span> <span class="o">=</span> <span class="nf">flow</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="n">t1</span> <span class="o">+</span> <span class="p">(</span><span class="n">t2</span> <span class="o">-</span> <span class="n">t1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">x_t</span><span class="o">=</span><span class="n">x</span> <span class="o">+</span> <span class="nf">flow</span><span class="p">(</span><span class="n">x_t</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">t1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">t2</span> <span class="o">-</span> <span class="n">t1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">+=</span> <span class="p">(</span><span class="n">v</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">k</span> <span class="o">*</span> <span class="n">t1</span> <span class="o">*</span> <span class="n">v</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">k</span> <span class="o">*</span> <span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">t2</span> <span class="o">-</span> <span class="n">t1</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">+=</span> <span class="p">(</span><span class="n">t2</span> <span class="o">-</span> <span class="n">t1</span><span class="p">)</span> <span class="o">*</span> <span class="n">torch</span><span class="p">.</span><span class="nf">randn_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">k</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">t1</span><span class="p">))</span> <span class="o">**</span> <span class="mf">0.5</span>
            <span class="n">x_hist</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="nf">cpu</span><span class="p">())</span>
            
    <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">x_hist</span>
</code></pre></div></div> <p>Compare stochastic vs deterministic sampling:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">x_0</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">randn</span><span class="p">((</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">_</span><span class="p">,</span> <span class="n">xhis_1</span> <span class="o">=</span> <span class="nf">flow_simple_stochastic</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">x_0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
<span class="n">_</span><span class="p">,</span> <span class="n">xhis_2</span> <span class="o">=</span> <span class="nf">flow_sde_reverse</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">x_0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

<span class="n">_</span> <span class="o">=</span> <span class="nf">plot_samples</span><span class="p">(</span><span class="n">xhis_1</span><span class="p">[::</span><span class="mi">10</span><span class="p">],</span> <span class="n">torch</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">torch</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<span class="n">_</span> <span class="o">=</span> <span class="nf">plot_samples</span><span class="p">(</span><span class="n">xhis_2</span><span class="p">[::</span><span class="mi">10</span><span class="p">],</span> <span class="n">torch</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">torch</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
</code></pre></div></div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/posts/scaling/fig8-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/posts/scaling/fig8-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/posts/scaling/fig8-1400.webp"></source> <img src="/assets/img/posts/scaling/fig8.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/posts/scaling/fig9-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/posts/scaling/fig9-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/posts/scaling/fig9-1400.webp"></source> <img src="/assets/img/posts/scaling/fig9.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <p><strong>[Figure8-9: Comparison of simple stochastic vs SDE reverse sampling]</strong></p> <p>Now the full Feynman-Kac steering implementation:</p> <h4 id="potential-functions-and-their-roles">Potential Functions and Their Roles</h4> <p>FK steering uses different types of potentials that score particles using intermediate rewards \(r_\phi(x_t)\):</p> <ol> <li> <strong>DIFFERENCE</strong>: \(G_t(x_t, x_{t+1}) = \exp(\lambda(r_\phi(x_t) - r_\phi(x_{t+1})))\) <ul> <li>Prefers particles with increasing rewards</li> <li>Similar to what Twisted Diffusion Sampler (TDS) uses</li> <li>Can assign low scores to particles that reach maximum reward early</li> </ul> </li> <li> <strong>MAX</strong>: \(G_t(x_T, ..., x_t) = \exp(\lambda \max_{s=t}^T r_\phi(x_s))\) <ul> <li>Prefers particles with highest rewards seen so far</li> <li>Better for bounded rewards</li> <li>May reduce diversity compared to difference potential</li> </ul> </li> <li> <strong>SUM</strong>: \(G_t(x_T, ..., x_t) = \exp(\lambda \sum_{s=t}^T r_\phi(x_s))\) <ul> <li>Selects particles with highest accumulated rewards</li> <li>Balances between current and historical performance</li> </ul> </li> </ol> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">Feyman_Kac_Steering</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">n_particles</span><span class="p">,</span> 
                        <span class="n">resampling_t_start</span><span class="p">,</span> <span class="n">resampling_t_end</span><span class="p">,</span> <span class="n">n_resampling</span><span class="p">,</span> 
                        <span class="n">step_size</span><span class="p">,</span> <span class="n">reward_fn</span><span class="p">,</span> <span class="n">potential_tp</span><span class="p">,</span> <span class="n">lmbda</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
    
    <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">resampling_t_start</span> <span class="o">&lt;</span> <span class="n">resampling_t_end</span> <span class="o">&lt;=</span> <span class="mf">1.0</span>
    <span class="k">assert</span> <span class="n">potential_tp</span> <span class="ow">in</span> <span class="p">[</span><span class="sh">'</span><span class="s">max</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">add</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">diff</span><span class="sh">'</span><span class="p">]</span>
    <span class="n">device</span> <span class="o">=</span> <span class="nf">next</span><span class="p">(</span><span class="n">flow</span><span class="p">.</span><span class="nf">parameters</span><span class="p">()).</span><span class="n">device</span>
    
    <span class="c1"># Setup resampling schedule
</span>    <span class="n">n_steps</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">step_size</span><span class="p">)</span>
    <span class="n">time_steps</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">torch</span><span class="p">.</span><span class="nf">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">n_steps</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">resampling_idx_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">time_steps</span> <span class="o">-</span> <span class="n">resampling_t_start</span><span class="p">).</span><span class="nf">abs</span><span class="p">().</span><span class="nf">argmin</span><span class="p">().</span><span class="nf">item</span><span class="p">()</span>
    <span class="n">resampling_idx_end</span> <span class="o">=</span> <span class="p">(</span><span class="n">time_steps</span> <span class="o">-</span> <span class="n">resampling_t_end</span><span class="p">).</span><span class="nf">abs</span><span class="p">().</span><span class="nf">argmin</span><span class="p">().</span><span class="nf">item</span><span class="p">()</span>
    <span class="n">resampling_idx_step</span> <span class="o">=</span> <span class="nf">int</span><span class="p">((</span><span class="n">resampling_idx_end</span> <span class="o">-</span> <span class="n">resampling_idx_start</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_resampling</span><span class="p">)</span>
    <span class="n">resampling_idx_step</span> <span class="o">+=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">resampling_idx_step</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
    <span class="n">resampling_idx</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="nf">range</span><span class="p">(</span><span class="n">resampling_idx_start</span><span class="p">,</span> <span class="n">resampling_idx_end</span><span class="p">,</span> <span class="n">resampling_idx_step</span><span class="p">))</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">resampling steps =</span><span class="sh">'</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">resampling_idx</span><span class="p">))</span>
    
    <span class="c1"># init the x and potential
</span>    <span class="n">x_hist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">x_t</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">randn</span><span class="p">((</span><span class="n">n_particles</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    <span class="n">x_hist</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">x_t</span><span class="p">.</span><span class="nf">cpu</span><span class="p">()))</span>
    <span class="n">product_of_potentials</span><span class="p">,</span> <span class="n">population_rs</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">ones</span><span class="p">(</span><span class="n">n_particles</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">),</span> <span class="n">torch</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="n">n_particles</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">time_steps</span><span class="p">):</span> 
        <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;=</span> <span class="mf">1.0</span><span class="p">:</span> <span class="k">break</span>
        
        <span class="c1"># compute score and FK-Resampling
</span>        <span class="k">if</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">resampling_idx</span><span class="p">:</span> 
            <span class="n">rs_candidates</span> <span class="o">=</span> <span class="nf">reward_fn</span><span class="p">(</span><span class="n">x_t</span><span class="p">)</span>
            
            <span class="c1"># Compute importance weights based on potential type
</span>            <span class="k">if</span> <span class="n">potential_tp</span> <span class="o">==</span> <span class="sh">'</span><span class="s">max</span><span class="sh">'</span><span class="p">:</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">exp</span><span class="p">(</span><span class="n">lmbda</span> <span class="o">*</span> <span class="n">torch</span><span class="p">.</span><span class="nf">max</span><span class="p">(</span><span class="n">rs_candidates</span><span class="p">,</span> <span class="n">population_rs</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">potential_tp</span> <span class="o">==</span> <span class="sh">'</span><span class="s">add</span><span class="sh">'</span><span class="p">:</span>
                <span class="n">rs_candidates</span> <span class="o">=</span> <span class="n">rs_candidates</span> <span class="o">+</span> <span class="n">population_rs</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">exp</span><span class="p">(</span><span class="n">lmbda</span> <span class="o">*</span> <span class="n">rs_candidates</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">potential_tp</span> <span class="o">==</span> <span class="sh">'</span><span class="s">diff</span><span class="sh">'</span><span class="p">:</span>
                <span class="n">diffs</span> <span class="o">=</span> <span class="n">rs_candidates</span> <span class="o">-</span> <span class="n">population_rs</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">exp</span><span class="p">(</span><span class="n">lmbda</span> <span class="o">*</span> <span class="n">diffs</span><span class="p">)</span>
            
            <span class="n">w</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">clamp</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1e10</span><span class="p">)</span>
            <span class="n">w</span><span class="p">[</span><span class="n">torch</span><span class="p">.</span><span class="nf">isnan</span><span class="p">(</span><span class="n">w</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.0</span>
            
            <span class="c1"># Resample indices based on weights
</span>            <span class="n">indices</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">multinomial</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="n">n_particles</span><span class="p">,</span> <span class="n">replacement</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">x_t</span> <span class="o">=</span> <span class="n">x_t</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
            <span class="n">population_rs</span> <span class="o">=</span> <span class="n">rs_candidates</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>

            <span class="c1"># Update product of potentials; used for max and add potentials
</span>            <span class="n">product_of_potentials</span> <span class="o">=</span> <span class="p">(</span><span class="n">product_of_potentials</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span> <span class="o">*</span> <span class="n">w</span><span class="p">[</span><span class="n">indices</span><span class="p">])</span>
            
        <span class="c1"># reverse / propose
</span>        <span class="k">with</span> <span class="n">torch</span><span class="p">.</span><span class="nf">no_grad</span><span class="p">():</span>
            <span class="n">tt</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="nf">view</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span><span class="nf">expand</span><span class="p">(</span><span class="n">x_t</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">v</span> <span class="o">=</span> <span class="nf">flow</span><span class="p">(</span><span class="n">t</span><span class="o">=</span><span class="n">tt</span> <span class="o">+</span> <span class="n">step_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">x_t</span><span class="o">=</span><span class="n">x_t</span> <span class="o">+</span> <span class="nf">flow</span><span class="p">(</span><span class="n">x_t</span><span class="o">=</span><span class="n">x_t</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">tt</span><span class="p">)</span> <span class="o">*</span> <span class="n">step_size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">x_t</span> <span class="o">+=</span> <span class="p">(</span><span class="n">v</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">k</span> <span class="o">*</span> <span class="n">tt</span> <span class="o">*</span> <span class="n">v</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">k</span> <span class="o">*</span> <span class="n">x_t</span><span class="p">)</span> <span class="o">*</span> <span class="n">step_size</span>
            <span class="n">x_t</span> <span class="o">+=</span> <span class="n">step_size</span> <span class="o">*</span> <span class="n">torch</span><span class="p">.</span><span class="nf">randn_like</span><span class="p">(</span><span class="n">x_t</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">k</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">tt</span><span class="p">))</span> <span class="o">**</span> <span class="mf">0.5</span>

        <span class="n">x_hist</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="n">t</span><span class="p">.</span><span class="nf">item</span><span class="p">(),</span> <span class="n">x_t</span><span class="p">.</span><span class="nf">cpu</span><span class="p">()))</span>
    
    <span class="c1"># final step
</span>    <span class="k">with</span> <span class="n">torch</span><span class="p">.</span><span class="nf">no_grad</span><span class="p">():</span> 
        <span class="n">x_t</span> <span class="o">=</span> <span class="n">flow</span><span class="p">.</span><span class="nf">step</span><span class="p">(</span><span class="n">x_t</span><span class="o">=</span><span class="n">x_t</span><span class="p">,</span> <span class="n">t_start</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">t_end</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="n">x_hist</span><span class="p">.</span><span class="nf">append</span><span class="p">((</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">x_t</span><span class="p">.</span><span class="nf">cpu</span><span class="p">()))</span>
    
    <span class="k">return</span> <span class="n">x_hist</span>
</code></pre></div></div> <p>Now let’s run experiments with different potential types:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Target at (0, 0)
</span><span class="n">target</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">tensor</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">verify_fn</span> <span class="o">=</span> <span class="n">functools</span><span class="p">.</span><span class="nf">partial</span><span class="p">(</span><span class="n">verifier</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">)</span>

<span class="k">for</span> <span class="n">tp</span> <span class="ow">in</span> <span class="p">[</span><span class="sh">'</span><span class="s">max</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">add</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">diff</span><span class="sh">'</span><span class="p">]:</span> 
    <span class="nf">print</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="nc">Feyman_Kac_Steering</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> 
                            <span class="n">resampling_t_start</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">resampling_t_end</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">n_resampling</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> 
                            <span class="n">step_size</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">reward_fn</span><span class="o">=</span><span class="n">verify_fn</span><span class="p">,</span> <span class="n">potential_tp</span><span class="o">=</span><span class="n">tp</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="nf">plot_samples_with_time</span><span class="p">(</span><span class="n">samples</span><span class="p">[::</span><span class="mi">15</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="n">samples</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">target</span><span class="p">)</span>
</code></pre></div></div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/posts/scaling/fig10-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/posts/scaling/fig10-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/posts/scaling/fig10-1400.webp"></source> <img src="/assets/img/posts/scaling/fig10.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <p><strong>[Figure10: FK steering with different potential types for target (0, 0)]</strong></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Target at (2.0, 0.5)
</span><span class="n">target</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">tensor</span><span class="p">([</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">verify_fn</span> <span class="o">=</span> <span class="n">functools</span><span class="p">.</span><span class="nf">partial</span><span class="p">(</span><span class="n">verifier</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">)</span>

<span class="k">for</span> <span class="n">tp</span> <span class="ow">in</span> <span class="p">[</span><span class="sh">'</span><span class="s">max</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">add</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">diff</span><span class="sh">'</span><span class="p">]:</span> 
    <span class="nf">print</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="nc">Feyman_Kac_Steering</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> 
                            <span class="n">resampling_t_start</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">resampling_t_end</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">n_resampling</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> 
                            <span class="n">step_size</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">reward_fn</span><span class="o">=</span><span class="n">verify_fn</span><span class="p">,</span> <span class="n">potential_tp</span><span class="o">=</span><span class="n">tp</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="nf">plot_samples_with_time</span><span class="p">(</span><span class="n">samples</span><span class="p">[::</span><span class="mi">15</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="n">samples</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">target</span><span class="p">)</span>
</code></pre></div></div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/posts/scaling/fig11-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/posts/scaling/fig11-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/posts/scaling/fig11-1400.webp"></source> <img src="/assets/img/posts/scaling/fig11.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <p><strong>[Figure11: FK steering with different potential types for target (2.0, 0.5)]</strong></p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Target at (-0.5, -0.5)
</span><span class="n">target</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">tensor</span><span class="p">([</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">],</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>
<span class="n">verify_fn</span> <span class="o">=</span> <span class="n">functools</span><span class="p">.</span><span class="nf">partial</span><span class="p">(</span><span class="n">verifier</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">)</span>

<span class="k">for</span> <span class="n">tp</span> <span class="ow">in</span> <span class="p">[</span><span class="sh">'</span><span class="s">max</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">add</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">diff</span><span class="sh">'</span><span class="p">]:</span> 
    <span class="nf">print</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="nc">Feyman_Kac_Steering</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> 
                            <span class="n">resampling_t_start</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">resampling_t_end</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">n_resampling</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> 
                            <span class="n">step_size</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">reward_fn</span><span class="o">=</span><span class="n">verify_fn</span><span class="p">,</span> <span class="n">potential_tp</span><span class="o">=</span><span class="n">tp</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="nf">plot_samples_with_time</span><span class="p">(</span><span class="n">samples</span><span class="p">[::</span><span class="mi">15</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="n">samples</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">target</span><span class="p">)</span>
</code></pre></div></div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/posts/scaling/fig12-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/posts/scaling/fig12-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/posts/scaling/fig12-1400.webp"></source> <img src="/assets/img/posts/scaling/fig12.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <p><strong>[Figure12: FK steering with different potential types for target (-0.5, -0.5)]</strong></p> <p>Line targets:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">torch</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="nf">manual_seed</span><span class="p">(</span><span class="mi">77</span><span class="p">)</span>
<span class="n">line1</span><span class="p">,</span> <span class="n">line2</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">randn</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
<span class="n">line1</span><span class="p">,</span> <span class="n">line2</span> <span class="o">=</span> <span class="n">line1</span><span class="p">.</span><span class="nf">item</span><span class="p">(),</span> <span class="n">line2</span><span class="p">.</span><span class="nf">item</span><span class="p">()</span>
<span class="nf">print</span><span class="p">(</span><span class="n">line1</span><span class="p">,</span> <span class="n">line2</span><span class="p">)</span>

<span class="c1"># Horizontal line
</span><span class="n">verify_fn</span> <span class="o">=</span> <span class="n">functools</span><span class="p">.</span><span class="nf">partial</span><span class="p">(</span><span class="n">line_verifier</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="n">line1</span><span class="p">,</span> <span class="n">tp</span><span class="o">=</span><span class="sh">'</span><span class="s">horizontal</span><span class="sh">'</span><span class="p">)</span>
<span class="k">for</span> <span class="n">tp</span> <span class="ow">in</span> <span class="p">[</span><span class="sh">'</span><span class="s">max</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">add</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">diff</span><span class="sh">'</span><span class="p">]:</span> 
    <span class="nf">print</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="nc">Feyman_Kac_Steering</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> 
                            <span class="n">resampling_t_start</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">resampling_t_end</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">n_resampling</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> 
                            <span class="n">step_size</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">reward_fn</span><span class="o">=</span><span class="n">verify_fn</span><span class="p">,</span> <span class="n">potential_tp</span><span class="o">=</span><span class="n">tp</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="nf">plot_samples_with_time</span><span class="p">(</span><span class="n">samples</span><span class="p">[::</span><span class="mi">15</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="n">samples</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">target</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="n">line1</span><span class="p">,</span> <span class="n">tp</span><span class="o">=</span><span class="sh">'</span><span class="s">horizontal</span><span class="sh">'</span><span class="p">)</span>

<span class="c1"># Vertical line
</span><span class="n">verify_fn</span> <span class="o">=</span> <span class="n">functools</span><span class="p">.</span><span class="nf">partial</span><span class="p">(</span><span class="n">line_verifier</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="n">line2</span><span class="p">,</span> <span class="n">tp</span><span class="o">=</span><span class="sh">'</span><span class="s">vertical</span><span class="sh">'</span><span class="p">)</span>
<span class="k">for</span> <span class="n">tp</span> <span class="ow">in</span> <span class="p">[</span><span class="sh">'</span><span class="s">max</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">add</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">diff</span><span class="sh">'</span><span class="p">]:</span> 
    <span class="nf">print</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="nc">Feyman_Kac_Steering</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> 
                            <span class="n">resampling_t_start</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">resampling_t_end</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">n_resampling</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> 
                            <span class="n">step_size</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">reward_fn</span><span class="o">=</span><span class="n">verify_fn</span><span class="p">,</span> <span class="n">potential_tp</span><span class="o">=</span><span class="n">tp</span><span class="p">)</span>
    <span class="n">_</span> <span class="o">=</span> <span class="nf">plot_samples_with_time</span><span class="p">(</span><span class="n">samples</span><span class="p">[::</span><span class="mi">15</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="n">samples</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">target</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="n">line2</span><span class="p">,</span> <span class="n">tp</span><span class="o">=</span><span class="sh">'</span><span class="s">vertical</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/posts/scaling/fig13-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/posts/scaling/fig13-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/posts/scaling/fig13-1400.webp"></source> <img src="/assets/img/posts/scaling/fig13.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/posts/scaling/fig14-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/posts/scaling/fig14-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/posts/scaling/fig14-1400.webp"></source> <img src="/assets/img/posts/scaling/fig14.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <p><strong>[Figure13-14: FK steering with different potential types for line targets]</strong></p> <h2 id="key-insights-and-conclusions">Key Insights and Conclusions</h2> <h3 id="comprehensive-comparison-of-the-three-approaches">Comprehensive Comparison of the Three Approaches</h3> <table border="1"> <thead> <tr> <th>Method</th> <th>Search Space</th> <th>Exploration Strategy</th> <th>Computational Cost</th> <th>Key Advantage</th> <th>Best Use Case</th> </tr> </thead> <tbody> <tr> <td>Zeroth-order</td> <td>Initial noise only</td> <td>Local neighborhood search</td> <td>Low: O(N × n × steps)</td> <td>Simple to implement</td> <td>Quick improvements with simple rewards</td> </tr> <tr> <td>Search over paths</td> <td>Intermediate states</td> <td>Branch and prune</td> <td>Medium: O(N × M × steps)</td> <td>Dynamic adaptation</td> <td>Exploring diverse generation paths</td> </tr> <tr> <td>FK Steering</td> <td>Full trajectory</td> <td>Particle resampling with potentials</td> <td>Medium-High</td> <td>Principled probabilistic framework</td> <td>Complex rewards, theoretical guarantees</td> </tr> </tbody> </table> <h3 id="connection-to-existing-methods">Connection to Existing Methods</h3> <p>FK steering provides a unified framework that generalizes several existing approaches:</p> <ul> <li> <strong>Twisted Diffusion Sampler (TDS)</strong>: Special case using difference potential and gradient guidance</li> <li> <strong>Soft Value-based Decoding (SVDD)</strong>: Special case using nested importance sampling</li> <li> <strong>Best-of-N</strong>: Can be seen as FK steering with resampling only at the final step</li> </ul> <h3 id="practical-considerations">Practical Considerations</h3> <h4 id="choosing-the-right-method">Choosing the Right Method</h4> <ol> <li> <strong>Use Zeroth-order search when</strong>: <ul> <li>Computational budget is limited</li> <li>Reward function is simple (e.g., distance to target)</li> <li>Quick improvements are needed</li> </ul> </li> <li> <strong>Use Search over paths when</strong>: <ul> <li>Need to explore diverse generation paths</li> <li>Intermediate states provide useful signal</li> <li>Have moderate computational budget</li> </ul> </li> <li> <strong>Use FK Steering when</strong>: <ul> <li>Need principled sampling from complex reward distributions</li> <li>Working with bounded rewards (use MAX potential)</li> <li>Require theoretical guarantees</li> <li>Can afford resampling overhead</li> </ul> </li> </ol> <h3 id="key-takeaways">Key Takeaways</h3> <p>The success of these methods suggests that inference-time compute may be as valuable as model scale, opening new possibilities for efficient and controllable generation. As the field advances, we may see inference-time scaling become a standard tool alongside model architecture and training data improvements.</p> <h3 id="future-directions">Future Directions</h3> <ul> <li> <strong>Adaptive particle allocation</strong>: Dynamically adjust particles based on task difficulty</li> <li> <strong>Learned potentials</strong>: Train intermediate reward models for better guidance</li> <li> <strong>Hybrid approaches</strong>: Combine FK steering with fine-tuning for further gains</li> <li> <strong>New applications</strong>: Protein design, code generation, and other domains</li> </ul> <p>The Feynman-Kac framework bridges diffusion models with rare-event simulation, providing a principled path toward more controllable and efficient generative AI.</p> </article> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2025 Yen-Lin Chen. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a>. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Last updated: June 27, 2025. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js"></script> <script defer src="/assets/js/common.js"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>