<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Neural Networks with Euclidean Symmetries - 2 | Yen-Lin Chen</title> <meta name="author" content="Yen-Lin Chen"> <meta name="description" content="Playing and benchmarking with E3NN (Continued)"> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://jipq6175.github.io/blog/2023/e3nn_2/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js"></script> <script src="/assets/js/dark_mode.js"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Yen-Lin </span>Chen</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">About</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">Blogs<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">Publications</a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">CV</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">Neural Networks with Euclidean Symmetries - 2</h1> <p class="post-meta">July 14, 2023</p> <p class="post-tags"> <a href="/blog/2023"> <i class="fas fa-calendar fa-sm"></i> 2023 </a>   ·   <a href="/blog/tag/coding"> <i class="fas fa-hashtag fa-sm"></i> coding</a>   <a href="/blog/tag/reading"> <i class="fas fa-hashtag fa-sm"></i> reading</a>   <a href="/blog/tag/solving"> <i class="fas fa-hashtag fa-sm"></i> solving</a>     ·   <a href="/blog/category/models"> <i class="fas fa-tag fa-sm"></i> models</a>   </p> </header> <article class="post-content"> <p>After playing with <code class="language-plaintext highlighter-rouge">e3nn</code> and a toy example with the tetris shape classification, I am going to move from the invariant model to equivariant model, which outputs type-1 (\(l=1\)) feature like 3D coordinates or even higher order tensors. This example is to predict the trajectories of the many-body dynamics, which is adopted from the <a href="https://dmol.pub/" rel="external nofollow noopener" target="_blank">dmol book</a> <a href="https://dmol.pub/applied/e3nn_traj.html" rel="external nofollow noopener" target="_blank">Ch. 19</a>.</p> <h1 id="2-trajectory-prediction">2. Trajectory Prediction</h1> <p>Given a position snapshot of a connected 12-body system at time \(t\), \(x(t)\), predict the positions of each particle at \(t+\Delta t\), i.e. \(x(t+\Delta t)\).</p> <p>The data can be found <a href="https://github.com/whitead/dmol-book/raw/main/data/paths.npz" rel="external nofollow noopener" target="_blank">here</a></p> <p>Let’s first take a look at the first frame, the second frame and later frames:</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/posts/e3nn/body12-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/posts/e3nn/body12-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/posts/e3nn/body12-1400.webp"></source> <img src="/assets/img/posts/e3nn/body12.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <p>Given a snapshot, our equivariant model can be trained to predict the coordinates of the next frame \(x(t+\Delta t)\) or the displacement \(\Delta x = x(t + \Delta t) - x(t)\). These two objectives might have different 3D distributions. The later turns out to be easier to model and we will focus on predicting the delta.</p> <h2 id="21-packages">2.1 Packages</h2> <p>Here we load the required packages and set up global parameters:</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1"># imports 
</span><span class="kn">import</span> <span class="n">torch</span><span class="p">,</span> <span class="n">e3nn</span><span class="p">,</span> <span class="n">urllib</span><span class="p">,</span> <span class="n">einops</span>

<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span> 
<span class="kn">import</span> <span class="n">torch_geometric</span> <span class="k">as</span> <span class="n">pyg</span>
<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="kn">from</span> <span class="n">torch_cluster</span> <span class="kn">import</span> <span class="n">radius_graph</span>
<span class="kn">from</span> <span class="n">torch_geometric.data</span> <span class="kn">import</span> <span class="n">Data</span>
<span class="kn">from</span> <span class="n">torch_geometric.loader</span> <span class="kn">import</span> <span class="n">DataLoader</span>
<span class="kn">from</span> <span class="n">torch_geometric.nn</span> <span class="kn">import</span> <span class="n">GATConv</span>
<span class="kn">from</span> <span class="n">torch_scatter</span> <span class="kn">import</span> <span class="n">scatter</span>

<span class="kn">from</span> <span class="n">tqdm.auto</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="n">sklearn.metrics</span> <span class="kn">import</span> <span class="n">r2_score</span>
<span class="kn">import</span> <span class="n">scipy.spatial.transform</span> <span class="k">as</span> <span class="n">trans</span>

<span class="kn">from</span> <span class="n">e3nn</span> <span class="kn">import</span> <span class="n">o3</span>
<span class="kn">from</span> <span class="n">e3nn.o3</span> <span class="kn">import</span> <span class="n">FullyConnectedTensorProduct</span>
<span class="kn">from</span> <span class="n">e3nn.nn.models.gate_points_2101</span> <span class="kn">import</span> <span class="n">Network</span>

<span class="k">if</span> <span class="n">torch</span><span class="p">.</span><span class="n">cuda</span><span class="p">.</span><span class="nf">is_available</span><span class="p">():</span> <span class="n">DEVICE</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">device</span><span class="p">(</span><span class="sh">'</span><span class="s">cuda</span><span class="sh">'</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span> <span class="n">DEVICE</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">device</span><span class="p">(</span><span class="sh">'</span><span class="s">mps</span><span class="sh">'</span><span class="p">)</span> <span class="k">if</span> <span class="n">torch</span><span class="p">.</span><span class="n">backends</span><span class="p">.</span><span class="n">mps</span><span class="p">.</span><span class="nf">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="n">torch</span><span class="p">.</span><span class="nf">device</span><span class="p">(</span><span class="sh">'</span><span class="s">cpu</span><span class="sh">'</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">Using device: </span><span class="si">{</span><span class="n">DEVICE</span><span class="si">}</span><span class="sh">'</span><span class="p">)</span></code></pre></figure> <p>Note that there are few functions in <code class="language-plaintext highlighter-rouge">torch_geometric</code> that are not compatible with Apple’s M1/M2 GPU, so if one is using <code class="language-plaintext highlighter-rouge">mps</code>, <code class="language-plaintext highlighter-rouge">e3nn</code> or functionalities in <code class="language-plaintext highlighter-rouge">torch_geometric</code> might raise low-level errors.</p> <h2 id="22-data">2.2 Data</h2> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1"># Retrieving data from trajectory
</span>
<span class="n">urllib</span><span class="p">.</span><span class="n">request</span><span class="p">.</span><span class="nf">urlretrieve</span><span class="p">(</span><span class="sh">"</span><span class="s">https://github.com/whitead/dmol-book/raw/main/data/paths.npz</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">paths.npz</span><span class="sh">"</span><span class="p">)</span>
<span class="n">paths</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="sh">'</span><span class="s">paths.npz</span><span class="sh">'</span><span class="p">)[</span><span class="sh">'</span><span class="s">arr</span><span class="sh">'</span><span class="p">]</span>

<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">path shape = </span><span class="sh">'</span><span class="p">,</span> <span class="n">paths</span><span class="p">.</span><span class="n">shape</span><span class="p">)</span> <span class="c1"># time stamp, particle, xy
</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">paths</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">paths</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">],</span> <span class="sh">'</span><span class="s">o-</span><span class="sh">'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">tab:blue</span><span class="sh">'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">'</span><span class="s">first frame</span><span class="sh">'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">paths</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">paths</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">],</span> <span class="sh">'</span><span class="s">o-</span><span class="sh">'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">tab:green</span><span class="sh">'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">'</span><span class="s">second frame</span><span class="sh">'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">paths</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">paths</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">],</span> <span class="sh">'</span><span class="s">o-</span><span class="sh">'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">tab:purple</span><span class="sh">'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">'</span><span class="s">third frame</span><span class="sh">'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">paths</span><span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">paths</span><span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">],</span> <span class="sh">'</span><span class="s">o-</span><span class="sh">'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">tab:red</span><span class="sh">'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sh">'</span><span class="s">tenth frame</span><span class="sh">'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span></code></pre></figure> <p>path shape = (2048, 12, 2)</p> <p>The path contains 2048 frames of 2D coordinates for 12 particles. The output plot was shown above.</p> <p>The data is the \(x(t)\) and the label is either \(x(t + \Delta t)\) or \(\Delta x\). We will arrange the path accordingly. Additionally, we will prepare the data with and without <code class="language-plaintext highlighter-rouge">shuffling</code> the data.</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1"># Process the data into datasets and dataloaders
</span><span class="k">def</span> <span class="nf">build_dataset</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span> 
    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">frame</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nf">zip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="n">data</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">pyg</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="nc">Data</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">pos</span><span class="o">=</span><span class="n">frame</span><span class="p">.</span><span class="nf">to</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">y</span><span class="o">=</span><span class="n">label</span><span class="p">.</span><span class="nf">to</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="n">float32</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">data</span>

<span class="c1"># make 3d trajectories
</span><span class="n">nt</span><span class="p">,</span> <span class="n">npoint</span><span class="p">,</span> <span class="n">__</span> <span class="o">=</span> <span class="n">paths</span><span class="p">.</span><span class="n">shape</span>
<span class="n">traj</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">concatenate</span><span class="p">((</span><span class="n">paths</span><span class="p">,</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">((</span><span class="n">nt</span><span class="p">,</span> <span class="n">npoint</span><span class="p">,</span> <span class="mi">1</span><span class="p">))),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># two types of data:
# 1. feature = x(t), label = x(t+1), prediction = label
# 2. feature = x(t), label = dx(t), prediction = x(t+1) = x(t) + dx(t)
</span><span class="n">features</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">from_numpy</span><span class="p">(</span><span class="n">traj</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]).</span><span class="nf">to</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="nb">float</span><span class="p">),</span> <span class="n">torch</span><span class="p">.</span><span class="nf">from_numpy</span><span class="p">(</span><span class="n">traj</span><span class="p">[</span><span class="mi">1</span><span class="p">:]).</span><span class="nf">to</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="nb">float</span><span class="p">)</span>
<span class="n">dx</span> <span class="o">=</span> <span class="n">labels</span> <span class="o">-</span> <span class="n">features</span>

<span class="c1"># training = 0:n, testing = n:2048, n = 1637
</span><span class="n">n</span> <span class="o">=</span> <span class="mi">1637</span>
<span class="n">pos_prediction_train_dataset</span> <span class="o">=</span> <span class="nf">build_dataset</span><span class="p">(</span><span class="n">features</span><span class="p">[:</span><span class="n">n</span><span class="p">],</span> <span class="n">labels</span><span class="p">[:</span><span class="n">n</span><span class="p">])</span>
<span class="n">pos_prediction_test_dataset</span> <span class="o">=</span> <span class="nf">build_dataset</span><span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="n">n</span><span class="p">:],</span> <span class="n">labels</span><span class="p">[</span><span class="n">n</span><span class="p">:])</span>

<span class="n">dx_prediction_train_dataset</span> <span class="o">=</span> <span class="nf">build_dataset</span><span class="p">(</span><span class="n">features</span><span class="p">[:</span><span class="n">n</span><span class="p">],</span> <span class="n">dx</span><span class="p">[:</span><span class="n">n</span><span class="p">])</span>
<span class="n">dx_prediction_test_dataset</span> <span class="o">=</span> <span class="nf">build_dataset</span><span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="n">n</span><span class="p">:],</span> <span class="n">dx</span><span class="p">[</span><span class="n">n</span><span class="p">:])</span>

<span class="c1"># data loaders: [pos, dx] x [shuffle or not] x [train, test]
</span><span class="n">BATCH_SIZE</span> <span class="o">=</span> <span class="mi">32</span>
<span class="n">dataloaders</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">({</span><span class="sh">'</span><span class="s">pos</span><span class="sh">'</span><span class="p">:</span> <span class="nf">dict</span><span class="p">(),</span> <span class="sh">'</span><span class="s">dx</span><span class="sh">'</span><span class="p">:</span> <span class="nf">dict</span><span class="p">()})</span>

<span class="n">dataloaders</span><span class="p">[</span><span class="sh">'</span><span class="s">pos</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">no_shuffle</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">({</span><span class="sh">'</span><span class="s">train</span><span class="sh">'</span><span class="p">:</span> <span class="nc">DataLoader</span><span class="p">(</span><span class="n">pos_prediction_train_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span> 
                                         <span class="sh">'</span><span class="s">test</span><span class="sh">'</span><span class="p">:</span> <span class="nc">DataLoader</span><span class="p">(</span><span class="n">pos_prediction_test_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">False</span><span class="p">)})</span>
<span class="n">dataloaders</span><span class="p">[</span><span class="sh">'</span><span class="s">pos</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">shuffle</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">({</span><span class="sh">'</span><span class="s">train</span><span class="sh">'</span><span class="p">:</span> <span class="nc">DataLoader</span><span class="p">(</span><span class="n">pos_prediction_train_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span> 
                                      <span class="sh">'</span><span class="s">test</span><span class="sh">'</span><span class="p">:</span> <span class="nc">DataLoader</span><span class="p">(</span><span class="n">pos_prediction_test_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">)})</span>

<span class="n">dataloaders</span><span class="p">[</span><span class="sh">'</span><span class="s">dx</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">no_shuffle</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">({</span><span class="sh">'</span><span class="s">train</span><span class="sh">'</span><span class="p">:</span> <span class="nc">DataLoader</span><span class="p">(</span><span class="n">dx_prediction_train_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span> 
                                        <span class="sh">'</span><span class="s">test</span><span class="sh">'</span><span class="p">:</span> <span class="nc">DataLoader</span><span class="p">(</span><span class="n">dx_prediction_test_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">False</span><span class="p">)})</span>
<span class="n">dataloaders</span><span class="p">[</span><span class="sh">'</span><span class="s">dx</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">shuffle</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">({</span><span class="sh">'</span><span class="s">train</span><span class="sh">'</span><span class="p">:</span> <span class="nc">DataLoader</span><span class="p">(</span><span class="n">dx_prediction_train_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span> 
                                     <span class="sh">'</span><span class="s">test</span><span class="sh">'</span><span class="p">:</span> <span class="nc">DataLoader</span><span class="p">(</span><span class="n">dx_prediction_test_dataset</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">)})</span></code></pre></figure> <p>Take a look at what the minibatch is like:</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="nf">print</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">dataloaders</span><span class="p">[</span><span class="sh">'</span><span class="s">pos</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">no_shuffle</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">train</span><span class="sh">'</span><span class="p">]))</span> <span class="c1"># 52
</span><span class="n">batch_data</span> <span class="o">=</span> <span class="nf">next</span><span class="p">(</span><span class="nf">iter</span><span class="p">(</span><span class="n">dataloaders</span><span class="p">[</span><span class="sh">'</span><span class="s">pos</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">no_shuffle</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">train</span><span class="sh">'</span><span class="p">]))</span>
<span class="nf">print</span><span class="p">(</span><span class="n">batch_data</span><span class="p">)</span>
<span class="c1"># DataBatch(y=[384, 3], pos=[384, 3], batch=[384], ptr=[33])
</span>
<span class="k">assert</span> <span class="n">torch</span><span class="p">.</span><span class="nf">allclose</span><span class="p">(</span><span class="n">batch_data</span><span class="p">.</span><span class="n">pos</span><span class="p">[</span><span class="mi">12</span><span class="p">:],</span> <span class="n">batch_data</span><span class="p">.</span><span class="n">y</span><span class="p">[:</span><span class="o">-</span><span class="mi">12</span><span class="p">])</span></code></pre></figure> <h2 id="23-baseline-models">2.3 Baseline Models</h2> <p>With the dataloaders at hand, we can start to build the models. First, we will construct 2 baseline models for comparisons. The first one is just the normal MLP and the second one is the GNN baseline using the equivariant features (to make it comparable with models later).</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1"># Baseline models: 
# 1. Just a MLP
# 2. GNN baseline
</span>
<span class="c1"># input = a set of 12 coordinates
# output = a set of 12 coordinates
</span>
<span class="n">loss_fn</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="nc">MSELoss</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">MLPBaseline</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="o">=</span><span class="mi">64</span><span class="p">):</span> 
        <span class="nf">super</span><span class="p">(</span><span class="n">MLPBaseline</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">__init__</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">dim</span> <span class="o">=</span> <span class="mi">36</span>
        <span class="n">self</span><span class="p">.</span><span class="n">hidden_dim</span> <span class="o">=</span> <span class="n">hidden_dim</span>
        <span class="n">self</span><span class="p">.</span><span class="n">mlp</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="nc">Sequential</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="nc">Linear</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">dim</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">hidden_dim</span><span class="p">),</span>
                                       <span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="nc">Linear</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">hidden_dim</span><span class="p">),</span>
                                       <span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="nc">Linear</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">dim</span><span class="p">))</span>
        
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span> 
        <span class="n">pos</span> <span class="o">=</span> <span class="n">einops</span><span class="p">.</span><span class="nf">rearrange</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">pos</span><span class="p">,</span> <span class="sh">'</span><span class="s">(t p) c -&gt; t (p c)</span><span class="sh">'</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">mlp</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">einops</span><span class="p">.</span><span class="nf">rearrange</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="sh">'</span><span class="s">t (p c) -&gt; (t p) c</span><span class="sh">'</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pos</span>

   
<span class="c1"># Using spherical harmonics as featurizer
</span><span class="k">class</span> <span class="nc">GNNBaseline</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span> 

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">dim_in</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">edge_dim</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">dim_out</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">heads</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span> 
        <span class="nf">super</span><span class="p">(</span><span class="n">GNNBaseline</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">__init__</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">dim_in</span> <span class="o">=</span> <span class="n">dim_in</span>
        <span class="n">self</span><span class="p">.</span><span class="n">edge_dim</span> <span class="o">=</span> <span class="n">edge_dim</span>
        <span class="n">self</span><span class="p">.</span><span class="n">hidden_dim</span> <span class="o">=</span> <span class="n">hidden_dim</span>
        <span class="n">self</span><span class="p">.</span><span class="n">dim_out</span> <span class="o">=</span> <span class="n">dim_out</span>
        <span class="n">self</span><span class="p">.</span><span class="n">heads</span> <span class="o">=</span> <span class="n">heads</span>

        <span class="n">self</span><span class="p">.</span><span class="n">irreps_sh</span> <span class="o">=</span> <span class="n">o3</span><span class="p">.</span><span class="n">Irreps</span><span class="p">.</span><span class="nf">spherical_harmonics</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">gat1</span> <span class="o">=</span> <span class="nc">GATConv</span><span class="p">(</span><span class="n">dim_in</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">,</span> <span class="n">edge_dim</span><span class="o">=</span><span class="n">edge_dim</span><span class="p">,</span> <span class="n">heads</span><span class="o">=</span><span class="n">heads</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">gat2</span> <span class="o">=</span> <span class="nc">GATConv</span><span class="p">(</span><span class="n">hidden_dim</span> <span class="o">*</span> <span class="n">heads</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">,</span> <span class="n">edge_dim</span><span class="o">=</span><span class="n">edge_dim</span><span class="p">,</span> <span class="n">heads</span><span class="o">=</span><span class="n">heads</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">head</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="nc">Sequential</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="nc">Linear</span><span class="p">(</span><span class="n">hidden_dim</span> <span class="o">*</span> <span class="n">heads</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">),</span>
                                        <span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="nc">GELU</span><span class="p">(),</span>
                                        <span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="nc">Linear</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">dim_out</span><span class="p">))</span>
        
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>

        <span class="n">num_neighbors</span> <span class="o">=</span> <span class="mi">6</span>
        <span class="n">num_nodes</span> <span class="o">=</span> <span class="mi">12</span>
        
        <span class="c1"># tensors of indices representing the graph, using fully connected
</span>        <span class="n">edge_index</span> <span class="o">=</span> <span class="nf">radius_graph</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">data</span><span class="p">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mf">2.5</span><span class="p">,</span> <span class="n">batch</span><span class="o">=</span><span class="n">data</span><span class="p">.</span><span class="n">batch</span><span class="p">)</span>
        <span class="n">edge_src</span><span class="p">,</span> <span class="n">edge_dst</span> <span class="o">=</span> <span class="n">edge_index</span>
        <span class="n">edge_vec</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">pos</span><span class="p">[</span><span class="n">edge_src</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">.</span><span class="n">pos</span><span class="p">[</span><span class="n">edge_dst</span><span class="p">]</span>
        
        <span class="n">edge_features</span> <span class="o">=</span> <span class="n">o3</span><span class="p">.</span><span class="nf">spherical_harmonics</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">irreps_sh</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">edge_vec</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">normalization</span><span class="o">=</span><span class="sh">'</span><span class="s">component</span><span class="sh">'</span><span class="p">)</span>
        <span class="n">node_features</span> <span class="o">=</span> <span class="nf">scatter</span><span class="p">(</span><span class="n">edge_features</span><span class="p">,</span> <span class="n">edge_dst</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">).</span><span class="nf">div</span><span class="p">(</span><span class="n">num_neighbors</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span>

        <span class="c1"># GNN message passing
</span>        <span class="n">x</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">gat1</span><span class="p">(</span><span class="n">node_features</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">,</span> <span class="n">edge_attr</span><span class="o">=</span><span class="n">edge_features</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">gat2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">,</span> <span class="n">edge_attr</span><span class="o">=</span><span class="n">edge_features</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="nf">head</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></code></pre></figure> <p>Let’s try to feed in one minibatch.</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">mlpbase</span> <span class="o">=</span> <span class="nc">MLPBaseline</span><span class="p">()</span>
<span class="n">pred</span> <span class="o">=</span> <span class="nf">mlpbase</span><span class="p">(</span><span class="n">batch_data</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">pred</span><span class="p">.</span><span class="n">shape</span><span class="p">)</span> <span class="c1"># torch.Size([384, 3])
</span><span class="nf">print</span><span class="p">(</span><span class="nf">loss_fn</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">batch_data</span><span class="p">.</span><span class="n">y</span><span class="p">))</span> <span class="c1"># tensor(253.8258, grad_fn=&lt;MseLossBackward0&gt;)
</span>
<span class="n">gnnbase</span> <span class="o">=</span> <span class="nc">GNNBaseline</span><span class="p">()</span>
<span class="n">pred</span> <span class="o">=</span> <span class="nf">gnnbase</span><span class="p">(</span><span class="n">batch_data</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">pred</span><span class="p">.</span><span class="n">shape</span><span class="p">)</span> <span class="c1"># torch.Size([384, 3])
</span><span class="nf">print</span><span class="p">(</span><span class="nf">loss_fn</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">batch_data</span><span class="p">.</span><span class="n">y</span><span class="p">))</span> <span class="c1"># tensor(244.7130, grad_fn=&lt;MseLossBackward0&gt;)</span></code></pre></figure> <p>We need some helper functions for model training, evaluations and visualizations. These functions are straightforward.</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1"># general training function 
</span><span class="n">EPOCHS</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">LR</span> <span class="o">=</span> <span class="mf">1e-3</span>

<span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">trainloader</span><span class="p">,</span> <span class="n">testloader</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">EPOCHS</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="n">LR</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="sh">'</span><span class="s">Adam</span><span class="sh">'</span><span class="p">):</span> 

    <span class="n">model</span><span class="p">.</span><span class="nf">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
    <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">optim</span><span class="p">.</span><span class="nc">Adam</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="nf">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">)</span> <span class="k">if</span> <span class="n">opt</span> <span class="o">==</span> <span class="sh">'</span><span class="s">Adam</span><span class="sh">'</span> <span class="k">else</span> <span class="n">torch</span><span class="p">.</span><span class="n">optim</span><span class="p">.</span><span class="nc">AdamW</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="nf">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">)</span>
    <span class="n">loss_fn</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="nc">MSELoss</span><span class="p">()</span>

    <span class="n">every_n</span> <span class="o">=</span> <span class="n">epochs</span> <span class="o">//</span> <span class="mi">100</span>
    <span class="n">logs</span> <span class="o">=</span> <span class="nf">dict</span><span class="p">({</span><span class="sh">'</span><span class="s">train_loss</span><span class="sh">'</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="n">epochs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="sh">'</span><span class="s">test_loss</span><span class="sh">'</span><span class="p">:</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="n">epochs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)})</span>
    <span class="n">pbar</span> <span class="o">=</span> <span class="nf">tqdm</span><span class="p">(</span><span class="nf">range</span><span class="p">(</span><span class="n">epochs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">pbar</span><span class="p">:</span> 
        
        <span class="n">train_loss</span><span class="p">,</span> <span class="n">test_loss</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="c1"># training: 
</span>        <span class="n">model</span><span class="p">.</span><span class="nf">train</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">trainloader</span><span class="p">:</span> 
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="nf">model</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="nf">loss_fn</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="n">y</span><span class="p">)</span>

            <span class="n">optimizer</span><span class="p">.</span><span class="nf">zero_grad</span><span class="p">()</span>
            <span class="n">loss</span><span class="p">.</span><span class="nf">backward</span><span class="p">()</span>
            <span class="n">optimizer</span><span class="p">.</span><span class="nf">step</span><span class="p">()</span>

            <span class="n">train_loss</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">loss</span><span class="p">.</span><span class="nf">item</span><span class="p">())</span>
        
        <span class="n">logs</span><span class="p">[</span><span class="sh">'</span><span class="s">train_loss</span><span class="sh">'</span><span class="p">][</span><span class="n">step</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">train_loss</span><span class="p">).</span><span class="nf">mean</span><span class="p">()</span>

        <span class="c1"># testing: 
</span>        <span class="n">model</span><span class="p">.</span><span class="nf">eval</span><span class="p">()</span>
        <span class="k">with</span> <span class="n">torch</span><span class="p">.</span><span class="nf">no_grad</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">testloader</span><span class="p">:</span> 
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
                <span class="n">pred</span> <span class="o">=</span> <span class="nf">model</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">loss</span> <span class="o">=</span> <span class="nf">loss_fn</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="n">y</span><span class="p">)</span>
                <span class="n">test_loss</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">loss</span><span class="p">.</span><span class="nf">item</span><span class="p">())</span>
        
        <span class="n">logs</span><span class="p">[</span><span class="sh">'</span><span class="s">test_loss</span><span class="sh">'</span><span class="p">][</span><span class="n">step</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">test_loss</span><span class="p">).</span><span class="nf">mean</span><span class="p">()</span>

        <span class="n">trainl</span><span class="p">,</span> <span class="n">testl</span> <span class="o">=</span> <span class="n">logs</span><span class="p">[</span><span class="sh">'</span><span class="s">train_loss</span><span class="sh">'</span><span class="p">][</span><span class="n">step</span><span class="p">],</span> <span class="n">logs</span><span class="p">[</span><span class="sh">'</span><span class="s">test_loss</span><span class="sh">'</span><span class="p">][</span><span class="n">step</span><span class="p">]</span>
        <span class="n">s</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">'</span><span class="s">epoch </span><span class="si">{</span><span class="n">step</span><span class="si">:</span><span class="mi">5</span><span class="n">d</span><span class="si">}</span><span class="s"> | Train MSE </span><span class="si">{</span><span class="n">trainl</span><span class="si">:</span><span class="o">&lt;</span><span class="mf">10.5</span><span class="n">f</span><span class="si">}</span><span class="s"> | Test MSE </span><span class="si">{</span><span class="n">testl</span><span class="si">:</span><span class="o">&lt;</span><span class="mf">10.5</span><span class="n">f</span><span class="si">}</span><span class="sh">'</span>
        <span class="k">if</span> <span class="n">step</span> <span class="o">%</span> <span class="n">every_n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="n">pbar</span><span class="p">.</span><span class="nf">set_description</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">logs</span>


<span class="c1"># get forward pass for all testing set 
</span><span class="k">def</span> <span class="nf">forward_pass</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span> 
    <span class="n">model</span><span class="p">.</span><span class="nf">eval</span><span class="p">()</span>
    <span class="n">device</span> <span class="o">=</span> <span class="nf">next</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="nf">parameters</span><span class="p">()).</span><span class="n">device</span>
    <span class="n">pbar</span> <span class="o">=</span> <span class="nf">tqdm</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">torch</span><span class="p">.</span><span class="nf">no_grad</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">delta</span><span class="p">:</span> 
            <span class="n">pred</span> <span class="o">=</span> <span class="p">[(</span><span class="n">data</span><span class="p">.</span><span class="n">pos</span><span class="p">.</span><span class="nf">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span> <span class="o">+</span> <span class="nf">model</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">to</span><span class="p">(</span><span class="n">device</span><span class="p">))).</span><span class="nf">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">pbar</span><span class="p">]</span>
            <span class="n">truth</span> <span class="o">=</span> <span class="p">[(</span><span class="n">data</span><span class="p">.</span><span class="n">pos</span> <span class="o">+</span> <span class="n">data</span><span class="p">.</span><span class="n">y</span><span class="p">).</span><span class="nf">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">pbar</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">pred</span> <span class="o">=</span> <span class="p">[</span><span class="nf">model</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="nf">to</span><span class="p">(</span><span class="n">device</span><span class="p">)).</span><span class="nf">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">pbar</span><span class="p">]</span>
            <span class="n">truth</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">.</span><span class="n">y</span><span class="p">.</span><span class="nf">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">torch</span><span class="p">.</span><span class="nf">concat</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">).</span><span class="nf">cpu</span><span class="p">(),</span> <span class="n">torch</span><span class="p">.</span><span class="nf">concat</span><span class="p">(</span><span class="n">truth</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">).</span><span class="nf">cpu</span><span class="p">()</span>


<span class="c1"># show correlations of center of mass, first particle center of mass, 7th particle x coord, last particle y coord
</span><span class="k">def</span> <span class="nf">show_correlation</span><span class="p">(</span><span class="n">y_hat</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span> 
    <span class="k">assert</span> <span class="n">y_hat</span><span class="p">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">y</span><span class="p">.</span><span class="n">shape</span>
    <span class="n">y_hat_cm</span><span class="p">,</span> <span class="n">y_cm</span> <span class="o">=</span> <span class="n">y_hat</span><span class="p">.</span><span class="nf">mean</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">y</span><span class="p">.</span><span class="nf">mean</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">y_hat_cmm</span><span class="p">,</span> <span class="n">y_cmm</span> <span class="o">=</span> <span class="n">y_hat</span><span class="p">.</span><span class="nf">mean</span><span class="p">((</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)),</span> <span class="n">y</span><span class="p">.</span><span class="nf">mean</span><span class="p">((</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>

    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">plot</span><span class="p">(</span><span class="n">y_cmm</span><span class="p">,</span> <span class="n">y_cmm</span><span class="p">,</span> <span class="sh">'</span><span class="s">-</span><span class="sh">'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">black</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">plot</span><span class="p">(</span><span class="n">y_cmm</span><span class="p">,</span> <span class="n">y_hat_cmm</span><span class="p">,</span> <span class="sh">'</span><span class="s">.</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">COM, rsq = </span><span class="si">{</span><span class="nf">r2_score</span><span class="p">(</span><span class="n">y_cmm</span><span class="p">,</span> <span class="n">y_hat_cmm</span><span class="p">)</span><span class="si">:</span> <span class="p">.</span><span class="mi">3</span><span class="n">f</span><span class="si">}</span><span class="sh">'</span><span class="p">)</span>

    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">plot</span><span class="p">(</span><span class="n">y_cm</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y_cm</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="sh">'</span><span class="s">-</span><span class="sh">'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">black</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">plot</span><span class="p">(</span><span class="n">y_cm</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y_hat_cm</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="sh">'</span><span class="s">.</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">First COM, rsq = </span><span class="si">{</span><span class="n">r2_score</span><span class="p">(</span><span class="n">y_cm</span><span class="p">[</span><span class="si">:</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y_hat_cm</span><span class="p">[</span><span class="si">:</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span><span class="si">:</span> <span class="p">.</span><span class="mi">3</span><span class="n">f</span><span class="si">}</span><span class="sh">'</span><span class="p">)</span>

    <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nf">plot</span><span class="p">(</span><span class="n">y</span><span class="p">[:,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="p">[:,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="sh">'</span><span class="s">-</span><span class="sh">'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">black</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nf">plot</span><span class="p">(</span><span class="n">y</span><span class="p">[:,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y_hat</span><span class="p">[:,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="sh">'</span><span class="s">.</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">7th x, rsq = </span><span class="si">{</span><span class="n">r2_score</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="si">:</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y_hat</span><span class="p">[</span><span class="si">:</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span><span class="si">:</span> <span class="p">.</span><span class="mi">3</span><span class="n">f</span><span class="si">}</span><span class="sh">'</span><span class="p">)</span>

    <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="nf">plot</span><span class="p">(</span><span class="n">y</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">y</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="sh">'</span><span class="s">-</span><span class="sh">'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="sh">'</span><span class="s">black</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="nf">plot</span><span class="p">(</span><span class="n">y</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">y_hat</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="sh">'</span><span class="s">.</span><span class="sh">'</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">3</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">last y, rsq = </span><span class="si">{</span><span class="n">r2_score</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="si">:</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">y_hat</span><span class="p">[</span><span class="si">:</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span><span class="si">:</span> <span class="p">.</span><span class="mi">3</span><span class="n">f</span><span class="si">}</span><span class="sh">'</span><span class="p">)</span>

    <span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>


<span class="c1"># show and compare trajectories
</span><span class="k">def</span> <span class="nf">compare_trajectories</span><span class="p">(</span><span class="n">y_hat</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mi">25</span><span class="p">):</span> 
    <span class="k">assert</span> <span class="n">y_hat</span><span class="p">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">y</span><span class="p">.</span><span class="n">shape</span>
    <span class="n">nt</span> <span class="o">=</span> <span class="n">y</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">squeeze</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">"</span><span class="s">Trajectory</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">set_title</span><span class="p">(</span><span class="sh">"</span><span class="s">Predicted Trajectory</span><span class="sh">"</span><span class="p">)</span>

    <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="nf">get_cmap</span><span class="p">(</span><span class="sh">"</span><span class="s">coolwarm</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nt</span><span class="p">,</span> <span class="n">interval</span><span class="p">):</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">plot</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">],</span> <span class="sh">"</span><span class="s">.-</span><span class="sh">"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="nf">cmap</span><span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="n">nt</span><span class="p">))</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">plot</span><span class="p">(</span><span class="n">y_hat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y_hat</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">],</span> <span class="sh">"</span><span class="s">.-</span><span class="sh">"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="nf">cmap</span><span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="n">nt</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nf">set_xticks</span><span class="p">([])</span>
        <span class="n">axes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nf">set_yticks</span><span class="p">([])</span>

    <span class="n">plt</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span></code></pre></figure> <p>For each model, we will train it, evaluate the trained model using testing data and visualize the testing trajectories. For evaluation, we select correlations of center of mass, first particle center of mass, 7th particle x coordinate, last particle y coordinate. Therefore, we will be able to see the small variations in a more granular way.</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1"># test training 
</span>
<span class="n">epochs</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">mlpbase</span><span class="p">,</span> <span class="n">mlpbase_logs</span> <span class="o">=</span> <span class="nf">train</span><span class="p">(</span><span class="nc">MLPBaseline</span><span class="p">(),</span> <span class="n">dataloaders</span><span class="p">[</span><span class="sh">'</span><span class="s">dx</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">no_shuffle</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">train</span><span class="sh">'</span><span class="p">],</span> <span class="n">dataloaders</span><span class="p">[</span><span class="sh">'</span><span class="s">dx</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">no_shuffle</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">test</span><span class="sh">'</span><span class="p">],</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">)</span>
<span class="n">gnnbase</span><span class="p">,</span> <span class="n">gnnbase_logs</span> <span class="o">=</span> <span class="nf">train</span><span class="p">(</span><span class="nc">GNNBaseline</span><span class="p">(),</span> <span class="n">dataloaders</span><span class="p">[</span><span class="sh">'</span><span class="s">dx</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">no_shuffle</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">train</span><span class="sh">'</span><span class="p">],</span> <span class="n">dataloaders</span><span class="p">[</span><span class="sh">'</span><span class="s">dx</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">no_shuffle</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">test</span><span class="sh">'</span><span class="p">],</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">)</span>

<span class="n">mlp_y_hat</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nf">forward_pass</span><span class="p">(</span><span class="n">mlpbase</span><span class="p">,</span> <span class="n">dx_prediction_test_dataset</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="nf">show_correlation</span><span class="p">(</span><span class="n">mlp_y_hat</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="nf">compare_trajectories</span><span class="p">(</span><span class="n">mlp_y_hat</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="n">gnn_y_hat</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="nf">forward_pass</span><span class="p">(</span><span class="n">gnnbase</span><span class="p">,</span> <span class="n">dx_prediction_test_dataset</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">torch</span><span class="p">.</span><span class="nf">allclose</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span>
<span class="nf">show_correlation</span><span class="p">(</span><span class="n">gnn_y_hat</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="nf">compare_trajectories</span><span class="p">(</span><span class="n">gnn_y_hat</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span></code></pre></figure> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">epoch</span>  <span class="mi">1000</span> <span class="o">|</span> <span class="n">Train</span> <span class="n">MSE</span> <span class="mf">0.00003</span>    <span class="o">|</span> <span class="n">Test</span> <span class="n">MSE</span> <span class="mf">0.00003</span>   <span class="p">:</span> <span class="mi">100</span><span class="o">%|</span><span class="err">██████████</span><span class="o">|</span> <span class="mi">1001</span><span class="o">/</span><span class="mi">1001</span> <span class="p">[</span><span class="mi">01</span><span class="p">:</span><span class="mi">31</span><span class="o">&lt;</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mf">10.90</span><span class="n">it</span><span class="o">/</span><span class="n">s</span><span class="p">]</span>
<span class="n">epoch</span>  <span class="mi">1000</span> <span class="o">|</span> <span class="n">Train</span> <span class="n">MSE</span> <span class="mf">0.00002</span>    <span class="o">|</span> <span class="n">Test</span> <span class="n">MSE</span> <span class="mf">0.00003</span>   <span class="p">:</span> <span class="mi">100</span><span class="o">%|</span><span class="err">██████████</span><span class="o">|</span> <span class="mi">1001</span><span class="o">/</span><span class="mi">1001</span> <span class="p">[</span><span class="mi">05</span><span class="p">:</span><span class="mi">21</span><span class="o">&lt;</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span>  <span class="mf">3.11</span><span class="n">it</span><span class="o">/</span><span class="n">s</span><span class="p">]</span>
<span class="mi">100</span><span class="o">%|</span><span class="err">██████████</span><span class="o">|</span> <span class="mi">410</span><span class="o">/</span><span class="mi">410</span> <span class="p">[</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="o">&lt;</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mf">5012.90</span><span class="n">it</span><span class="o">/</span><span class="n">s</span><span class="p">]</span>
<span class="mi">100</span><span class="o">%|</span><span class="err">██████████</span><span class="o">|</span> <span class="mi">410</span><span class="o">/</span><span class="mi">410</span> <span class="p">[</span><span class="mi">00</span><span class="p">:</span><span class="mi">01</span><span class="o">&lt;</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mf">393.63</span><span class="n">it</span><span class="o">/</span><span class="n">s</span><span class="p">]</span></code></pre></figure> <p>For MLP no shuffle:</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/posts/e3nn/mlpcorr-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/posts/e3nn/mlpcorr-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/posts/e3nn/mlpcorr-1400.webp"></source> <img src="/assets/img/posts/e3nn/mlpcorr.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/posts/e3nn/mlptraj-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/posts/e3nn/mlptraj-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/posts/e3nn/mlptraj-1400.webp"></source> <img src="/assets/img/posts/e3nn/mlptraj.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <p>For GNN no shuffle:</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/posts/e3nn/gnncorr-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/posts/e3nn/gnncorr-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/posts/e3nn/gnncorr-1400.webp"></source> <img src="/assets/img/posts/e3nn/gnncorr.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/posts/e3nn/gnntraj-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/posts/e3nn/gnntraj-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/posts/e3nn/gnntraj-1400.webp"></source> <img src="/assets/img/posts/e3nn/gnntraj.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <p>The baseline models have already good performances, which might be coming from the ordering of the data. Let’s try it again with shuffled dataloader.</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">epochs</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">mlpbase_sh</span><span class="p">,</span> <span class="n">mlpbase_sh_logs</span> <span class="o">=</span> <span class="nf">train</span><span class="p">(</span><span class="nc">MLPBaseline</span><span class="p">(),</span> <span class="n">dataloaders</span><span class="p">[</span><span class="sh">'</span><span class="s">dx</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">shuffle</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">train</span><span class="sh">'</span><span class="p">],</span> <span class="n">dataloaders</span><span class="p">[</span><span class="sh">'</span><span class="s">dx</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">shuffle</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">test</span><span class="sh">'</span><span class="p">],</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">)</span>
<span class="n">gnnbase_sh</span><span class="p">,</span> <span class="n">gnnbase_sh_logs</span> <span class="o">=</span> <span class="nf">train</span><span class="p">(</span><span class="nc">GNNBaseline</span><span class="p">(),</span> <span class="n">dataloaders</span><span class="p">[</span><span class="sh">'</span><span class="s">dx</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">shuffle</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">train</span><span class="sh">'</span><span class="p">],</span> <span class="n">dataloaders</span><span class="p">[</span><span class="sh">'</span><span class="s">dx</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">shuffle</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">test</span><span class="sh">'</span><span class="p">],</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">)</span>

<span class="n">mlp_y_hat</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nf">forward_pass</span><span class="p">(</span><span class="n">mlpbase_sh</span><span class="p">,</span> <span class="n">dx_prediction_test_dataset</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="nf">show_correlation</span><span class="p">(</span><span class="n">mlp_y_hat</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="nf">compare_trajectories</span><span class="p">(</span><span class="n">mlp_y_hat</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="n">gnn_y_hat</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="nf">forward_pass</span><span class="p">(</span><span class="n">gnnbase_sh</span><span class="p">,</span> <span class="n">dx_prediction_test_dataset</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">torch</span><span class="p">.</span><span class="nf">allclose</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span>
<span class="nf">show_correlation</span><span class="p">(</span><span class="n">gnn_y_hat</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="nf">compare_trajectories</span><span class="p">(</span><span class="n">gnn_y_hat</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span></code></pre></figure> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">epoch</span>  <span class="mi">1000</span> <span class="o">|</span> <span class="n">Train</span> <span class="n">MSE</span> <span class="mf">0.00002</span>    <span class="o">|</span> <span class="n">Test</span> <span class="n">MSE</span> <span class="mf">0.00004</span>   <span class="p">:</span> <span class="mi">100</span><span class="o">%|</span><span class="err">██████████</span><span class="o">|</span> <span class="mi">1001</span><span class="o">/</span><span class="mi">1001</span> <span class="p">[</span><span class="mi">01</span><span class="p">:</span><span class="mi">35</span><span class="o">&lt;</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mf">10.48</span><span class="n">it</span><span class="o">/</span><span class="n">s</span><span class="p">]</span>
<span class="n">epoch</span>  <span class="mi">1000</span> <span class="o">|</span> <span class="n">Train</span> <span class="n">MSE</span> <span class="mf">0.00002</span>    <span class="o">|</span> <span class="n">Test</span> <span class="n">MSE</span> <span class="mf">0.00003</span>   <span class="p">:</span> <span class="mi">100</span><span class="o">%|</span><span class="err">██████████</span><span class="o">|</span> <span class="mi">1001</span><span class="o">/</span><span class="mi">1001</span> <span class="p">[</span><span class="mi">05</span><span class="p">:</span><span class="mi">34</span><span class="o">&lt;</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span>  <span class="mf">2.99</span><span class="n">it</span><span class="o">/</span><span class="n">s</span><span class="p">]</span>
<span class="mi">100</span><span class="o">%|</span><span class="err">██████████</span><span class="o">|</span> <span class="mi">410</span><span class="o">/</span><span class="mi">410</span> <span class="p">[</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="o">&lt;</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mf">7180.50</span><span class="n">it</span><span class="o">/</span><span class="n">s</span><span class="p">]</span>
<span class="mi">100</span><span class="o">%|</span><span class="err">██████████</span><span class="o">|</span> <span class="mi">410</span><span class="o">/</span><span class="mi">410</span> <span class="p">[</span><span class="mi">00</span><span class="p">:</span><span class="mi">01</span><span class="o">&lt;</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mf">389.29</span><span class="n">it</span><span class="o">/</span><span class="n">s</span><span class="p">]</span></code></pre></figure> <p>For MLP shuffle:</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/posts/e3nn/mlpshcorr-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/posts/e3nn/mlpshcorr-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/posts/e3nn/mlpshcorr-1400.webp"></source> <img src="/assets/img/posts/e3nn/mlpshcorr.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/posts/e3nn/mlpshtraj-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/posts/e3nn/mlpshtraj-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/posts/e3nn/mlpshtraj-1400.webp"></source> <img src="/assets/img/posts/e3nn/mlpshtraj.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <p>For GNN shuffle:</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/posts/e3nn/gnnshcorr-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/posts/e3nn/gnnshcorr-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/posts/e3nn/gnnshcorr-1400.webp"></source> <img src="/assets/img/posts/e3nn/gnnshcorr.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/posts/e3nn/gnnshtraj-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/posts/e3nn/gnnshtraj-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/posts/e3nn/gnnshtraj-1400.webp"></source> <img src="/assets/img/posts/e3nn/gnnshtraj.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <h2 id="24-e3nn-models">2.4 E3NN Models</h2> <p>Let’s try to build the equivariant model from <code class="language-plaintext highlighter-rouge">e3nn</code> and see if the models can achieve better predictions.</p> <p>We will recycle the model from the Tetris example except the final aggregation operation for the <code class="language-plaintext highlighter-rouge">e3nn_small</code> model. Similarly, we recycle the <code class="language-plaintext highlighter-rouge">Network</code> as the <code class="language-plaintext highlighter-rouge">e3nn_large</code> model. Explicitly:</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1"># E3NN
</span><span class="k">class</span> <span class="nc">EquivariantPolynomial</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="mf">3.5</span><span class="p">):</span>
        <span class="nf">super</span><span class="p">(</span><span class="n">EquivariantPolynomial</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">__init__</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">r</span>
        <span class="n">self</span><span class="p">.</span><span class="n">irreps_sh</span> <span class="o">=</span> <span class="n">o3</span><span class="p">.</span><span class="n">Irreps</span><span class="p">.</span><span class="nf">spherical_harmonics</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> 
        <span class="n">irreps_mid</span> <span class="o">=</span> <span class="n">o3</span><span class="p">.</span><span class="nc">Irreps</span><span class="p">(</span><span class="sh">'</span><span class="s">8x0e + 8x0o + 16x1e + 16x1o + 8x2e + 8x2o</span><span class="sh">'</span><span class="p">)</span> <span class="c1"># add l = 3 to the hidden irreps
</span>        <span class="n">irreps_out</span> <span class="o">=</span> <span class="n">o3</span><span class="p">.</span><span class="nc">Irreps</span><span class="p">(</span><span class="sh">'</span><span class="s">1x1o</span><span class="sh">'</span><span class="p">)</span> <span class="c1"># each particle outputs a vector (1x1o)
</span>
        <span class="n">self</span><span class="p">.</span><span class="n">tp1</span> <span class="o">=</span> <span class="nc">FullyConnectedTensorProduct</span><span class="p">(</span><span class="n">irreps_in1</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">irreps_sh</span><span class="p">,</span> 
                                               <span class="n">irreps_in2</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">irreps_sh</span><span class="p">,</span>
                                               <span class="n">irreps_out</span><span class="o">=</span><span class="n">irreps_mid</span><span class="p">)</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">tp2</span> <span class="o">=</span> <span class="nc">FullyConnectedTensorProduct</span><span class="p">(</span><span class="n">irreps_in1</span><span class="o">=</span><span class="n">irreps_mid</span><span class="p">,</span>
                                               <span class="n">irreps_in2</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">irreps_sh</span><span class="p">,</span>
                                               <span class="n">irreps_out</span><span class="o">=</span><span class="n">irreps_out</span><span class="p">)</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">irreps_out</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">tp2</span><span class="p">.</span><span class="n">irreps_out</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">num_neighbors</span> <span class="o">=</span> <span class="mi">11</span>
        <span class="n">num_nodes</span> <span class="o">=</span> <span class="mi">12</span>
        
        <span class="c1"># tensors of indices representing the graph
</span>        <span class="n">edge_src</span><span class="p">,</span> <span class="n">edge_dst</span> <span class="o">=</span> <span class="nf">radius_graph</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">data</span><span class="p">.</span><span class="n">pos</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">r</span><span class="p">,</span> <span class="n">batch</span><span class="o">=</span><span class="n">data</span><span class="p">.</span><span class="n">batch</span><span class="p">)</span>
        <span class="n">edge_vec</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">pos</span><span class="p">[</span><span class="n">edge_src</span><span class="p">]</span> <span class="o">-</span> <span class="n">data</span><span class="p">.</span><span class="n">pos</span><span class="p">[</span><span class="n">edge_dst</span><span class="p">]</span>
        <span class="n">edge_sh</span> <span class="o">=</span> <span class="n">o3</span><span class="p">.</span><span class="nf">spherical_harmonics</span><span class="p">(</span><span class="n">l</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">irreps_sh</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">edge_vec</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">normalization</span><span class="o">=</span><span class="sh">'</span><span class="s">component</span><span class="sh">'</span><span class="p">)</span>
    
        <span class="c1"># For each node, the initial features are the sum of the spherical harmonics of the neighbors
</span>        <span class="n">node_features</span> <span class="o">=</span> <span class="nf">scatter</span><span class="p">(</span><span class="n">edge_sh</span><span class="p">,</span> <span class="n">edge_dst</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">).</span><span class="nf">div</span><span class="p">(</span><span class="n">num_neighbors</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span>

        <span class="c1"># For each edge, tensor product the features on the source node with the spherical harmonics
</span>        <span class="n">edge_features</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">tp1</span><span class="p">(</span><span class="n">node_features</span><span class="p">[</span><span class="n">edge_src</span><span class="p">],</span> <span class="n">edge_sh</span><span class="p">)</span>
        <span class="n">node_features</span> <span class="o">=</span> <span class="nf">scatter</span><span class="p">(</span><span class="n">edge_features</span><span class="p">,</span> <span class="n">edge_dst</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">).</span><span class="nf">div</span><span class="p">(</span><span class="n">num_neighbors</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span>

        <span class="n">edge_features</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">tp2</span><span class="p">(</span><span class="n">node_features</span><span class="p">[</span><span class="n">edge_src</span><span class="p">],</span> <span class="n">edge_sh</span><span class="p">)</span>
        <span class="c1"># node_features = scatter(edge_features, edge_dst, dim=0).div(num_neighbors**0.5)
</span>        <span class="n">node_features</span> <span class="o">=</span> <span class="nf">scatter</span><span class="p">(</span><span class="n">edge_features</span><span class="p">,</span> <span class="n">edge_dst</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">reduce</span><span class="o">=</span><span class="sh">'</span><span class="s">mean</span><span class="sh">'</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">node_features</span>
    

<span class="n">model_kwargs</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sh">"</span><span class="s">irreps_in</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> 
    <span class="sh">"</span><span class="s">irreps_hidden</span><span class="sh">"</span><span class="p">:</span> <span class="n">e3nn</span><span class="p">.</span><span class="n">o3</span><span class="p">.</span><span class="nc">Irreps</span><span class="p">(</span><span class="sh">'</span><span class="s">8x0e + 8x0o + 16x1e + 16x1o + 8x2e + 8x2o</span><span class="sh">'</span><span class="p">),</span>  <span class="c1"># hyperparameter
</span>    <span class="sh">"</span><span class="s">irreps_out</span><span class="sh">"</span><span class="p">:</span> <span class="sh">"</span><span class="s">1x1o</span><span class="sh">"</span><span class="p">,</span>  <span class="c1"># 12 vectors out, but only 1 vector out per input
</span>    <span class="sh">"</span><span class="s">irreps_node_attr</span><span class="sh">"</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">irreps_edge_attr</span><span class="sh">"</span><span class="p">:</span> <span class="n">e3nn</span><span class="p">.</span><span class="n">o3</span><span class="p">.</span><span class="n">Irreps</span><span class="p">.</span><span class="nf">spherical_harmonics</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
    <span class="sh">"</span><span class="s">layers</span><span class="sh">"</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> 
    <span class="sh">"</span><span class="s">max_radius</span><span class="sh">"</span><span class="p">:</span> <span class="mf">3.5</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">number_of_basis</span><span class="sh">"</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">radial_layers</span><span class="sh">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">radial_neurons</span><span class="sh">"</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">num_neighbors</span><span class="sh">"</span><span class="p">:</span> <span class="mi">11</span><span class="p">,</span>  
    <span class="sh">"</span><span class="s">num_nodes</span><span class="sh">"</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span> 
    <span class="sh">"</span><span class="s">reduce_output</span><span class="sh">"</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>  <span class="c1"># setting this to true would give us one scalar as an output.
</span><span class="p">}</span></code></pre></figure> <p>After defining these models, let go ahead to reuse the training codes.</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1"># test training 
</span>
<span class="n">epochs</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">lr</span> <span class="o">=</span> <span class="mf">1e-3</span>
<span class="n">e3nn_small</span><span class="p">,</span> <span class="n">e3nn_small_logs</span> <span class="o">=</span> <span class="nf">train</span><span class="p">(</span><span class="nc">EquivariantPolynomial</span><span class="p">(),</span> <span class="n">dataloaders</span><span class="p">[</span><span class="sh">'</span><span class="s">dx</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">no_shuffle</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">train</span><span class="sh">'</span><span class="p">],</span> <span class="n">dataloaders</span><span class="p">[</span><span class="sh">'</span><span class="s">dx</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">no_shuffle</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">test</span><span class="sh">'</span><span class="p">],</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">)</span>
<span class="n">e3nn_large</span><span class="p">,</span> <span class="n">e3nn_large_logs</span> <span class="o">=</span> <span class="nf">train</span><span class="p">(</span><span class="nc">Network</span><span class="p">(</span><span class="o">**</span><span class="n">model_kwargs</span><span class="p">),</span> <span class="n">dataloaders</span><span class="p">[</span><span class="sh">'</span><span class="s">dx</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">no_shuffle</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">train</span><span class="sh">'</span><span class="p">],</span> <span class="n">dataloaders</span><span class="p">[</span><span class="sh">'</span><span class="s">dx</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">no_shuffle</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">test</span><span class="sh">'</span><span class="p">],</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">)</span>

<span class="n">e3nn_small_y_hat</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nf">forward_pass</span><span class="p">(</span><span class="n">e3nn_small</span><span class="p">,</span> <span class="n">dx_prediction_test_dataset</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="nf">show_correlation</span><span class="p">(</span><span class="n">e3nn_small_y_hat</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="nf">compare_trajectories</span><span class="p">(</span><span class="n">e3nn_small_y_hat</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="n">e3nn_large_y_hat</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="nf">forward_pass</span><span class="p">(</span><span class="n">e3nn_large</span><span class="p">,</span> <span class="n">dx_prediction_test_dataset</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">torch</span><span class="p">.</span><span class="nf">allclose</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span>
<span class="nf">show_correlation</span><span class="p">(</span><span class="n">e3nn_large_y_hat</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="nf">compare_trajectories</span><span class="p">(</span><span class="n">e3nn_large_y_hat</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span></code></pre></figure> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">epoch</span>  <span class="mi">1000</span> <span class="o">|</span> <span class="n">Train</span> <span class="n">MSE</span> <span class="mf">10.74854</span>   <span class="o">|</span> <span class="n">Test</span> <span class="n">MSE</span> <span class="mf">0.36630</span>   <span class="p">:</span> <span class="mi">100</span><span class="o">%|</span><span class="err">██████████</span><span class="o">|</span> <span class="mi">1001</span><span class="o">/</span><span class="mi">1001</span> <span class="p">[</span><span class="mi">10</span><span class="p">:</span><span class="mi">59</span><span class="o">&lt;</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span>  <span class="mf">1.52</span><span class="n">it</span><span class="o">/</span><span class="n">s</span><span class="p">]</span>
<span class="n">epoch</span>  <span class="mi">1000</span> <span class="o">|</span> <span class="n">Train</span> <span class="n">MSE</span> <span class="mf">0.00000</span>    <span class="o">|</span> <span class="n">Test</span> <span class="n">MSE</span> <span class="mf">0.00006</span>   <span class="p">:</span> <span class="mi">100</span><span class="o">%|</span><span class="err">██████████</span><span class="o">|</span> <span class="mi">1001</span><span class="o">/</span><span class="mi">1001</span> <span class="p">[</span><span class="mi">51</span><span class="p">:</span><span class="mi">30</span><span class="o">&lt;</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span>  <span class="mf">3.09</span><span class="n">s</span><span class="o">/</span><span class="n">it</span><span class="p">]</span>
<span class="mi">100</span><span class="o">%|</span><span class="err">██████████</span><span class="o">|</span> <span class="mi">410</span><span class="o">/</span><span class="mi">410</span> <span class="p">[</span><span class="mi">00</span><span class="p">:</span><span class="mi">02</span><span class="o">&lt;</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mf">147.40</span><span class="n">it</span><span class="o">/</span><span class="n">s</span><span class="p">]</span>
<span class="mi">100</span><span class="o">%|</span><span class="err">██████████</span><span class="o">|</span> <span class="mi">410</span><span class="o">/</span><span class="mi">410</span> <span class="p">[</span><span class="mi">00</span><span class="p">:</span><span class="mi">06</span><span class="o">&lt;</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mf">60.48</span><span class="n">it</span><span class="o">/</span><span class="n">s</span><span class="p">]</span></code></pre></figure> <p>The training speed is significantly slower due to the expensive <code class="language-plaintext highlighter-rouge">FullyConnectedTensorProduct</code> layer as it operates on higher order irreps.</p> <p>For E3NN small no shuffle:</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/posts/e3nn/e3smallcorr-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/posts/e3nn/e3smallcorr-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/posts/e3nn/e3smallcorr-1400.webp"></source> <img src="/assets/img/posts/e3nn/e3smallcorr.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/posts/e3nn/e3smalltraj-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/posts/e3nn/e3smalltraj-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/posts/e3nn/e3smalltraj-1400.webp"></source> <img src="/assets/img/posts/e3nn/e3smalltraj.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <p>For E3NN large no shuffle:</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/posts/e3nn/e3largecorr-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/posts/e3nn/e3largecorr-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/posts/e3nn/e3largecorr-1400.webp"></source> <img src="/assets/img/posts/e3nn/e3largecorr.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/posts/e3nn/e3largetraj-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/posts/e3nn/e3largetraj-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/posts/e3nn/e3largetraj-1400.webp"></source> <img src="/assets/img/posts/e3nn/e3largetraj.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <p>Hmmm.. It does not seem like these equivariant models outperform non-equivariant ones but the larger model involving higher order irreps definitely helps. It is unclear whether these models require different learning rates or longer training epochs.</p> <p>I also tried to train them using the shuffled data sets but the results look similar without significant improvement.</p> <p>In our set-up, we have the option to predict \(x(t+\Delta t)\) directly. Let’s see if we can directly train the <code class="language-plaintext highlighter-rouge">e3nn_large</code> using the positions directly.</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">epochs</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">lr</span> <span class="o">=</span> <span class="mf">1e-3</span>
<span class="c1"># e3nn_small, e3nn_small_logs = train(EquivariantPolynomial(), dataloaders['dx']['no_shuffle']['train'], dataloaders['dx']['no_shuffle']['test'], epochs=epochs, lr=lr, device='cpu', opt='AdamW')
</span><span class="n">e3nn_large2</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="nf">train</span><span class="p">(</span><span class="nc">Network</span><span class="p">(</span><span class="o">**</span><span class="n">model_kwargs</span><span class="p">),</span> <span class="n">dataloaders</span><span class="p">[</span><span class="sh">'</span><span class="s">pos</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">no_shuffle</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">train</span><span class="sh">'</span><span class="p">],</span> <span class="n">dataloaders</span><span class="p">[</span><span class="sh">'</span><span class="s">pos</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">no_shuffle</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">test</span><span class="sh">'</span><span class="p">],</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">)</span>

<span class="c1"># e3nn_small_y_hat, y = forward_pass(e3nn_small, dx_prediction_test_dataset, delta=True)
# show_correlation(e3nn_small_y_hat, y)
# compare_trajectories(e3nn_small_y_hat, y)
</span>
<span class="n">e3nn_large_y_hat</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="nf">forward_pass</span><span class="p">(</span><span class="n">e3nn_large2</span><span class="p">,</span> <span class="n">pos_prediction_test_dataset</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="c1"># assert torch.allclose(y, y2)
</span><span class="nf">show_correlation</span><span class="p">(</span><span class="n">e3nn_large_y_hat</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span>
<span class="nf">compare_trajectories</span><span class="p">(</span><span class="n">e3nn_large_y_hat</span><span class="p">,</span> <span class="n">y2</span><span class="p">)</span></code></pre></figure> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">epoch</span>  <span class="mi">1000</span> <span class="o">|</span> <span class="n">Train</span> <span class="n">MSE</span> <span class="mf">3.05509</span>    <span class="o">|</span> <span class="n">Test</span> <span class="n">MSE</span> <span class="mf">698.58898</span> <span class="p">:</span> <span class="mi">100</span><span class="o">%|</span><span class="err">██████████</span><span class="o">|</span> <span class="mi">1001</span><span class="o">/</span><span class="mi">1001</span> <span class="p">[</span><span class="mi">53</span><span class="p">:</span><span class="mi">10</span><span class="o">&lt;</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span>  <span class="mf">3.19</span><span class="n">s</span><span class="o">/</span><span class="n">it</span><span class="p">]</span>
<span class="mi">100</span><span class="o">%|</span><span class="err">██████████</span><span class="o">|</span> <span class="mi">410</span><span class="o">/</span><span class="mi">410</span> <span class="p">[</span><span class="mi">00</span><span class="p">:</span><span class="mi">06</span><span class="o">&lt;</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mf">62.76</span><span class="n">it</span><span class="o">/</span><span class="n">s</span><span class="p">]</span></code></pre></figure> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/posts/e3nn/poscorr-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/posts/e3nn/poscorr-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/posts/e3nn/poscorr-1400.webp"></source> <img src="/assets/img/posts/e3nn/poscorr.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/posts/e3nn/postraj-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/posts/e3nn/postraj-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/posts/e3nn/postraj-1400.webp"></source> <img src="/assets/img/posts/e3nn/postraj.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <p>It does not seem to work. This might suggest that \(p(x(t + \Delta t) \| x(t))\) is different from \(p(\Delta x \| x(t))\) and is more diffucult to learn from the data in this setup.</p> <h2 id="25-testing-equivariance">2.5 Testing Equivariance</h2> <p>We will test equivariance of our 4 models so far.</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1"># test se3 equivariance 
</span><span class="k">def</span> <span class="nf">se3_equivariance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">rot</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">rot</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="n">rot</span> <span class="o">=</span> <span class="n">trans</span><span class="p">.</span><span class="n">Rotation</span><span class="p">.</span><span class="nf">from_euler</span><span class="p">(</span><span class="sh">'</span><span class="s">x</span><span class="sh">'</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="n">degrees</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="n">t</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

    <span class="n">input_point</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">randn</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">input_point_transformed</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">from_numpy</span><span class="p">(</span><span class="n">rot</span><span class="p">.</span><span class="nf">apply</span><span class="p">(</span><span class="n">input_point</span><span class="p">)).</span><span class="nf">to</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="nb">float</span><span class="p">)</span> <span class="o">+</span> <span class="n">t</span>

    <span class="n">dset</span> <span class="o">=</span> <span class="p">[</span><span class="nc">Data</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">input_point</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">input_point</span><span class="p">)]</span>
    <span class="n">dset_transformed</span> <span class="o">=</span> <span class="p">[</span><span class="nc">Data</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="n">input_point_transformed</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">input_point_transformed</span><span class="p">)]</span>

    <span class="n">output_point</span><span class="p">,</span> <span class="n">__</span> <span class="o">=</span> <span class="nf">forward_pass</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">dset</span><span class="p">)</span>
    <span class="n">output_point_transformed</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">from_numpy</span><span class="p">(</span><span class="n">rot</span><span class="p">.</span><span class="nf">apply</span><span class="p">(</span><span class="n">output_point</span><span class="p">.</span><span class="nf">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">))).</span><span class="nf">to</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">trandformed_output_point</span><span class="p">,</span> <span class="n">__</span> <span class="o">=</span> <span class="nf">forward_pass</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">dset_transformed</span><span class="p">)</span>

    <span class="n">err</span> <span class="o">=</span> <span class="p">(</span><span class="n">trandformed_output_point</span> <span class="o">-</span> <span class="n">output_point_transformed</span><span class="p">).</span><span class="nf">abs</span><span class="p">().</span><span class="nf">max</span><span class="p">().</span><span class="nf">item</span><span class="p">()</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">Err = </span><span class="sh">'</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
    <span class="c1"># assert err &lt; tol
</span>
    <span class="k">return</span> <span class="bp">None</span>

<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">MLP Baseline: </span><span class="sh">'</span><span class="p">)</span>
<span class="nf">se3_equivariance</span><span class="p">(</span><span class="n">mlpbase</span><span class="p">)</span>

<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">GNN Baseline: </span><span class="sh">'</span><span class="p">)</span>
<span class="nf">se3_equivariance</span><span class="p">(</span><span class="n">gnnbase</span><span class="p">)</span>

<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">E3NN Small: </span><span class="sh">'</span><span class="p">)</span>
<span class="nf">se3_equivariance</span><span class="p">(</span><span class="n">e3nn_small</span><span class="p">)</span>


<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">E3NN Large: </span><span class="sh">'</span><span class="p">)</span>
<span class="nf">se3_equivariance</span><span class="p">(</span><span class="n">e3nn_large</span><span class="p">)</span></code></pre></figure> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">MLP</span> <span class="n">Baseline</span><span class="p">:</span> 
<span class="mi">100</span><span class="o">%|</span><span class="err">██████████</span><span class="o">|</span> <span class="mi">1</span><span class="o">/</span><span class="mi">1</span> <span class="p">[</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="o">&lt;</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mf">1642.25</span><span class="n">it</span><span class="o">/</span><span class="n">s</span><span class="p">]</span>
<span class="mi">100</span><span class="o">%|</span><span class="err">██████████</span><span class="o">|</span> <span class="mi">1</span><span class="o">/</span><span class="mi">1</span> <span class="p">[</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="o">&lt;</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mf">2750.36</span><span class="n">it</span><span class="o">/</span><span class="n">s</span><span class="p">]</span>
<span class="n">Err</span> <span class="o">=</span>  <span class="mf">0.004440372344106436</span>
<span class="n">GNN</span> <span class="n">Baseline</span><span class="p">:</span> 
<span class="mi">100</span><span class="o">%|</span><span class="err">██████████</span><span class="o">|</span> <span class="mi">1</span><span class="o">/</span><span class="mi">1</span> <span class="p">[</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="o">&lt;</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mf">211.60</span><span class="n">it</span><span class="o">/</span><span class="n">s</span><span class="p">]</span>
<span class="mi">100</span><span class="o">%|</span><span class="err">██████████</span><span class="o">|</span> <span class="mi">1</span><span class="o">/</span><span class="mi">1</span> <span class="p">[</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="o">&lt;</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mf">365.26</span><span class="n">it</span><span class="o">/</span><span class="n">s</span><span class="p">]</span>
<span class="n">Err</span> <span class="o">=</span>  <span class="mf">0.013194178231060505</span>
<span class="n">E3NN</span> <span class="n">Small</span><span class="p">:</span> 
<span class="mi">100</span><span class="o">%|</span><span class="err">██████████</span><span class="o">|</span> <span class="mi">1</span><span class="o">/</span><span class="mi">1</span> <span class="p">[</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="o">&lt;</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mf">23.25</span><span class="n">it</span><span class="o">/</span><span class="n">s</span><span class="p">]</span>
<span class="mi">100</span><span class="o">%|</span><span class="err">██████████</span><span class="o">|</span> <span class="mi">1</span><span class="o">/</span><span class="mi">1</span> <span class="p">[</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="o">&lt;</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mf">204.99</span><span class="n">it</span><span class="o">/</span><span class="n">s</span><span class="p">]</span>
<span class="n">Err</span> <span class="o">=</span>  <span class="mf">0.0001068115234375</span>
<span class="n">E3NN</span> <span class="n">Large</span><span class="p">:</span> 
<span class="mi">100</span><span class="o">%|</span><span class="err">██████████</span><span class="o">|</span> <span class="mi">1</span><span class="o">/</span><span class="mi">1</span> <span class="p">[</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="o">&lt;</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mf">61.12</span><span class="n">it</span><span class="o">/</span><span class="n">s</span><span class="p">]</span>
<span class="mi">100</span><span class="o">%|</span><span class="err">██████████</span><span class="o">|</span> <span class="mi">1</span><span class="o">/</span><span class="mi">1</span> <span class="p">[</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="o">&lt;</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mf">63.11</span><span class="n">it</span><span class="o">/</span><span class="n">s</span><span class="p">]</span>
<span class="n">Err</span> <span class="o">=</span>  <span class="mf">2.8870999813079834e-08</span></code></pre></figure> <h2 id="26-simple-se3-transformer">2.6 Simple SE3-Transformer</h2> <p>Given that the <code class="language-plaintext highlighter-rouge">e3nn_large</code> model does not outperform the baselines, I was motivated to look into more complex models, such as the <a href="https://arxiv.org/abs/2006.10503" rel="external nofollow noopener" target="_blank">SE3-Transformer</a>. The <code class="language-plaintext highlighter-rouge">e3nn</code> document provides simple implementation of SE3-Transformer using the <code class="language-plaintext highlighter-rouge">e3nn</code> framework. I will use the implementation for <code class="language-plaintext highlighter-rouge">E3Attention</code> which grounds the <code class="language-plaintext highlighter-rouge">E3MultiHeadAttention</code>. We will use the layers to build a more complex <code class="language-plaintext highlighter-rouge">E3Network</code>.</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c1"># Build a SE-3 Transformer model
</span><span class="kn">import</span> <span class="n">e3nn</span>

<span class="k">class</span> <span class="nc">E3Attention</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span> 

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">irreps_in</span><span class="p">,</span> <span class="n">irreps_q</span><span class="p">,</span> <span class="n">irreps_k</span><span class="p">,</span> <span class="n">irreps_out</span><span class="p">,</span> <span class="n">num_bases</span><span class="p">,</span> <span class="n">max_radius</span><span class="p">,</span> <span class="n">sh_order</span><span class="o">=</span><span class="mi">4</span><span class="p">,):</span> 
        <span class="nf">super</span><span class="p">(</span><span class="n">E3Attention</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">__init__</span><span class="p">()</span>

        <span class="n">self</span><span class="p">.</span><span class="n">irreps_in</span> <span class="o">=</span> <span class="n">irreps_in</span>
        <span class="n">self</span><span class="p">.</span><span class="n">irreps_q</span> <span class="o">=</span> <span class="n">irreps_q</span>
        <span class="n">self</span><span class="p">.</span><span class="n">irresp_k</span> <span class="o">=</span> <span class="n">irreps_k</span>
        <span class="n">self</span><span class="p">.</span><span class="n">irreps_out</span> <span class="o">=</span> <span class="n">irreps_out</span>
        <span class="n">self</span><span class="p">.</span><span class="n">irreps_sh</span> <span class="o">=</span> <span class="n">o3</span><span class="p">.</span><span class="n">Irreps</span><span class="p">.</span><span class="nf">spherical_harmonics</span><span class="p">(</span><span class="n">sh_order</span><span class="p">)</span>

        <span class="n">self</span><span class="p">.</span><span class="n">num_bases</span> <span class="o">=</span> <span class="n">num_bases</span>
        <span class="n">self</span><span class="p">.</span><span class="n">max_radius</span> <span class="o">=</span> <span class="n">max_radius</span>

        <span class="c1"># input to query
</span>        <span class="n">self</span><span class="p">.</span><span class="n">to_q</span> <span class="o">=</span> <span class="n">o3</span><span class="p">.</span><span class="nc">Linear</span><span class="p">(</span><span class="n">irreps_in</span><span class="p">,</span> <span class="n">irreps_q</span><span class="p">).</span><span class="nf">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
        
        <span class="c1"># input to key
</span>        <span class="n">self</span><span class="p">.</span><span class="n">tp_k</span> <span class="o">=</span> <span class="n">o3</span><span class="p">.</span><span class="nc">FullyConnectedTensorProduct</span><span class="p">(</span><span class="n">irreps_in</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">irreps_sh</span><span class="p">,</span> <span class="n">irreps_k</span><span class="p">,</span> <span class="n">shared_weights</span><span class="o">=</span><span class="bp">False</span><span class="p">).</span><span class="nf">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">fc_k</span> <span class="o">=</span> <span class="n">e3nn</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="nc">FullyConnectedNet</span><span class="p">([</span><span class="n">self</span><span class="p">.</span><span class="n">num_bases</span><span class="p">,</span> <span class="p">(</span><span class="n">sh_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">tp_k</span><span class="p">.</span><span class="n">weight_numel</span><span class="p">],</span> <span class="n">act</span><span class="o">=</span><span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="n">functional</span><span class="p">.</span><span class="n">gelu</span><span class="p">).</span><span class="nf">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>

        <span class="c1"># input to value
</span>        <span class="n">self</span><span class="p">.</span><span class="n">tp_v</span> <span class="o">=</span> <span class="n">o3</span><span class="p">.</span><span class="nc">FullyConnectedTensorProduct</span><span class="p">(</span><span class="n">irreps_in</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">irreps_sh</span><span class="p">,</span> <span class="n">irreps_out</span><span class="p">,</span> <span class="n">shared_weights</span><span class="o">=</span><span class="bp">False</span><span class="p">).</span><span class="nf">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">fc_v</span> <span class="o">=</span> <span class="n">e3nn</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="nc">FullyConnectedNet</span><span class="p">([</span><span class="n">self</span><span class="p">.</span><span class="n">num_bases</span><span class="p">,</span> <span class="p">(</span><span class="n">sh_order</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">tp_v</span><span class="p">.</span><span class="n">weight_numel</span><span class="p">],</span> <span class="n">act</span><span class="o">=</span><span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="n">functional</span><span class="p">.</span><span class="n">gelu</span><span class="p">).</span><span class="nf">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>

        <span class="c1"># dot product
</span>        <span class="n">self</span><span class="p">.</span><span class="n">dot_product</span> <span class="o">=</span> <span class="n">o3</span><span class="p">.</span><span class="nc">FullyConnectedTensorProduct</span><span class="p">(</span><span class="n">irreps_q</span><span class="p">,</span> <span class="n">irreps_k</span><span class="p">,</span> <span class="sh">'</span><span class="s">0e</span><span class="sh">'</span><span class="p">).</span><span class="nf">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span> 
        <span class="n">num_neighbors</span> <span class="o">=</span> <span class="mi">11</span>
        <span class="n">num_nodes</span> <span class="o">=</span> <span class="mi">12</span>
        
        <span class="n">pos</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">pos</span>
        <span class="c1"># features = torch.zeros(pos.shape[0], self.irreps_in.dim)
</span>        <span class="n">features</span> <span class="o">=</span> <span class="n">pos</span>
        

        <span class="c1"># edges
</span>        <span class="n">edge_src</span><span class="p">,</span> <span class="n">edge_dst</span> <span class="o">=</span> <span class="nf">radius_graph</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">max_radius</span><span class="p">)</span>
        <span class="n">edge_vec</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="n">edge_src</span><span class="p">]</span> <span class="o">-</span> <span class="n">pos</span><span class="p">[</span><span class="n">edge_dst</span><span class="p">]</span>
        <span class="n">edge_length</span> <span class="o">=</span> <span class="n">edge_vec</span><span class="p">.</span><span class="nf">norm</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">edge_length_embedded</span> <span class="o">=</span> <span class="n">e3nn</span><span class="p">.</span><span class="n">math</span><span class="p">.</span><span class="nf">soft_one_hot_linspace</span><span class="p">(</span><span class="n">edge_length</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">max_radius</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="n">self</span><span class="p">.</span><span class="n">num_bases</span><span class="p">,</span> <span class="n">basis</span><span class="o">=</span><span class="sh">'</span><span class="s">smooth_finite</span><span class="sh">'</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="o">*</span> <span class="n">self</span><span class="p">.</span><span class="n">num_bases</span> <span class="o">**</span> <span class="mf">0.5</span>
        <span class="n">edge_weight_cutoff</span> <span class="o">=</span> <span class="n">e3nn</span><span class="p">.</span><span class="n">math</span><span class="p">.</span><span class="nf">soft_unit_step</span><span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">edge_length</span> <span class="o">/</span> <span class="n">self</span><span class="p">.</span><span class="n">max_radius</span><span class="p">))</span>

        <span class="n">edge_features</span> <span class="o">=</span> <span class="n">o3</span><span class="p">.</span><span class="nf">spherical_harmonics</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">irreps_sh</span><span class="p">,</span> <span class="n">edge_vec</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="n">normalization</span><span class="o">=</span><span class="sh">'</span><span class="s">component</span><span class="sh">'</span><span class="p">).</span><span class="nf">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
        <span class="n">edge_length_embedded</span> <span class="o">=</span> <span class="n">edge_length_embedded</span><span class="p">.</span><span class="nf">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>

        <span class="c1"># qkv
</span>        <span class="n">q</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">to_q</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">tp_k</span><span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="n">edge_src</span><span class="p">],</span> <span class="n">edge_features</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="nf">fc_k</span><span class="p">(</span><span class="n">edge_length_embedded</span><span class="p">))</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">tp_v</span><span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="n">edge_src</span><span class="p">],</span> <span class="n">edge_features</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="nf">fc_v</span><span class="p">(</span><span class="n">edge_length_embedded</span><span class="p">))</span>

        <span class="n">exp</span> <span class="o">=</span> <span class="n">edge_weight_cutoff</span><span class="p">[:,</span> <span class="bp">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">self</span><span class="p">.</span><span class="nf">dot_product</span><span class="p">(</span><span class="n">q</span><span class="p">[</span><span class="n">edge_dst</span><span class="p">],</span> <span class="n">k</span><span class="p">).</span><span class="nf">exp</span><span class="p">()</span>
        <span class="n">exp</span> <span class="o">=</span> <span class="n">exp</span><span class="p">.</span><span class="nf">clamp</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

        <span class="n">z</span> <span class="o">=</span> <span class="nf">scatter</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="n">edge_dst</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dim_size</span><span class="o">=</span><span class="nf">len</span><span class="p">(</span><span class="n">features</span><span class="p">))</span>
        <span class="n">z</span><span class="p">[</span><span class="n">z</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">exp</span> <span class="o">/</span> <span class="n">z</span><span class="p">[</span><span class="n">edge_dst</span><span class="p">]</span>

        <span class="n">out</span> <span class="o">=</span> <span class="nf">scatter</span><span class="p">(</span><span class="n">alpha</span><span class="p">.</span><span class="nf">relu</span><span class="p">().</span><span class="nf">sqrt</span><span class="p">()</span> <span class="o">*</span> <span class="n">v</span><span class="p">,</span> <span class="n">edge_dst</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dim_size</span><span class="o">=</span><span class="nf">len</span><span class="p">(</span><span class="n">features</span><span class="p">),</span> <span class="nb">reduce</span><span class="o">=</span><span class="sh">'</span><span class="s">mean</span><span class="sh">'</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">out</span>



<span class="k">class</span> <span class="nc">E3MultiHeadAttention</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span> 

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">irreps_in</span><span class="p">,</span> <span class="n">irreps_q</span><span class="p">,</span> <span class="n">irreps_k</span><span class="p">,</span> <span class="n">irreps_mid</span><span class="p">,</span> <span class="n">irreps_out</span><span class="p">,</span> <span class="n">num_bases</span><span class="p">,</span> <span class="n">max_radius</span><span class="p">,</span> <span class="n">sh_order</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">heads</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span> 
        <span class="nf">super</span><span class="p">(</span><span class="n">E3MultiHeadAttention</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">__init__</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">irreps_in</span> <span class="o">=</span> <span class="n">irreps_in</span>
        <span class="n">self</span><span class="p">.</span><span class="n">irreps_q</span> <span class="o">=</span> <span class="n">irreps_q</span>
        <span class="n">self</span><span class="p">.</span><span class="n">irreps_k</span> <span class="o">=</span> <span class="n">irreps_k</span>
        <span class="n">self</span><span class="p">.</span><span class="n">irreps_mid</span> <span class="o">=</span> <span class="n">irreps_mid</span>
        <span class="n">self</span><span class="p">.</span><span class="n">irreps_out</span> <span class="o">=</span> <span class="n">irreps_out</span>
        <span class="n">self</span><span class="p">.</span><span class="n">num_bases</span> <span class="o">=</span> <span class="n">num_bases</span>
        <span class="n">self</span><span class="p">.</span><span class="n">max_radius</span> <span class="o">=</span> <span class="n">max_radius</span>
        <span class="n">self</span><span class="p">.</span><span class="n">sh_order</span> <span class="o">=</span> <span class="n">sh_order</span>
        <span class="n">self</span><span class="p">.</span><span class="n">heads</span> <span class="o">=</span> <span class="n">heads</span> 

        <span class="n">self</span><span class="p">.</span><span class="n">irreps_all_heads</span> <span class="o">=</span> <span class="n">irreps_mid</span> <span class="o">*</span> <span class="n">heads</span>
        <span class="n">self</span><span class="p">.</span><span class="n">irreps_sh</span> <span class="o">=</span> <span class="n">o3</span><span class="p">.</span><span class="n">Irreps</span><span class="p">.</span><span class="nf">spherical_harmonics</span><span class="p">(</span><span class="n">sh_order</span><span class="p">)</span>


        <span class="n">self</span><span class="p">.</span><span class="n">hs</span> <span class="o">=</span> <span class="p">[</span><span class="nc">E3Attention</span><span class="p">(</span><span class="n">irreps_in</span><span class="p">,</span> <span class="n">irreps_q</span><span class="p">,</span> <span class="n">irreps_k</span><span class="p">,</span> <span class="n">irreps_mid</span><span class="p">,</span> <span class="n">num_bases</span><span class="o">=</span><span class="n">num_bases</span><span class="p">,</span> <span class="n">max_radius</span><span class="o">=</span><span class="n">max_radius</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">heads</span><span class="p">)]</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">tp1</span> <span class="o">=</span> <span class="n">o3</span><span class="p">.</span><span class="nc">FullyConnectedTensorProduct</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">irreps_all_heads</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">irreps_sh</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">irreps_mid</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">tp2</span> <span class="o">=</span> <span class="n">o3</span><span class="p">.</span><span class="nc">FullyConnectedTensorProduct</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">irreps_mid</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">irreps_sh</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">irreps_out</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span> 

        <span class="n">pos</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">pos</span>
        <span class="c1"># features = torch.zeros(pos.shape[0], self.irreps_in.dim)
</span>        <span class="n">features</span> <span class="o">=</span> <span class="n">pos</span>
        
        <span class="c1"># edges
</span>        <span class="n">edge_src</span><span class="p">,</span> <span class="n">edge_dst</span> <span class="o">=</span> <span class="nf">radius_graph</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="n">max_radius</span><span class="p">)</span>
        <span class="n">edge_vec</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="n">edge_src</span><span class="p">]</span> <span class="o">-</span> <span class="n">pos</span><span class="p">[</span><span class="n">edge_dst</span><span class="p">]</span>
        <span class="n">edge_features</span> <span class="o">=</span> <span class="n">o3</span><span class="p">.</span><span class="nf">spherical_harmonics</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">irreps_sh</span><span class="p">,</span> <span class="n">edge_vec</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="n">normalization</span><span class="o">=</span><span class="sh">'</span><span class="s">component</span><span class="sh">'</span><span class="p">)</span>

        <span class="n">hs</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">concat</span><span class="p">([</span><span class="nf">f</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">hs</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># print(hs)
</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">tp1</span><span class="p">(</span><span class="n">hs</span><span class="p">[</span><span class="n">edge_src</span><span class="p">],</span> <span class="n">edge_features</span><span class="p">)</span>
        <span class="n">h</span> <span class="o">=</span> <span class="nf">scatter</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">edge_dst</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">reduce</span><span class="o">=</span><span class="sh">'</span><span class="s">mean</span><span class="sh">'</span><span class="p">)</span>
        <span class="c1"># print(h.shape)
</span>        <span class="n">h</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">tp2</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="n">edge_src</span><span class="p">],</span> <span class="n">edge_features</span><span class="p">)</span>
        <span class="n">h</span> <span class="o">=</span> <span class="nf">scatter</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">edge_dst</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">reduce</span><span class="o">=</span><span class="sh">'</span><span class="s">mean</span><span class="sh">'</span><span class="p">)</span>
        <span class="c1"># print(h.shape)
</span>        <span class="k">return</span> <span class="n">h</span>



<span class="k">class</span> <span class="nc">E3Network</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span> 
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">irreps_in</span><span class="p">,</span> <span class="n">irreps_q</span><span class="p">,</span> <span class="n">irreps_k</span><span class="p">,</span> <span class="n">irreps_mid</span><span class="p">,</span> <span class="n">irreps_out</span><span class="p">,</span> <span class="n">num_bases</span><span class="p">,</span> <span class="n">max_radius</span><span class="p">,</span> <span class="n">sh_order</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">heads</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">layers</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span> 
        <span class="nf">super</span><span class="p">(</span><span class="n">E3Network</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">__init__</span><span class="p">()</span>
        <span class="n">e3mhas</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">layers</span><span class="p">):</span> 
            <span class="n">e3mhas</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">E3MultiHeadAttention</span><span class="p">(</span><span class="n">irreps_in</span><span class="o">=</span><span class="n">irreps_in</span><span class="p">,</span> <span class="c1"># if i == 0 else irreps_mid, 
</span>                                               <span class="n">irreps_q</span><span class="o">=</span><span class="n">irreps_q</span><span class="p">,</span> <span class="n">irreps_k</span><span class="o">=</span><span class="n">irreps_k</span><span class="p">,</span> <span class="n">irreps_mid</span><span class="o">=</span><span class="n">irreps_mid</span><span class="p">,</span>
                                               <span class="n">irreps_out</span><span class="o">=</span><span class="n">irreps_out</span><span class="p">,</span> 
                                               <span class="n">num_bases</span><span class="o">=</span><span class="n">num_bases</span><span class="p">,</span> <span class="n">max_radius</span><span class="o">=</span><span class="n">max_radius</span><span class="p">,</span> <span class="n">sh_order</span><span class="o">=</span><span class="n">sh_order</span><span class="p">,</span> 
                                               <span class="n">heads</span><span class="o">=</span><span class="n">heads</span><span class="p">))</span>
        <span class="n">self</span><span class="p">.</span><span class="n">e3mhas</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="nc">ModuleList</span><span class="p">(</span><span class="n">e3mhas</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span> 
        <span class="n">tmp_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">clone</span><span class="p">()</span>
        <span class="nf">for </span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">e3mha</span><span class="p">)</span> <span class="ow">in</span> <span class="nf">enumerate</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">e3mhas</span><span class="p">):</span> <span class="n">tmp_data</span><span class="p">.</span><span class="n">pos</span> <span class="o">=</span> <span class="nf">e3mha</span><span class="p">(</span><span class="n">tmp_data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">tmp_data</span><span class="p">.</span><span class="n">pos</span>
        </code></pre></figure> <p>Let’s get them trained. Note that GPU is required for training 1000 epochs here.</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">irreps_in</span> <span class="o">=</span> <span class="n">o3</span><span class="p">.</span><span class="nc">Irreps</span><span class="p">(</span><span class="sh">"</span><span class="s">1x1o</span><span class="sh">"</span><span class="p">)</span>
<span class="n">irreps_q</span> <span class="o">=</span> <span class="n">e3nn</span><span class="p">.</span><span class="n">o3</span><span class="p">.</span><span class="nc">Irreps</span><span class="p">(</span><span class="sh">'</span><span class="s">8x0e + 8x0o + 16x1e + 16x1o + 8x2e + 8x2o</span><span class="sh">'</span><span class="p">)</span>
<span class="n">irreps_k</span> <span class="o">=</span> <span class="n">irreps_q</span>
<span class="n">irreps_mid</span> <span class="o">=</span> <span class="n">irreps_q</span>
<span class="n">irreps_out</span> <span class="o">=</span> <span class="n">o3</span><span class="p">.</span><span class="nc">Irreps</span><span class="p">(</span><span class="sh">"</span><span class="s">1x1o</span><span class="sh">"</span><span class="p">)</span>

<span class="n">num_bases</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">max_radius</span> <span class="o">=</span> <span class="mf">3.5</span>


<span class="n">epochs</span> <span class="o">=</span> <span class="mi">300</span>
<span class="n">lr</span> <span class="o">=</span> <span class="mf">1e-3</span>
<span class="n">e3mha</span> <span class="o">=</span> <span class="nc">E3MultiHeadAttention</span><span class="p">(</span><span class="n">irreps_in</span><span class="p">,</span> <span class="n">irreps_q</span><span class="p">,</span> <span class="n">irreps_k</span><span class="p">,</span> <span class="n">irreps_mid</span><span class="p">,</span> <span class="n">irreps_out</span><span class="p">,</span> <span class="n">num_bases</span><span class="o">=</span><span class="n">num_bases</span><span class="p">,</span> <span class="n">max_radius</span><span class="o">=</span><span class="n">max_radius</span><span class="p">,</span> <span class="n">heads</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
<span class="n">e3mha</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="nf">train</span><span class="p">(</span><span class="n">e3mha</span><span class="p">,</span> <span class="n">dataloaders</span><span class="p">[</span><span class="sh">'</span><span class="s">dx</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">no_shuffle</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">train</span><span class="sh">'</span><span class="p">],</span> <span class="n">dataloaders</span><span class="p">[</span><span class="sh">'</span><span class="s">dx</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">no_shuffle</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">test</span><span class="sh">'</span><span class="p">],</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">)</span>

<span class="n">e3net</span> <span class="o">=</span> <span class="nc">E3Network</span><span class="p">(</span><span class="n">irreps_in</span><span class="p">,</span> <span class="n">irreps_q</span><span class="p">,</span> <span class="n">irreps_k</span><span class="p">,</span> <span class="n">irreps_mid</span><span class="p">,</span> <span class="n">irreps_out</span><span class="p">,</span> <span class="n">num_bases</span><span class="o">=</span><span class="n">num_bases</span><span class="p">,</span> <span class="n">max_radius</span><span class="o">=</span><span class="n">max_radius</span><span class="p">,</span> <span class="n">heads</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">layers</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">e3net</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="nf">train</span><span class="p">(</span><span class="n">e3net</span><span class="p">,</span> <span class="n">dataloaders</span><span class="p">[</span><span class="sh">'</span><span class="s">dx</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">no_shuffle</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">train</span><span class="sh">'</span><span class="p">],</span> <span class="n">dataloaders</span><span class="p">[</span><span class="sh">'</span><span class="s">dx</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">no_shuffle</span><span class="sh">'</span><span class="p">][</span><span class="sh">'</span><span class="s">test</span><span class="sh">'</span><span class="p">],</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">,</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">)</span>


<span class="n">e3mha_y_hat</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nf">forward_pass</span><span class="p">(</span><span class="n">e3mha</span><span class="p">,</span> <span class="n">dx_prediction_test_dataset</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="nf">show_correlation</span><span class="p">(</span><span class="n">e3mha_y_hat</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="nf">compare_trajectories</span><span class="p">(</span><span class="n">e3mha_y_hat</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="n">e3net_y_hat</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nf">forward_pass</span><span class="p">(</span><span class="n">e3net</span><span class="p">,</span> <span class="n">dx_prediction_test_dataset</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="nf">show_correlation</span><span class="p">(</span><span class="n">e3net_y_hat</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="nf">compare_trajectories</span><span class="p">(</span><span class="n">e3net_y_hat</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span></code></pre></figure> <figure class="highlight"><pre><code class="language-python" data-lang="python">  <span class="mi">0</span><span class="o">%|</span>          <span class="o">|</span> <span class="mi">0</span><span class="o">/</span><span class="mi">1</span> <span class="p">[</span><span class="mi">01</span><span class="p">:</span><span class="mi">45</span><span class="o">&lt;</span><span class="err">?</span><span class="p">,</span> <span class="err">?</span><span class="n">it</span><span class="o">/</span><span class="n">s</span><span class="p">]</span>
<span class="n">epoch</span>   <span class="mi">300</span> <span class="o">|</span> <span class="n">Train</span> <span class="n">MSE</span> <span class="mf">0.00029</span>    <span class="o">|</span> <span class="n">Test</span> <span class="n">MSE</span> <span class="mf">0.00112</span>   <span class="p">:</span> <span class="mi">100</span><span class="o">%|</span><span class="err">██████████</span><span class="o">|</span> <span class="mi">301</span><span class="o">/</span><span class="mi">301</span> <span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">58</span><span class="p">:</span><span class="mi">21</span><span class="o">&lt;</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">,</span> <span class="mf">23.59</span><span class="n">s</span><span class="o">/</span><span class="n">it</span><span class="p">]</span>
<span class="n">epoch</span>    <span class="mi">57</span> <span class="o">|</span> <span class="n">Train</span> <span class="n">MSE</span> <span class="mf">0.00002</span>    <span class="o">|</span> <span class="n">Test</span> <span class="n">MSE</span> <span class="mf">0.00002</span>   <span class="p">:</span>  <span class="mi">19</span><span class="o">%|</span><span class="err">█▉</span>        <span class="o">|</span> <span class="mi">58</span><span class="o">/</span><span class="mi">301</span> <span class="p">[</span><span class="mi">56</span><span class="p">:</span><span class="mi">27</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">:</span><span class="mi">56</span><span class="p">:</span><span class="mi">26</span><span class="p">,</span> <span class="mf">58.38</span><span class="n">s</span><span class="o">/</span><span class="n">it</span><span class="p">]</span></code></pre></figure> <p>(Note that the training was clipped due to disconnection from jupyter lab.)</p> <p>Let’s see how the trained models perform.</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">e3mha_y_hat</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nf">forward_pass</span><span class="p">(</span><span class="n">e3mha</span><span class="p">,</span> <span class="n">dx_prediction_test_dataset</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="nf">show_correlation</span><span class="p">(</span><span class="n">e3mha_y_hat</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="nf">compare_trajectories</span><span class="p">(</span><span class="n">e3mha_y_hat</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="n">e3net_y_hat</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="nf">forward_pass</span><span class="p">(</span><span class="n">e3net</span><span class="p">,</span> <span class="n">dx_prediction_test_dataset</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="nf">show_correlation</span><span class="p">(</span><span class="n">e3net_y_hat</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="nf">compare_trajectories</span><span class="p">(</span><span class="n">e3net_y_hat</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span></code></pre></figure> <p>For SE3 MHA no shuffle:</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/posts/e3nn/e3mhacorr-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/posts/e3nn/e3mhacorr-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/posts/e3nn/e3mhacorr-1400.webp"></source> <img src="/assets/img/posts/e3nn/e3mhacorr.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/posts/e3nn/e3mhatraj-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/posts/e3nn/e3mhatraj-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/posts/e3nn/e3mhatraj-1400.webp"></source> <img src="/assets/img/posts/e3nn/e3mhatraj.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <p>For SE3 Transformer no shuffle:</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/posts/e3nn/e3netcorr-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/posts/e3nn/e3netcorr-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/posts/e3nn/e3netcorr-1400.webp"></source> <img src="/assets/img/posts/e3nn/e3netcorr.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/posts/e3nn/e3nettraj-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/posts/e3nn/e3nettraj-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/posts/e3nn/e3nettraj-1400.webp"></source> <img src="/assets/img/posts/e3nn/e3nettraj.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <p>Let’s test the equivariance again</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">e3att</span> <span class="o">=</span> <span class="nc">E3Attention</span><span class="p">(</span><span class="n">irreps_in</span><span class="p">,</span> <span class="n">irreps_q</span><span class="p">,</span> <span class="n">irreps_k</span><span class="p">,</span> <span class="n">irreps_out</span><span class="p">,</span> <span class="n">num_bases</span><span class="p">,</span> <span class="n">max_radius</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">E3ATT: </span><span class="sh">'</span><span class="p">)</span>
<span class="nf">se3_equivariance</span><span class="p">(</span><span class="n">e3att</span><span class="p">)</span>
<span class="c1"># print(sum(p.numel() for p in e3att.parameters() if p.requires_grad))
</span>
<span class="n">e3mha</span> <span class="o">=</span> <span class="nc">E3MultiHeadAttention</span><span class="p">(</span><span class="n">irreps_in</span><span class="p">,</span> <span class="n">irreps_q</span><span class="p">,</span> <span class="n">irreps_k</span><span class="p">,</span> <span class="n">irreps_mid</span><span class="p">,</span> <span class="n">irreps_out</span><span class="p">,</span> <span class="n">num_bases</span><span class="o">=</span><span class="n">num_bases</span><span class="p">,</span> <span class="n">max_radius</span><span class="o">=</span><span class="n">max_radius</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">E3MHA: </span><span class="sh">'</span><span class="p">)</span>
<span class="nf">se3_equivariance</span><span class="p">(</span><span class="n">e3mha</span><span class="p">)</span>
<span class="c1"># print(sum(p.numel() for p in e3mha.parameters() if p.requires_grad))
</span>

<span class="n">e3net</span> <span class="o">=</span> <span class="nc">E3Network</span><span class="p">(</span><span class="n">irreps_in</span><span class="p">,</span> <span class="n">irreps_q</span><span class="p">,</span> <span class="n">irreps_k</span><span class="p">,</span> <span class="n">irreps_mid</span><span class="p">,</span> <span class="n">irreps_out</span><span class="p">,</span> <span class="n">num_bases</span><span class="o">=</span><span class="n">num_bases</span><span class="p">,</span> <span class="n">max_radius</span><span class="o">=</span><span class="n">max_radius</span><span class="p">,</span> <span class="n">layers</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="sh">'</span><span class="s">E3Net: </span><span class="sh">'</span><span class="p">)</span>
<span class="nf">se3_equivariance</span><span class="p">(</span><span class="n">e3net</span><span class="p">)</span>
<span class="c1"># print(sum(p.numel() for p in e3net.parameters() if p.requires_grad))</span></code></pre></figure> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="n">E3ATT</span><span class="p">:</span> 
<span class="mf">3.576e-7</span>

<span class="n">E3MHA</span><span class="p">:</span> 
<span class="mf">2.129e-7</span>

<span class="n">E3NET</span><span class="p">:</span>
<span class="mf">1.781e-8</span></code></pre></figure> <h2 id="27-summary">2.7 Summary</h2> <p>Here is the summary table of the experiments using the trajectory data.</p> <style type="text/css">.tg{border-collapse:collapse;border-spacing:0}.tg td{border-color:black;border-style:solid;border-width:1px;font-family:Arial,sans-serif;font-size:14px;overflow:hidden;padding:10px 5px;word-break:normal}.tg th{border-color:black;border-style:solid;border-width:1px;font-family:Arial,sans-serif;font-size:14px;font-weight:normal;overflow:hidden;padding:10px 5px;word-break:normal}.tg .tg-c3ow{border-color:inherit;text-align:center;vertical-align:top}</style> <table class="tg"> <thead> <tr> <th class="tg-c3ow">model</th> <th class="tg-c3ow">trained on</th> <th class="tg-c3ow">shuffle</th> <th class="tg-c3ow">cm corr</th> <th class="tg-c3ow">p1 cm corr</th> <th class="tg-c3ow">p7 x corr</th> <th class="tg-c3ow">p12 y corr</th> <th class="tg-c3ow">equivariance err</th> </tr> </thead> <tbody> <tr> <td class="tg-c3ow">MLPBase</td> <td class="tg-c3ow">dx</td> <td class="tg-c3ow">no</td> <td class="tg-c3ow">1.000</td> <td class="tg-c3ow">0.999</td> <td class="tg-c3ow">1.000</td> <td class="tg-c3ow">0.997</td> <td class="tg-c3ow">4.44e-3</td> </tr> <tr> <td class="tg-c3ow">MLPBase_SH</td> <td class="tg-c3ow">dx</td> <td class="tg-c3ow">yes</td> <td class="tg-c3ow">1.000</td> <td class="tg-c3ow">0.998</td> <td class="tg-c3ow">1.000</td> <td class="tg-c3ow">0.997</td> <td class="tg-c3ow"></td> </tr> <tr> <td class="tg-c3ow">GNNBase</td> <td class="tg-c3ow">dx</td> <td class="tg-c3ow">no</td> <td class="tg-c3ow">1.000</td> <td class="tg-c3ow">0.999</td> <td class="tg-c3ow">1.000</td> <td class="tg-c3ow">0.996</td> <td class="tg-c3ow">1.32e-2</td> </tr> <tr> <td class="tg-c3ow">GNNBase_SH</td> <td class="tg-c3ow">dx</td> <td class="tg-c3ow">yes</td> <td class="tg-c3ow">1.000</td> <td class="tg-c3ow">0.999</td> <td class="tg-c3ow">0.999</td> <td class="tg-c3ow">0.997</td> <td class="tg-c3ow"></td> </tr> <tr> <td class="tg-c3ow">E3Small</td> <td class="tg-c3ow">dx</td> <td class="tg-c3ow">no</td> <td class="tg-c3ow">-3.263</td> <td class="tg-c3ow">-10.729</td> <td class="tg-c3ow">-0.853</td> <td class="tg-c3ow">-214.437</td> <td class="tg-c3ow">1.07e-4</td> </tr> <tr> <td class="tg-c3ow">E3Small_SH</td> <td class="tg-c3ow">dx</td> <td class="tg-c3ow">yes</td> <td class="tg-c3ow">0.998</td> <td class="tg-c3ow">0.830</td> <td class="tg-c3ow">0.992</td> <td class="tg-c3ow">0.772</td> <td class="tg-c3ow"></td> </tr> <tr> <td class="tg-c3ow">E3Large</td> <td class="tg-c3ow">dx</td> <td class="tg-c3ow">no</td> <td class="tg-c3ow">1.000</td> <td class="tg-c3ow">0.997</td> <td class="tg-c3ow">1.000</td> <td class="tg-c3ow">0.993</td> <td class="tg-c3ow">2.89e-8</td> </tr> <tr> <td class="tg-c3ow">E3Large_SH</td> <td class="tg-c3ow">dx</td> <td class="tg-c3ow">yes</td> <td class="tg-c3ow">0.999</td> <td class="tg-c3ow">0.993</td> <td class="tg-c3ow">0.999</td> <td class="tg-c3ow">0.990</td> <td class="tg-c3ow"></td> </tr> <tr> <td class="tg-c3ow">E3Large_Pos</td> <td class="tg-c3ow">x</td> <td class="tg-c3ow">no</td> <td class="tg-c3ow">-75086</td> <td class="tg-c3ow">-77477</td> <td class="tg-c3ow">-9814</td> <td class="tg-c3ow">-19929</td> <td class="tg-c3ow"></td> </tr> <tr> <td class="tg-c3ow">SE3MHA</td> <td class="tg-c3ow">dx</td> <td class="tg-c3ow">no</td> <td class="tg-c3ow">0.513</td> <td class="tg-c3ow">0.321</td> <td class="tg-c3ow">0.937</td> <td class="tg-c3ow">0.788</td> <td class="tg-c3ow">2.13e-7</td> </tr> <tr> <td class="tg-c3ow">SE3Trans</td> <td class="tg-c3ow">dx</td> <td class="tg-c3ow">no</td> <td class="tg-c3ow">1.000</td> <td class="tg-c3ow">0.999</td> <td class="tg-c3ow">1.000</td> <td class="tg-c3ow">0.997</td> <td class="tg-c3ow">1.78e-8</td> </tr> </tbody> </table> <h2 id="28-notes">2.8 Notes</h2> <p>In the models that utilize <code class="language-plaintext highlighter-rouge">FullyConnectedTensorProduct</code> from <code class="language-plaintext highlighter-rouge">e3nn</code>, it might be interesting to see the weights between different order of features. Intuitively, the coefficients of higher order interactions should be small compared to <code class="language-plaintext highlighter-rouge">l0</code> and <code class="language-plaintext highlighter-rouge">l1</code> features. However, I have not investigated it.</p> <p>The model was using <code class="language-plaintext highlighter-rouge">radius_graph</code> with a given radius range for constructing the message passing graphs. Whether this is good enough and how one should choose the radius are potential factors for model improvements.</p> <h2 id="references">References</h2> <ol> <li>Deep learning for molecules and materials: https://dmol.pub/index.html</li> <li>https://e3nn.org</li> <li>https://docs.e3nn.org/en/latest/guide/transformer.html</li> <li>SE3-Transformer: https://arxiv.org/abs/2006.10503</li> </ol> </article> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2025 Yen-Lin Chen. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a>. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Last updated: June 27, 2025. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js"></script> <script defer src="/assets/js/common.js"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>