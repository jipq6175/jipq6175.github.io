<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Training GNN for Stability Prediction | Yen-Lin Chen</title> <meta name="author" content="Yen-Lin Chen"> <meta name="description" content="A small exercise to apply GNN on dG prediction"> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://jipq6175.github.io/blog/2023/stability_gnn/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js"></script> <script src="/assets/js/dark_mode.js"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Yen-Lin </span>Chen</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">About</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">Blogs<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">Publications</a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">CV</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">Training GNN for Stability Prediction</h1> <p class="post-meta">March 19, 2023</p> <p class="post-tags"> <a href="/blog/2023"> <i class="fas fa-calendar fa-sm"></i> 2023 </a>   ·   <a href="/blog/tag/coding"> <i class="fas fa-hashtag fa-sm"></i> coding</a>   <a href="/blog/tag/fitting"> <i class="fas fa-hashtag fa-sm"></i> fitting</a>   <a href="/blog/tag/solving"> <i class="fas fa-hashtag fa-sm"></i> solving</a>     ·   <a href="/blog/category/models"> <i class="fas fa-tag fa-sm"></i> models</a>   </p> </header> <article class="post-content"> <p>Mutations of a protein affect the protein stability, via changing the local interactions among neighboring residues. This mutation effect has been hard to predict especially in the case of protein conformational changes becuase of limited experimental data available. Recently, <a href="https://www.biorxiv.org/content/10.1101/2022.12.06.519132v1" rel="external nofollow noopener" target="_blank">Tsuboyama et al.</a> reported a large study of protein folding stability and made the <a href="https://zenodo.org/record/7401275#.ZBd9r-zMLLU" rel="external nofollow noopener" target="_blank">data</a> available.</p> <p>It might be interesting to model these protein stability data (dG) using the structure and graph neural networks. The notebook and associated subset of the data can be found <a href="https://github.com/jipq6175/StabilityGNN" rel="external nofollow noopener" target="_blank">here</a>. I was using a structure given from the paper: <code class="language-plaintext highlighter-rouge">HEEH_KT_rd6_4322.pdb</code> and the cleaned dG data <code class="language-plaintext highlighter-rouge">test_dG_data.csv</code>. Each entry represent the single point mutation and corresponding dG. The goal is to build a graph neural network that learns the local neighborhood of the point mutation and predict the stability effect.</p> <h3 id="0-dependencies">0. Dependencies</h3> <p>Building a graph from pdb requires many dependencies for the interaction edges. Here I just used minimal functions to construct the edges.</p> <p>If ones uses edge features in the message passing, I would recommend build all edges. Otherwise, these edges might result in over-smoothing in message passing.</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre></td> <td class="code"><pre><span class="c1"># Dependencies
</span><span class="kn">import</span> <span class="n">os</span><span class="p">,</span> <span class="n">torch</span><span class="p">,</span> <span class="n">copy</span><span class="p">,</span> <span class="n">Bio</span><span class="p">,</span> <span class="n">logging</span>

<span class="n">logging</span><span class="p">.</span><span class="nf">getLogger</span><span class="p">(</span><span class="sh">'</span><span class="s">matplotlib</span><span class="sh">'</span><span class="p">).</span><span class="nf">setLevel</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="p">.</span><span class="n">CRITICAL</span><span class="p">)</span>
<span class="n">logging</span><span class="p">.</span><span class="nf">getLogger</span><span class="p">(</span><span class="sh">'</span><span class="s">graphein</span><span class="sh">'</span><span class="p">).</span><span class="nf">setLevel</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="p">.</span><span class="n">CRITICAL</span><span class="p">)</span>


<span class="kn">import</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">networkx</span> <span class="k">as</span> <span class="n">nx</span>

<span class="kn">from</span> <span class="n">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="n">tqdm.auto</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="kn">from</span> <span class="n">torch_geometric.nn</span> <span class="kn">import</span> <span class="n">GCNConv</span>
<span class="kn">from</span> <span class="n">torch_geometric.loader</span> <span class="kn">import</span> <span class="n">DataLoader</span><span class="p">,</span> <span class="n">DataListLoader</span>
<span class="kn">from</span> <span class="n">torch_geometric.data</span> <span class="kn">import</span> <span class="n">Data</span>
<span class="kn">from</span> <span class="n">torch_geometric.utils</span> <span class="kn">import</span> <span class="n">add_self_loops</span>

<span class="kn">from</span> <span class="n">torch_scatter</span> <span class="kn">import</span> <span class="n">scatter_mean</span><span class="p">,</span> <span class="n">scatter_sum</span>


<span class="kn">from</span> <span class="n">graphein.protein.config</span> <span class="kn">import</span> <span class="n">ProteinGraphConfig</span>
<span class="kn">from</span> <span class="n">graphein.protein.graphs</span> <span class="kn">import</span> <span class="n">construct_graph</span>
<span class="kn">from</span> <span class="n">graphein.protein.edges.distance</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="n">graphein.protein.features.nodes.amino_acid</span> <span class="kn">import</span> <span class="n">amino_acid_one_hot</span>
<span class="kn">from</span> <span class="n">graphein.protein.visualisation</span> <span class="kn">import</span> <span class="n">plotly_protein_structure_graph</span>

<span class="kn">from</span> <span class="n">graphein.ml.conversion</span> <span class="kn">import</span> <span class="n">GraphFormatConvertor</span>




<span class="n">node_edge_graph_funcs</span> <span class="o">=</span> <span class="p">{</span><span class="sh">'</span><span class="s">edge_construction_functions</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="n">add_peptide_bonds</span><span class="p">,</span>
                                                         <span class="n">add_hydrogen_bond_interactions</span><span class="p">,</span>
                                                         <span class="n">add_backbone_carbonyl_carbonyl_interactions</span><span class="p">,</span>
                                                         <span class="nf">partial</span><span class="p">(</span><span class="n">add_distance_threshold</span><span class="p">,</span> <span class="n">long_interaction_threshold</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">8.0</span><span class="p">)],</span> 
                         <span class="sh">'</span><span class="s">node_metadata_functions</span><span class="sh">'</span><span class="p">:</span> <span class="p">[</span><span class="n">amino_acid_one_hot</span><span class="p">]}</span>

<span class="n">CONFIG</span> <span class="o">=</span> <span class="nc">ProteinGraphConfig</span><span class="p">(</span><span class="o">**</span><span class="n">node_edge_graph_funcs</span><span class="p">)</span>
</pre></td> </tr></tbody></table></code></pre></figure> <h3 id="1-example-data">1. Example Data</h3> <p>I merged the tables from <code class="language-plaintext highlighter-rouge">Raw_NGS_count_tables</code>, <code class="language-plaintext highlighter-rouge">K50_dG_tables</code> and pull out one structure from AlphaFold_model_PDBs for this example.</p> <p>The <code class="language-plaintext highlighter-rouge">test_dG_data.csv</code> is the simplified file.</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td> <td class="code"><pre><span class="c1"># tables for dG
</span><span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sh">'</span><span class="s">test_dG_data.csv</span><span class="sh">'</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="nf">dropna</span><span class="p">().</span><span class="n">iloc</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>
<span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">mutation</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">].</span><span class="nf">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="sh">'</span><span class="s">_</span><span class="sh">'</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="nf">print</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">shape</span><span class="p">)</span>
<span class="n">data</span><span class="p">.</span><span class="nf">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></td> </tr></tbody></table></code></pre></figure> <p>Output:</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="p">(</span><span class="mi">946</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span></code></pre></figure> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/posts/stabilitygnn/table-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/posts/stabilitygnn/table-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/posts/stabilitygnn/table-1400.webp"></source> <img src="/assets/img/posts/stabilitygnn/table.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <p>Now, construct the protein graph using <code class="language-plaintext highlighter-rouge">Graphein</code>.</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td> <td class="code"><pre><span class="c1"># Construct graph from PDB
</span>
<span class="n">g</span> <span class="o">=</span> <span class="nf">construct_graph</span><span class="p">(</span><span class="n">pdb_path</span><span class="o">=</span><span class="sh">'</span><span class="s">HEEH_KT_rd6_4322.pdb</span><span class="sh">'</span><span class="p">,</span> <span class="n">config</span><span class="o">=</span><span class="n">CONFIG</span><span class="p">)</span>

<span class="c1"># visualize as point cloud graph in 3d
</span><span class="n">p</span> <span class="o">=</span> <span class="nf">plotly_protein_structure_graph</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">colour_edges_by</span><span class="o">=</span><span class="sh">"</span><span class="s">kind</span><span class="sh">"</span><span class="p">,</span>
                                      <span class="n">colour_nodes_by</span><span class="o">=</span><span class="sh">"</span><span class="s">element_symbol</span><span class="sh">"</span><span class="p">,</span>
                                      <span class="n">label_node_ids</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                      <span class="n">node_size_min</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                                      <span class="n">node_alpha</span><span class="o">=</span><span class="mf">0.85</span><span class="p">,</span>
                                      <span class="n">node_size_multiplier</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                      <span class="n">plot_title</span><span class="o">=</span><span class="sh">"</span><span class="s">HEEH_KT_rd6_4322</span><span class="sh">"</span><span class="p">)</span>
<span class="n">p</span><span class="p">.</span><span class="nf">show</span><span class="p">()</span>
</pre></td> </tr></tbody></table></code></pre></figure> <p>Output:</p> <div class="l-page"> <iframe src="/assets/img/posts/stabilitygnn/prot.html" frameborder="0" scrolling="no" height="500px" width="100%" style="border: 1px dashed grey;"></iframe> </div> <p>Does it look like 2 alpha helices and 2 small beta sheets, like below?</p> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" media="(max-width: 480px)" srcset="/assets/img/posts/stabilitygnn/prot-480.webp"></source> <source class="responsive-img-srcset" media="(max-width: 800px)" srcset="/assets/img/posts/stabilitygnn/prot-800.webp"></source> <source class="responsive-img-srcset" media="(max-width: 1400px)" srcset="/assets/img/posts/stabilitygnn/prot-1400.webp"></source> <img src="/assets/img/posts/stabilitygnn/prot.png" class="img-fluid rounded z-depth-1" width="auto" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <p>Now <code class="language-plaintext highlighter-rouge">g</code> is a <code class="language-plaintext highlighter-rouge">networkx</code> graph and we can take a look at what it contains.</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
</pre></td> <td class="code"><pre><span class="nf">print</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">nodes</span><span class="p">[</span><span class="sh">'</span><span class="s">A:SER:1</span><span class="sh">'</span><span class="p">])</span> <span class="c1"># node features
</span><span class="nf">print</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">edges</span><span class="p">[(</span><span class="sh">'</span><span class="s">A:SER:1</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">A:GLU:2</span><span class="sh">'</span><span class="p">)])</span> <span class="c1"># edge_features
# g.graph contains the original pdb info</span>
</pre></td> </tr></tbody></table></code></pre></figure> <p>Output:</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="p">{</span><span class="sh">'</span><span class="s">chain_id</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">A</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">residue_name</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">SER</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">residue_number</span><span class="sh">'</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="sh">'</span><span class="s">atom_type</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">CA</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">element_symbol</span><span class="sh">'</span><span class="p">:</span> <span class="sh">'</span><span class="s">C</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">coords</span><span class="sh">'</span><span class="p">:</span> <span class="nf">array</span><span class="p">([</span><span class="mf">1.458</span><span class="p">,</span> <span class="mf">0.</span>   <span class="p">,</span> <span class="mf">0.</span>   <span class="p">]),</span> <span class="sh">'</span><span class="s">b_factor</span><span class="sh">'</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="sh">'</span><span class="s">amino_acid_one_hot</span><span class="sh">'</span><span class="p">:</span> <span class="nf">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])}</span>
<span class="p">{</span><span class="sh">'</span><span class="s">kind</span><span class="sh">'</span><span class="p">:</span> <span class="p">{</span><span class="sh">'</span><span class="s">bb_carbonyl_carbonyl</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">peptide_bond</span><span class="sh">'</span><span class="p">},</span> <span class="sh">'</span><span class="s">distance</span><span class="sh">'</span><span class="p">:</span> <span class="mf">3.8009521175621246</span><span class="p">}</span></code></pre></figure> <h3 id="2-data-wrangling">2. Data Wrangling</h3> <p>Here I defined some functions for arranging the data intoeasy-to-work-with format, including the pytorch data object <code class="language-plaintext highlighter-rouge">GFocus</code>.</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
</pre></td> <td class="code"><pre><span class="k">def</span> <span class="nf">one2three</span><span class="p">(</span><span class="n">resn</span><span class="p">):</span> 
    <span class="k">return</span> <span class="n">Bio</span><span class="p">.</span><span class="n">SeqUtils</span><span class="p">.</span><span class="nf">seq3</span><span class="p">(</span><span class="n">resn</span><span class="p">).</span><span class="nf">upper</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">get_aa_one_hot</span><span class="p">(</span><span class="n">resn</span><span class="p">):</span> 
    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">resn</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span> <span class="n">aa</span> <span class="o">=</span> <span class="n">resn</span>
    <span class="k">elif</span> <span class="nf">len</span><span class="p">(</span><span class="n">resn</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="n">aa</span> <span class="o">=</span> <span class="nf">one2three</span><span class="p">(</span><span class="n">resn</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="nc">NotImplementedError</span><span class="p">()</span>
    <span class="k">return</span> <span class="nf">amino_acid_one_hot</span><span class="p">(</span><span class="sh">''</span><span class="p">,</span> <span class="p">{</span><span class="sh">'</span><span class="s">residue_name</span><span class="sh">'</span><span class="p">:</span> <span class="n">aa</span><span class="p">})</span>

<span class="k">def</span> <span class="nf">get_node_features</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span> 
    <span class="n">node</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">nodes</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">assert</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">g</span><span class="p">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">torch</span><span class="p">.</span><span class="nf">from_numpy</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">([</span><span class="n">g</span><span class="p">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="n">field</span><span class="p">]</span> <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">g</span><span class="p">.</span><span class="n">nodes</span><span class="p">]))</span>

<span class="k">def</span> <span class="nf">graph2data</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">focus</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">amino_acid_one_hot</span><span class="sh">'</span><span class="p">]):</span> 
    <span class="k">assert</span> <span class="nf">len</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="nf">nodes</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="k">assert</span> <span class="n">focus</span> <span class="ow">in</span> <span class="n">g</span><span class="p">.</span><span class="n">nodes</span>
    <span class="n">d</span> <span class="o">=</span> <span class="nc">GraphFormatConvertor</span><span class="p">(</span><span class="sh">'</span><span class="s">nx</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">pyg</span><span class="sh">'</span><span class="p">).</span><span class="nf">convert_nx_to_pyg</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
    <span class="n">d</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">cat</span><span class="p">([</span><span class="nf">get_node_features</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">).</span><span class="nf">to</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">d</span><span class="p">.</span><span class="n">focus</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">nodes</span><span class="p">).</span><span class="nf">index</span><span class="p">(</span><span class="n">focus</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">d</span>


<span class="c1"># The Customized Focused Graph
# The focus is the node being mutated
</span><span class="k">class</span> <span class="nc">GFocus</span><span class="p">(</span><span class="n">Data</span><span class="p">):</span> 
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span> 
        <span class="nf">super</span><span class="p">().</span><span class="nf">__init__</span><span class="p">()</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="sh">'</span><span class="s">x</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">edge_index</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">focus</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">y</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">name</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">mut</span><span class="sh">'</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span> <span class="nf">setattr</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="nf">getattr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">attr</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__inc__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="sh">'</span><span class="s">focus</span><span class="sh">'</span><span class="p">:</span> <span class="k">return</span> <span class="n">self</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="nf">super</span><span class="p">().</span><span class="nf">__inc__</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">mutate_aa</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">mut</span><span class="p">):</span> 
    <span class="n">chain</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">nodes</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">wt</span><span class="p">,</span> <span class="n">resi</span><span class="p">,</span> <span class="n">mt</span> <span class="o">=</span> <span class="nf">one2three</span><span class="p">(</span><span class="n">mut</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">mut</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nf">one2three</span><span class="p">(</span><span class="n">mut</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    
    <span class="n">node</span><span class="p">,</span> <span class="n">new_node</span> <span class="o">=</span> <span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="n">chain</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">wt</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">resi</span><span class="si">}</span><span class="sh">'</span><span class="p">,</span> <span class="sa">f</span><span class="sh">'</span><span class="si">{</span><span class="n">chain</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">mt</span><span class="si">}</span><span class="s">:</span><span class="si">{</span><span class="n">resi</span><span class="si">}</span><span class="sh">'</span>
    <span class="k">assert</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">g</span><span class="p">.</span><span class="n">nodes</span>
    
    <span class="n">ng</span> <span class="o">=</span> <span class="n">nx</span><span class="p">.</span><span class="nf">relabel_nodes</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="p">{</span><span class="n">node</span><span class="p">:</span> <span class="n">new_node</span><span class="p">})</span>
    <span class="n">ng</span><span class="p">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">new_node</span><span class="p">][</span><span class="sh">'</span><span class="s">amino_acid_one_hot</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="nf">get_aa_one_hot</span><span class="p">(</span><span class="n">mt</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ng</span><span class="p">,</span> <span class="n">new_node</span>


<span class="k">def</span> <span class="nf">generate_dataloader</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="c1"># only do that for mutations, ignore insert or dele for now
</span>    <span class="c1"># insertion can be: duplicating neighbor residues then resample edges
</span>    <span class="c1"># deletion might be tricky: keep neighbor info then deleting the node then use neighbors for prediction
</span>    
    <span class="k">assert</span> <span class="nf">len</span><span class="p">(</span><span class="nb">set</span><span class="p">.</span><span class="nf">intersection</span><span class="p">(</span><span class="nf">set</span><span class="p">([</span><span class="sh">'</span><span class="s">mutation</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">deltaG</span><span class="sh">'</span><span class="p">]),</span> <span class="nf">set</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">columns</span><span class="p">)))</span> <span class="o">==</span> <span class="mi">2</span>
    <span class="n">datalist</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df</span><span class="p">.</span><span class="n">index</span><span class="p">:</span> 
        <span class="n">mut</span><span class="p">,</span> <span class="n">dg</span> <span class="o">=</span> <span class="n">df</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">[</span><span class="sh">'</span><span class="s">mutation</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">deltaG</span><span class="sh">'</span><span class="p">]]</span>
        
        <span class="k">if</span> <span class="n">mut</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">islower</span><span class="p">():</span> <span class="k">continue</span>
        
        <span class="c1"># just skipping some "mutations" that does not pass the assert
</span>        <span class="k">try</span><span class="p">:</span>
            <span class="n">ng</span><span class="p">,</span> <span class="n">new_node</span> <span class="o">=</span> <span class="nf">mutate_aa</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">mut</span><span class="p">)</span>
            <span class="n">d</span> <span class="o">=</span> <span class="nf">graph2data</span><span class="p">(</span><span class="n">ng</span><span class="p">,</span> <span class="n">new_node</span><span class="p">)</span>
            <span class="n">d</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">dg</span>
            <span class="n">d</span><span class="p">.</span><span class="n">mut</span> <span class="o">=</span> <span class="n">mut</span>
        <span class="k">except</span><span class="p">:</span> 
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">Cannot process </span><span class="si">{</span><span class="n">mut</span><span class="si">}</span><span class="sh">'</span><span class="p">)</span>
            <span class="k">continue</span>
        
        <span class="n">datalist</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">GFocus</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="nc">DataLoader</span><span class="p">(</span><span class="n">datalist</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">follow_batch</span><span class="o">=</span><span class="sh">'</span><span class="s">x</span><span class="sh">'</span><span class="p">)</span>
</pre></td> </tr></tbody></table></code></pre></figure> <p>Now we can create a data loader for training.</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td> <td class="code"><pre><span class="c1"># data loader
</span><span class="n">dataloader</span> <span class="o">=</span> <span class="nf">generate_dataloader</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="n">batch</span> <span class="o">=</span> <span class="nf">next</span><span class="p">(</span><span class="nf">iter</span><span class="p">(</span><span class="n">dataloader</span><span class="p">))</span>
<span class="nf">print</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">dataloader</span><span class="p">))</span>
<span class="nf">print</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</pre></td> </tr></tbody></table></code></pre></figure> <p>Output:</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="mi">26</span>
<span class="nc">GFocusBatch</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="mi">1376</span><span class="p">,</span> <span class="mi">20</span><span class="p">],</span> <span class="n">x_batch</span><span class="o">=</span><span class="p">[</span><span class="mi">1376</span><span class="p">],</span> <span class="n">edge_index</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2880</span><span class="p">],</span> <span class="n">focus</span><span class="o">=</span><span class="p">[</span><span class="mi">32</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="mi">32</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="p">[</span><span class="mi">32</span><span class="p">],</span> <span class="n">mut</span><span class="o">=</span><span class="p">[</span><span class="mi">32</span><span class="p">],</span> <span class="n">batch</span><span class="o">=</span><span class="p">[</span><span class="mi">1376</span><span class="p">],</span> <span class="n">ptr</span><span class="o">=</span><span class="p">[</span><span class="mi">33</span><span class="p">])</span></code></pre></figure> <h3 id="3-naive-graph-neural-network-model">3. Naive Graph Neural Network Model</h3> <p>Here I used 4 simple layers:</p> <ul> <li>Pre: Preprocessing</li> <li>GNN: Message passing layers</li> <li>Neighborhood: Neighbor aggregation</li> <li>Head: Regression head</li> </ul> <h4 id="1-preprocessing-layer">1. Preprocessing layer</h4> <p>This layer processes the node features using 2 <code class="language-plaintext highlighter-rouge">Linear</code> layers. Or one can just use <a href="https://pytorch.org/docs/stable/generated/torch.nn.Embedding.html" rel="external nofollow noopener" target="_blank"><code class="language-plaintext highlighter-rouge">torch.nn.Embedding</code></a> layer, if the node features are one-hot or discrete.</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td> <td class="code"><pre><span class="k">class</span> <span class="nc">Pre</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span> 
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">in_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">):</span> 
        <span class="nf">super</span><span class="p">(</span><span class="n">Pre</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">__init__</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">in_dim</span> <span class="o">=</span> <span class="n">in_dim</span>
        <span class="n">self</span><span class="p">.</span><span class="n">hidden_dim</span> <span class="o">=</span> <span class="n">hidden_dim</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">layers</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="nc">ModuleList</span><span class="p">([</span><span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="nc">Linear</span><span class="p">(</span><span class="n">in_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">),</span>
                                          <span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="nc">SiLU</span><span class="p">(),</span> 
                                          <span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="nc">Linear</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">)])</span>
    
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span> 
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">layers</span><span class="p">:</span> <span class="n">x</span> <span class="o">=</span> <span class="nf">layer</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>
</pre></td> </tr></tbody></table></code></pre></figure> <h4 id="2-message-passing-layers">2. Message Passing Layers</h4> <p>This is the message passing operation by the simplest <code class="language-plaintext highlighter-rouge">GCNConv</code> graph convolution layer.</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td> <td class="code"><pre><span class="k">class</span> <span class="nc">GNN</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span> 
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">,</span> <span class="n">hops</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        
        <span class="nf">super</span><span class="p">(</span><span class="n">GNN</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">__init__</span><span class="p">()</span>
        <span class="c1"># self.in_dim = in_dim
</span>        <span class="n">self</span><span class="p">.</span><span class="n">hidden_dim</span> <span class="o">=</span> <span class="n">hidden_dim</span>
        <span class="n">self</span><span class="p">.</span><span class="n">hops</span> <span class="o">=</span> <span class="n">hops</span>
        
        <span class="n">gnn_layers</span><span class="p">,</span> <span class="n">bn_layers</span><span class="p">,</span> <span class="n">act_layers</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        
        <span class="k">for</span> <span class="n">__</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">hops</span><span class="p">):</span> 
            <span class="n">gnn_layers</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="nc">GCNConv</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">,</span> <span class="n">add_self_loops</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
            <span class="n">bn_layers</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="nc">BatchNorm1d</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">))</span>
            <span class="n">act_layers</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="nc">Sigmoid</span><span class="p">())</span>
        
        
        <span class="n">self</span><span class="p">.</span><span class="n">gnn_layers</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="nc">ModuleList</span><span class="p">(</span><span class="n">gnn_layers</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">bn_layers</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="nc">ModuleList</span><span class="p">(</span><span class="n">bn_layers</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">act_layers</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="nc">ModuleList</span><span class="p">(</span><span class="n">act_layers</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">):</span> 
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">hops</span><span class="p">):</span> <span class="n">x</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">bn_layers</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">self</span><span class="p">.</span><span class="n">act_layers</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">self</span><span class="p">.</span><span class="n">gnn_layers</span><span class="p">[</span><span class="n">i</span><span class="p">](</span><span class="n">x</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">x</span>
</pre></td> </tr></tbody></table></code></pre></figure> <h4 id="3-local-neighborhood-aggregation">3. Local Neighborhood Aggregation</h4> <p>This might be tricky because given different mutation position, the focused neighborhood changes and indexed by <code class="language-plaintext highlighter-rouge">neighbor_idx</code>. The <code class="language-plaintext highlighter-rouge">GFocus</code> data class has this <code class="language-plaintext highlighter-rouge">focus</code> index and is colleated following minibatches of the graphs.</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre></td> <td class="code"><pre><span class="c1"># get focus
</span><span class="k">def</span> <span class="nf">get_focus</span><span class="p">(</span><span class="n">edge_index</span><span class="p">,</span> <span class="n">focus</span><span class="p">,</span> <span class="n">hop</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">focus</span><span class="p">.</span><span class="nf">clone</span><span class="p">()</span>
    <span class="n">row</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="n">edge_index</span>
    <span class="k">for</span> <span class="n">__</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">hop</span><span class="p">):</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">cat</span><span class="p">([</span><span class="n">idx</span><span class="p">,</span> <span class="n">col</span><span class="p">[</span><span class="n">torch</span><span class="p">.</span><span class="nf">isin</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">idx</span><span class="p">)],</span> <span class="n">row</span><span class="p">[</span><span class="n">torch</span><span class="p">.</span><span class="nf">isin</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">idx</span><span class="p">)]],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">idx</span><span class="p">.</span><span class="nf">unique</span><span class="p">().</span><span class="nf">to</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="nb">long</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">NeighborHood</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span> 
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">,</span> <span class="n">out_dim</span><span class="p">,</span> <span class="n">aggr</span><span class="o">=</span><span class="sh">'</span><span class="s">sum</span><span class="sh">'</span><span class="p">,</span> <span class="n">hop</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span> 
        <span class="nf">super</span><span class="p">(</span><span class="n">NeighborHood</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">__init__</span><span class="p">()</span>
        
        <span class="k">assert</span> <span class="n">aggr</span> <span class="ow">in</span> <span class="p">[</span><span class="sh">'</span><span class="s">mean</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">sum</span><span class="sh">'</span><span class="p">]</span>
        <span class="n">self</span><span class="p">.</span><span class="n">hidden_dim</span> <span class="o">=</span> <span class="n">hidden_dim</span>
        <span class="n">self</span><span class="p">.</span><span class="n">out_dim</span> <span class="o">=</span> <span class="n">out_dim</span>
        <span class="n">self</span><span class="p">.</span><span class="n">aggr</span> <span class="o">=</span> <span class="n">aggr</span>
        <span class="n">self</span><span class="p">.</span><span class="n">hop</span> <span class="o">=</span> <span class="n">hop</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">phi</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="nc">Linear</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">act_phi</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="nc">SiLU</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">bn_phi</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="nc">BatchNorm1d</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">)</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">psi</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="nc">Linear</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">out_dim</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">act_psi</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="nc">SiLU</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">,</span> <span class="n">focus</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span> 
        
        <span class="n">neighbor_idx</span> <span class="o">=</span> <span class="nf">get_focus</span><span class="p">(</span><span class="n">edge_index</span><span class="p">,</span> <span class="n">focus</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">bn_phi</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">act_phi</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">phi</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">neighbor_idx</span><span class="p">])))</span>

        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">aggr</span> <span class="o">==</span> <span class="sh">'</span><span class="s">mean</span><span class="sh">'</span><span class="p">:</span> <span class="n">message</span> <span class="o">=</span> <span class="nf">scatter_mean</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">batch</span><span class="p">[</span><span class="n">neighbor_idx</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">self</span><span class="p">.</span><span class="n">aggr</span> <span class="o">==</span> <span class="sh">'</span><span class="s">sum</span><span class="sh">'</span><span class="p">:</span> <span class="n">message</span> <span class="o">=</span> <span class="nf">scatter_sum</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">batch</span><span class="p">[</span><span class="n">neighbor_idx</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="nc">NotImplementedError</span><span class="p">()</span>
        
        <span class="n">out</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">act_psi</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="nf">psi</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">out</span>
</pre></td> </tr></tbody></table></code></pre></figure> <h4 id="4-regression-head">4. Regression Head:</h4> <p>This is nothing but a prediction head from the embeddings of the focused neighborhood.</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td> <td class="code"><pre><span class="k">class</span> <span class="nc">RegressionHead</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span> 
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">):</span> 
        <span class="nf">super</span><span class="p">(</span><span class="n">RegressionHead</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">__init__</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">hidden_dim</span> <span class="o">=</span> <span class="n">hidden_dim</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">layers</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="nc">ModuleList</span><span class="p">([</span><span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="nc">Linear</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">),</span> 
                                           <span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="nc">SiLU</span><span class="p">(),</span>
                                           <span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="nc">Linear</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="mi">1</span><span class="p">)])</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span> 
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">self</span><span class="p">.</span><span class="n">layers</span><span class="p">:</span> <span class="n">x</span> <span class="o">=</span> <span class="nf">layer</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">.</span><span class="nf">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</pre></td> </tr></tbody></table></code></pre></figure> <h4 id="5-full-model-and-loss">5. Full Model and Loss</h4> <p>The full model <code class="language-plaintext highlighter-rouge">StabilityGNN</code> is now:</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td> <td class="code"><pre><span class="c1"># full model
</span><span class="k">class</span> <span class="nc">StabilityGNN</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span> 
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">in_dim</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">out_dim</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">hops</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span> 
        
        <span class="nf">super</span><span class="p">(</span><span class="n">StabilityGNN</span><span class="p">,</span> <span class="n">self</span><span class="p">).</span><span class="nf">__init__</span><span class="p">()</span>
        <span class="n">self</span><span class="p">.</span><span class="n">in_dim</span> <span class="o">=</span> <span class="n">in_dim</span>
        <span class="n">self</span><span class="p">.</span><span class="n">hidden_dim</span> <span class="o">=</span> <span class="n">hidden_dim</span>
        <span class="n">self</span><span class="p">.</span><span class="n">out_dim</span> <span class="o">=</span> <span class="n">out_dim</span>
        <span class="n">self</span><span class="p">.</span><span class="n">hops</span> <span class="o">=</span> <span class="n">hops</span>
        
        <span class="n">self</span><span class="p">.</span><span class="n">pre</span> <span class="o">=</span> <span class="nc">Pre</span><span class="p">(</span><span class="n">in_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">gnn</span> <span class="o">=</span> <span class="nc">GNN</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">nh</span> <span class="o">=</span> <span class="nc">NeighborHood</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">out_dim</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">head</span> <span class="o">=</span> <span class="nc">RegressionHead</span><span class="p">(</span><span class="n">out_dim</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">,</span> <span class="n">focus</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span> 
        
        <span class="n">processed_x</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">pre</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">node_embeds</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">gnn</span><span class="p">(</span><span class="n">processed_x</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">)</span>
        <span class="n">focus_embeds</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="nf">nh</span><span class="p">(</span><span class="n">node_embeds</span><span class="p">,</span> <span class="n">edge_index</span><span class="p">,</span> <span class="n">focus</span><span class="p">,</span> <span class="n">batch</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">focus_embeds</span><span class="p">,</span> <span class="n">self</span><span class="p">.</span><span class="nf">head</span><span class="p">(</span><span class="n">focus_embeds</span><span class="p">)</span>
</pre></td> </tr></tbody></table></code></pre></figure> <p>Since this is a regression task, I used the <code class="language-plaintext highlighter-rouge">MSELoss</code></p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
</pre></td> <td class="code"><pre><span class="n">loss</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="nc">MSELoss</span><span class="p">()</span>
</pre></td> </tr></tbody></table></code></pre></figure> <p>Now Let’s test the functionalities of these layers and their inputs and outputs.</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td> <td class="code"><pre><span class="c1"># testing the functionalities of the layers
</span>
<span class="c1"># Pre
</span><span class="n">pre</span> <span class="o">=</span> <span class="nc">Pre</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
<span class="n">processed_x</span> <span class="o">=</span> <span class="nf">pre</span><span class="p">(</span><span class="n">batch</span><span class="p">.</span><span class="n">x</span><span class="p">)</span>

<span class="c1"># GNN
</span><span class="n">gnn</span> <span class="o">=</span> <span class="nc">GNN</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="nf">gnn</span><span class="p">(</span><span class="n">processed_x</span><span class="p">,</span> <span class="n">batch</span><span class="p">.</span><span class="n">edge_index</span><span class="p">)</span>

<span class="c1"># Neighborhood
</span><span class="n">nh</span> <span class="o">=</span> <span class="nc">NeighborHood</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>
<span class="n">out</span> <span class="o">=</span> <span class="nf">nh</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">batch</span><span class="p">.</span><span class="n">edge_index</span><span class="p">,</span> <span class="n">batch</span><span class="p">.</span><span class="n">focus</span><span class="p">,</span> <span class="n">batch</span><span class="p">.</span><span class="n">x_batch</span><span class="p">)</span>

<span class="c1"># RegressionHead
</span><span class="n">rh</span> <span class="o">=</span> <span class="nc">RegressionHead</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span>
<span class="n">pred</span> <span class="o">=</span> <span class="nf">rh</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</pre></td> </tr></tbody></table></code></pre></figure> <figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td> <td class="code"><pre><span class="c1"># testing the whole model
</span>
<span class="n">sgnn</span> <span class="o">=</span> <span class="nc">StabilityGNN</span><span class="p">()</span>
<span class="n">focus_embeds</span><span class="p">,</span> <span class="n">pred</span> <span class="o">=</span> <span class="nf">sgnn</span><span class="p">(</span><span class="n">batch</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">batch</span><span class="p">.</span><span class="n">edge_index</span><span class="p">,</span> <span class="n">batch</span><span class="p">.</span><span class="n">focus</span><span class="p">,</span> <span class="n">batch</span><span class="p">.</span><span class="n">x_batch</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">focus_embeds</span><span class="p">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">pred</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">32</span>
</pre></td> </tr></tbody></table></code></pre></figure> <h3 id="4-training">4. Training</h3> <p>Training the neighborhood embeddings to fit the dG locally on cpu… Took ~5 min for training with 800 (tiny) mutated graphs.</p> <p>I was training this small example on CPU. If one wants to train on GPU, just <code class="language-plaintext highlighter-rouge">.to('cuda')</code></p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td> <td class="code"><pre><span class="c1"># using naive model
</span><span class="n">stability_gnn</span> <span class="o">=</span> <span class="nc">StabilityGNN</span><span class="p">()</span>
<span class="n">mse_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="nc">MSELoss</span><span class="p">()</span>
<span class="n">l1_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="nc">L1Loss</span><span class="p">()</span>


<span class="n">nepochs</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">lr</span><span class="p">,</span> <span class="n">wd</span> <span class="o">=</span> <span class="mf">1e-4</span><span class="p">,</span> <span class="mf">1e-3</span>
<span class="n">loss_type</span> <span class="o">=</span> <span class="sh">'</span><span class="s">L2</span><span class="sh">'</span>
<span class="n">log_every</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">floor</span><span class="p">(</span><span class="n">nepochs</span> <span class="o">/</span> <span class="mi">20</span><span class="p">))</span>


<span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">optim</span><span class="p">.</span><span class="nc">AdamW</span><span class="p">(</span><span class="n">stability_gnn</span><span class="p">.</span><span class="nf">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="n">wd</span><span class="p">)</span>

<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nf">tqdm</span><span class="p">(</span><span class="nf">range</span><span class="p">(</span><span class="n">nepochs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="sh">'</span><span class="s">Training Stability GNN</span><span class="sh">'</span><span class="p">):</span> 
    
    <span class="n">losses</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">dataloader</span><span class="p">:</span> 
        
        <span class="n">optimizer</span><span class="p">.</span><span class="nf">zero_grad</span><span class="p">()</span>
        <span class="n">__</span><span class="p">,</span> <span class="n">pred</span> <span class="o">=</span> <span class="nf">stability_gnn</span><span class="p">(</span><span class="n">batch</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">batch</span><span class="p">.</span><span class="n">edge_index</span><span class="p">,</span> <span class="n">batch</span><span class="p">.</span><span class="n">focus</span><span class="p">,</span> <span class="n">batch</span><span class="p">.</span><span class="n">x_batch</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="nf">mse_loss</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">batch</span><span class="p">.</span><span class="n">y</span><span class="p">.</span><span class="nf">to</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="nb">float</span><span class="p">))</span> <span class="k">if</span> <span class="n">loss_type</span> <span class="o">==</span> <span class="sh">'</span><span class="s">L2</span><span class="sh">'</span> <span class="k">else</span> <span class="nf">l1_loss</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">batch</span><span class="p">.</span><span class="n">y</span><span class="p">.</span><span class="nf">to</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="nb">float</span><span class="p">))</span>
        
        <span class="n">loss</span><span class="p">.</span><span class="nf">backward</span><span class="p">()</span>
        <span class="n">optimizer</span><span class="p">.</span><span class="nf">step</span><span class="p">()</span>
        <span class="n">losses</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">loss</span><span class="p">.</span><span class="nf">item</span><span class="p">())</span>
    
    <span class="n">avg_loss</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">losses</span><span class="p">).</span><span class="nf">mean</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="n">epoch</span> <span class="o">%</span> <span class="n">log_every</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">'</span><span class="s">-- Epoch = </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s">, MSE-Loss = </span><span class="si">{</span><span class="n">avg_loss</span><span class="si">}</span><span class="sh">'</span><span class="p">)</span>
</pre></td> </tr></tbody></table></code></pre></figure> <p>Output:</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="o">--</span> <span class="n">Epoch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MSE</span><span class="o">-</span><span class="n">Loss</span> <span class="o">=</span> <span class="mf">5.007125299710494</span>
<span class="o">--</span> <span class="n">Epoch</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span> <span class="n">MSE</span><span class="o">-</span><span class="n">Loss</span> <span class="o">=</span> <span class="mf">0.3031598604642428</span>
<span class="o">--</span> <span class="n">Epoch</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">MSE</span><span class="o">-</span><span class="n">Loss</span> <span class="o">=</span> <span class="mf">0.22531221978939497</span>
<span class="o">--</span> <span class="n">Epoch</span> <span class="o">=</span> <span class="mi">150</span><span class="p">,</span> <span class="n">MSE</span><span class="o">-</span><span class="n">Loss</span> <span class="o">=</span> <span class="mf">0.1948822490297831</span>
<span class="o">--</span> <span class="n">Epoch</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span> <span class="n">MSE</span><span class="o">-</span><span class="n">Loss</span> <span class="o">=</span> <span class="mf">0.18019723892211914</span>
<span class="o">--</span> <span class="n">Epoch</span> <span class="o">=</span> <span class="mi">250</span><span class="p">,</span> <span class="n">MSE</span><span class="o">-</span><span class="n">Loss</span> <span class="o">=</span> <span class="mf">0.16349028222835982</span>
<span class="o">--</span> <span class="n">Epoch</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span> <span class="n">MSE</span><span class="o">-</span><span class="n">Loss</span> <span class="o">=</span> <span class="mf">0.16791437165095255</span>
<span class="o">--</span> <span class="n">Epoch</span> <span class="o">=</span> <span class="mi">350</span><span class="p">,</span> <span class="n">MSE</span><span class="o">-</span><span class="n">Loss</span> <span class="o">=</span> <span class="mf">0.14197989237996247</span>
<span class="o">--</span> <span class="n">Epoch</span> <span class="o">=</span> <span class="mi">400</span><span class="p">,</span> <span class="n">MSE</span><span class="o">-</span><span class="n">Loss</span> <span class="o">=</span> <span class="mf">0.16626639348956254</span>
<span class="o">--</span> <span class="n">Epoch</span> <span class="o">=</span> <span class="mi">450</span><span class="p">,</span> <span class="n">MSE</span><span class="o">-</span><span class="n">Loss</span> <span class="o">=</span> <span class="mf">0.13275881555791086</span>
<span class="o">--</span> <span class="n">Epoch</span> <span class="o">=</span> <span class="mi">500</span><span class="p">,</span> <span class="n">MSE</span><span class="o">-</span><span class="n">Loss</span> <span class="o">=</span> <span class="mf">0.14490264081037962</span>
<span class="o">--</span> <span class="n">Epoch</span> <span class="o">=</span> <span class="mi">550</span><span class="p">,</span> <span class="n">MSE</span><span class="o">-</span><span class="n">Loss</span> <span class="o">=</span> <span class="mf">0.11256958214709392</span>
<span class="o">--</span> <span class="n">Epoch</span> <span class="o">=</span> <span class="mi">600</span><span class="p">,</span> <span class="n">MSE</span><span class="o">-</span><span class="n">Loss</span> <span class="o">=</span> <span class="mf">0.13622687069269326</span>
<span class="o">--</span> <span class="n">Epoch</span> <span class="o">=</span> <span class="mi">650</span><span class="p">,</span> <span class="n">MSE</span><span class="o">-</span><span class="n">Loss</span> <span class="o">=</span> <span class="mf">0.10607394826813386</span>
<span class="o">--</span> <span class="n">Epoch</span> <span class="o">=</span> <span class="mi">700</span><span class="p">,</span> <span class="n">MSE</span><span class="o">-</span><span class="n">Loss</span> <span class="o">=</span> <span class="mf">0.11214157938957214</span>
<span class="o">--</span> <span class="n">Epoch</span> <span class="o">=</span> <span class="mi">750</span><span class="p">,</span> <span class="n">MSE</span><span class="o">-</span><span class="n">Loss</span> <span class="o">=</span> <span class="mf">0.103588092355774</span>
<span class="o">--</span> <span class="n">Epoch</span> <span class="o">=</span> <span class="mi">800</span><span class="p">,</span> <span class="n">MSE</span><span class="o">-</span><span class="n">Loss</span> <span class="o">=</span> <span class="mf">0.11125421910904922</span>
<span class="o">--</span> <span class="n">Epoch</span> <span class="o">=</span> <span class="mi">850</span><span class="p">,</span> <span class="n">MSE</span><span class="o">-</span><span class="n">Loss</span> <span class="o">=</span> <span class="mf">0.09300274430559231</span>
<span class="o">--</span> <span class="n">Epoch</span> <span class="o">=</span> <span class="mi">900</span><span class="p">,</span> <span class="n">MSE</span><span class="o">-</span><span class="n">Loss</span> <span class="o">=</span> <span class="mf">0.11821510571126755</span>
<span class="o">--</span> <span class="n">Epoch</span> <span class="o">=</span> <span class="mi">950</span><span class="p">,</span> <span class="n">MSE</span><span class="o">-</span><span class="n">Loss</span> <span class="o">=</span> <span class="mf">0.15214177851493543</span>
<span class="o">--</span> <span class="n">Epoch</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">MSE</span><span class="o">-</span><span class="n">Loss</span> <span class="o">=</span> <span class="mf">0.09064253620230235</span></code></pre></figure> <p>It seems like for these small singly mutated graphs, the model can learn the stability from local neighorhood embeddings. In another experiment, I was getting <code class="language-plaintext highlighter-rouge">&lt; 0.05</code> MSE loss. It might be interesting to test the trained model on an independent protein structures and see how it performs and if the neighborhood embeddings can be generalized.</p> <h3 id="5-final-note">5. Final Note</h3> <p>The StabilityGNN is just a naive model for this task with minimal inductive bias. I ran it serval times and I could get down to mse &lt; 0.1 in 1000 epochs just using one-hot.</p> <p>The model assumes identical conformation upon mutation, which is not always the case. That is why more complex structural modeling tools, such as Rosetta or Molecular Dynamics simulations were developed and used to model slight to drastic conformational changes.</p> <p>The <code class="language-plaintext highlighter-rouge">focus</code> only consider <code class="language-plaintext highlighter-rouge">k</code>-hop neighbor, if <code class="language-plaintext highlighter-rouge">k=0</code> it might just learn the PSSM of the position. If <code class="language-plaintext highlighter-rouge">k &gt; 2</code>, the neighborhood information might be over-smoothed and is hard to generalize. Moreover, there are some cases where allosterics is critical in protein stability; such long-range interaction might help in stabilizing the proteins and undermine the naive assumption of this GNN model.</p> <p>There can be multiple ways to improve / train the model, I’ll not reveal too much on that then..</p> <p>The complete notebook can be found <a href="https://github.com/jipq6175/StabilityGNN/blob/main/GNN-stability-snippet.ipynb" rel="external nofollow noopener" target="_blank">here</a>.</p> </article> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2025 Yen-Lin Chen. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a>. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Last updated: June 27, 2025. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js"></script> <script defer src="/assets/js/common.js"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>